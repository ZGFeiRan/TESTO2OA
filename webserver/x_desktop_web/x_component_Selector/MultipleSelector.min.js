MWF.xApplication.Selector=MWF.xApplication.Selector||{};MWF.xDesktop.requireApp("Selector","lp."+MWF.language,null,false);MWF.xApplication.Selector.MultipleSelector=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",types:[],count:0,title:"Select",groups:[],roles:[],units:[],values:[],zIndex:1e3,expand:true},initialize:function(t,e){this.setOptions(e);this.path="/x_component_Selector/$Selector/";this.cssPath="/x_component_Selector/$Selector/"+this.options.style+"/css.wcss";this._loadCss();this.container=$(t);this.lp=MWF.xApplication.Selector.LP;this.lastPeople="";this.pageCount="13";this.selectedItems=[];this.selectedItemsObject={};this.items=[];this.selectors={}},load:function(){if(layout.mobile){this.loadMobile()}else{this.loadPc()}this.fireEvent("load")},loadMobile:function(){this.container.mask({destroyOnHide:true,style:this.css.maskNode});this.node=new Element("div",{styles:this.css.containerNodeMobile});this.node.setStyle("z-index",this.options.zIndex.toInt()+1);this.node.setStyle("height",this.container.getSize().y-50+"px");this.titleNode=new Element("div",{styles:this.css.titleNodeMobile}).inject(this.node);this.titleCancelActionNode=new Element("div",{styles:this.css.titleCancelActionNodeMobile,text:MWF.SelectorLP.back}).inject(this.titleNode);this.titleOkActionNode=new Element("div",{styles:this.css.titleOkActionNodeMobile,text:MWF.SelectorLP.ok}).inject(this.titleNode);this.titleTextNode=new Element("div",{styles:{margin:"0px 50px",height:"40px",padding:"0px 10px",color:"#FFF","font-weight":"bold","font-size":"14px","line-height":"40px"}}).inject(this.titleNode);this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node);var t=this.container.getSize();var e=t.y-40;this.contentNode.setStyle("height",""+e+"px");this.contentNode.setStyle("margin-top","2px");this.loadContent();this.node.inject(this.container);this.node.setStyles({top:"0px",left:"0px"});this.setEvent()},loadPc:function(){this.css.maskNode["z-index"]=this.options.zIndex;this.container.mask({destroyOnHide:true,style:this.css.maskNode});this.node=new Element("div",{styles:this.options.count.toInt()==1?this.css.containerNodeSingle_multiple:this.css.containerNode_multiple});this.node.setStyle("z-index",this.options.zIndex.toInt()+1);this.titleNode=new Element("div",{styles:this.css.titleNode}).inject(this.node);this.titleActionNode=new Element("div",{styles:this.css.titleActionNode}).inject(this.titleNode);this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.options.title}).inject(this.titleNode);this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node);this.loadContent();this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.node);if(this.options.count.toInt()==1)this.actionNode.setStyle("text-align","center");this.loadAction();this.node.inject(this.container);this.node.position({relativeTo:this.container,position:"center",edge:"center"});var t=this.container.getSize();var e=this.node.getSize();this.node.makeDraggable({handle:this.titleNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]}});this.setEvent()},setEvent:function(){if(this.titleActionNode){this.titleActionNode.addEvent("click",function(){this.close()}.bind(this))}if(this.titleCancelActionNode){this.titleCancelActionNode.addEvent("click",function(){this.close()}.bind(this))}if(this.titleOkActionNode){this.titleOkActionNode.addEvent("click",function(){this.fireEvent("complete",[this.getSelectedItems(),this.getSelectedItemsObject()]);this.close()}.bind(this))}},close:function(){this.fireEvent("close");this.node.destroy();this.container.unmask();MWF.release(this);delete this},loadAction:function(){this.okActionNode=new Element("button",{styles:this.css.okActionNode,text:"确　定"}).inject(this.actionNode);this.cancelActionNode=new Element("button",{styles:this.css.cancelActionNode,text:"取 消"}).inject(this.actionNode);this.okActionNode.addEvent("click",function(){this.fireEvent("complete",[this.getSelectedItems(),this.getSelectedItemsObject()]);this.close()}.bind(this));this.cancelActionNode.addEvent("click",function(){this.fireEvent("cancel");this.close()}.bind(this))},loadContent:function(){if(layout.mobile){MWF.require("MWF.widget.Tab",function(){this.tab=new MWF.widget.Tab(this.titleTextNode,{style:"orgMobile"});this.tab.load();this.tab.contentNodeContainer.inject(this.contentNode)}.bind(this),false)}else{MWF.require("MWF.widget.Tab",function(){this.tab=new MWF.widget.Tab(this.contentNode,{style:"default"});this.tab.load()}.bind(this),false)}debugger;this.options.types.each(function(l,c){var h=new Element("div").inject(this.contentNode);var d=this.tab.addTab(h,this.lp[l],false);var a=l.capitalize();if(l.toLowerCase()==="unit"&&this.options.unitType){a="UnitWithType"}if(l.toLowerCase()==="identity"&&(this.options.dutys&&this.options.dutys.length)){a="IdentityWidthDuty"}MWF.xDesktop.requireApp("Selector",a,function(){var t=Object.clone(this.options);t.values=this.getValueByType(this.options.values,l);this.selectors[a]=new MWF.xApplication.Selector[a](this.container,t);this.selectors[a].loadContent(h);if(layout.mobile){var e=this.container.getSize();var i=e.y-40-20-6-20;if(this.selectors[a].selectNode){this.selectors[a].selectNode.setStyle("height",""+i+"px")}i=e.y-40-20-78-20;var s=this.selectors[a].itemAreaScrollNode;if(s){s.setStyle("height",""+i+"px")}if(a.toLowerCase()=="person"||a.toLowerCase()=="group"){var n=0,o=0;s.addEvents({touchstart:function(t){var e=t.touches[0];n=Number(e.pageY)}.bind(this),touchmove:function(t){var e=t.touches[0];o=Number(e.pageY)}.bind(this),touchend:function(t){if(n-o>10){var e=this.selectors.Person;e._scrollEvent(e.itemAreaScrollNode.scrollTop+100)}n=0;o=0}.bind(this)})}}if(c==0)d.showIm()}.bind(this))}.bind(this))},getValueByType:function(t,s){var n=[];t=typeOf(t=="array")?t:[t];t.each(function(t){if(typeOf(t)=="string"){var e=t}else{var e=t.distinguishedName}if(e&&s){var i=e.substr(e.length-1,1);switch(i.toLowerCase()){case"i":if(s=="identity")n.push(t);break;case"p":if(s=="person")n.push(t);break;case"u":if(s=="unit")n.push(t);break;case"g":if(s=="group")n.push(t);break;case"r":if(s=="role")n.push(t);break;default:if(s=="person")n.push(t);break}}else{}});return n},getSelectedItems:function(){this.selectedItems=[];for(var t in this.selectors){var e=this.selectors[t];if(e.selectedItems&&e.selectedItems.length>0){this.selectedItems=this.selectedItems.concat(e.selectedItems)}}return this.selectedItems},getSelectedItemsObject:function(){this.selectedItemsObject={};for(var t in this.selectors){var e=this.selectors[t];if(e.selectedItems&&e.selectedItems.length>0){this.selectedItemsObject[t.toLowerCase()]=e.selectedItems}}return this.selectedItemsObject}});MWF.xApplication.Selector.MultipleSelector.Filter=new Class({Implements:[Options,Events],options:{types:[],groups:[],roles:[],units:[]},initialize:function(t,s){this.setOptions(s);this.value=t;this.orgAction=MWF.Actions.get("x_organization_assemble_control");this.selectors={};this.options.types.each(function(t,e){var i=t.capitalize();if(t.toLowerCase()==="unit"&&this.options.unitType){i="UnitWithType"}if(t.toLowerCase()==="identity"&&(this.options.dutys&&this.options.dutys.length)){i="IdentityWidthDuty"}MWF.xDesktop.requireApp("Selector",i,function(){this.selectors[i]=new MWF.xApplication.Selector[i].Filter(this.value,s)}.bind(this),false)}.bind(this))},filter:function(t,e){this.value=t;var s=this.value;this.filterData=[];this.filterCount=0;debugger;for(i in this.selectors){this.selectors[i].filter(t,function(t){this.filterData=this.filterData.concat(t);this.filterCount++;this.endFilter(e)}.bind(this))}},endFilter:function(t){if(this.filterCount>=Object.keys(this.selectors).length){if(t)t(this.filterData)}}});