MWF.xApplication.portal.PageDesigner.Module=MWF.xApplication.portal.PageDesigner.Module||{};MWF.require("MWF.widget.Common",null,false);MWF.xApplication.portal.PageDesigner.Module.Page=MWF.PCPage=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",propertyPath:"/x_component_portal_PageDesigner/Module/Page/page.html",mode:"PC",fields:["Calendar","Checkbox","Datagrid","Datagrid$Title","Datagrid$Data","Htmleditor","Number","Office","Orgfield","Personfield","Radio","Select","Textarea","Textfield"]},initializeBase:function(e){this.setOptions(e);this.path="/x_component_portal_PageDesigner/Module/Page/";this.cssPath="/x_component_portal_PageDesigner/Module/Page/"+this.options.style+"/css.wcss";this._loadCss()},initialize:function(e,t,i){this.initializeBase(i);this.container=null;this.page=this;this.form=this;this.moduleType="page";this.moduleList=[];this.moduleNodeList=[];this.moduleContainerNodeList=[];this.moduleElementNodeList=[];this.moduleComponentNodeList=[];this.dataTemplate={};this.designer=e;this.container=t;this.selectedModules=[]},load:function(e){this.data=e;this.json=e.json;this.html=e.html;this.json.mode=this.options.mode;this.isNewPage=this.json.id?false:true;if(this.isNewPage)this.checkUUID();if(this.designer.application)this.data.json.applicationName=this.designer.application.name;if(this.designer.application)this.data.json.application=this.designer.application.id;this.container.set("html",this.html);this.loadStylesList(function(){var e="";if(!this.json.pageStyleType||!this.stylesList[this.json.pageStyleType])this.json.pageStyleType="blue-simple";if(this.options.mode=="Mobile"){if(this.json.pageStyleType!="defaultMobile"){e=this.json.pageStyleType;this.json.pageStyleType="defaultMobile"}}this.templateStyles=this.stylesList&&this.json.pageStyleType?this.stylesList[this.json.pageStyleType]:null;this.loadDomModules();if(this.json.pageStyleType){if(this.stylesList[this.json.pageStyleType]){if(this.stylesList[this.json.pageStyleType]["page"]){this.setTemplateStyles(this.stylesList[this.json.pageStyleType]["page"])}}}this.setCustomStyles();this.node.setProperties(this.json.properties);this.setNodeEvents();if(this.options.mode=="Mobile"){if(e)this._setEditStyle("pageStyleType",null,e)}this.selected();this.autoSave();this.designer.addEvent("queryClose",function(){if(this.autoSaveTimerID)window.clearInterval(this.autoSaveTimerID)}.bind(this))}.bind(this))},removeStyles:function(e,i){if(this.json[i]){Object.each(e,function(e,t){if(this.json[i][t]&&this.json[i][t]==e){delete this.json[i][t]}}.bind(this))}},copyStyles:function(e,i){if(!this.json[i])this.json[i]={};Object.each(e,function(e,t){if(!this.json[i][t])this.json[i][t]=e}.bind(this))},clearTemplateStyles:function(e){if(e){if(e.styles)this.removeStyles(e.styles,"styles");if(e.properties)this.removeStyles(e.properties,"properties")}},setTemplateStyles:function(e){if(e.styles)this.copyStyles(e.styles,"styles");if(e.properties)this.copyStyles(e.properties,"properties")},loadStylesList:function(t){var e="/x_component_portal_PageDesigner/Module/Page/template/"+(this.options.mode=="Mobile"?"styles":"styles")+".json";MWF.getJSON(e,{onSuccess:function(e){this.stylesList=e;if(t)t(this.stylesList)}.bind(this),onRequestFailure:function(){this.stylesList={};if(t)t(this.stylesList)}.bind(this),onError:function(){this.stylesList={};if(t)t(this.stylesList)}.bind(this)})},autoSave:function(){this.autoSaveCheckNode=this.designer.pageToolbarNode.getElement("#MWFPageAutoSaveCheck");if(this.autoSaveCheckNode){this.autoSaveTimerID=window.setInterval(function(){if(this.autoSaveCheckNode.get("checked")){this.save()}}.bind(this),6e4)}},checkUUID:function(){this.designer.actions.getUUID(function(e){this.json.id=e}.bind(this))},loadDomModules:function(){this.node=this.container.getFirst();this.node.set("id",this.json.id);this.node.setStyles(this.css.pageNode);this.node.store("module",this);var e=this.container.getSize().y-2;this.node.setStyle("min-height",""+e+"px");this.designer.addEvent("resize",function(){var e=this.container.getSize().y-2;this.node.setStyle("min-height",""+e+"px")}.bind(this));this.loadDomTree()},loadDomTree:function(){MWF.require("MWF.widget.Tree",function(){this.domTree=new MWF.widget.Tree(this.designer.propertyDomArea,{style:"domtree"});this.domTree.load();this.createPageTreeNode();this.parseModules(this,this.node)}.bind(this))},createPageTreeNode:function(){var e={expand:true,title:this.json.id,text:"<"+this.json.type+"> "+this.json.name+" ["+this.options.mode+"] ",icon:this.options.mode=="Mobile"?"mobile.png":"pc.png"};e.action=function(){if(this.module)this.module.selected()};this.treeNode=this.domTree.appendChild(e);this.treeNode.module=this},parseModules:function(e,t){var i=null;var s=t.getFirst();while(s){if(s.get("MWFtype")){var o=this.getDomjson(s);if(o)module=this.loadModule(o,s,e)}if(!o)i=s;s=s.getNext();if(i){i.destroy();i=null}}},getDomjson:function(e){var t=e.get("MWFtype");switch(t){case"page":return this.json;case"":return null;default:var i=e.get("id");if(i){return this.json.moduleList[i]}else{return null}}},loadModule:function(e,t,i){if(e){var s=new MWF["PC"+e.type](this);s.load(e,t,i);return s}},setNodeEvents:function(){this.node.addEvent("click",function(e){this.selected()}.bind(this))},createModule:function(s,o){this.getTemplateData(s,function(e){var t=Object.clone(e);var i=new MWF["PC"+s](this);i.create(t,o)}.bind(this))},getTemplateData:function(i,s){if(this.dataTemplate[i]){if(s)s(this.dataTemplate[i])}else{var e="/x_component_portal_PageDesigner/Module/"+i+"/template.json";MWF.getJSON(e,function(e,t){this.dataTemplate[i]=e;if(s)s(e)}.bind(this))}},selected:function(){if(this.currentSelectedModule){if(this.currentSelectedModule==this){return true}else{this.currentSelectedModule.unSelected()}}if(this.propertyMultiTd){this.propertyMultiTd.hide();this.propertyMultiTd=null}this.unSelectedMulti();this.currentSelectedModule=this;if(this.treeNode){this.treeNode.selectNode()}this.showProperty()},unSelectedMulti:function(){while(this.selectedModules.length){this.selectedModules[0].unSelectedMulti()}if(this.multimoduleActionsArea)this.multimoduleActionsArea.setStyle("display","none")},unSelectAll:function(){},_beginSelectMulti:function(){if(this.currentSelectedModule)this.currentSelectedModule.unSelected();this.unSelectedMulti();this.noSelected=true},_completeSelectMulti:function(){if(this.selectedModules.length<2){this.selectedModules[0].selected()}else{this._showMultiActions()}},createMultimoduleActionsArea:function(){this.multimoduleActionsArea=new Element("div",{styles:{display:"none",position:"absolute","background-color":"#F1F1F1",padding:"1px","padding-right":"0px",border:"1px solid #AAA","box-shadow":"0px 2px 5px #999","z-index":10001}}).inject(this.page.container,"after")},_showMultiActions:function(){if(!this.multimoduleActionsArea)this.createMultimoduleActionsArea();var e=this._getFirstMultiSelectedModule();if(e){var t=e.position.y-25;var i=e.position.x;this.multimoduleActionsArea.setPosition({x:i,y:t});this.multimoduleActionsArea.setStyle("display","block")}},_getFirstMultiSelectedModule:function(){var i=null;this.selectedModules.each(function(e){var t=e.node.getPosition(e.page.node.getOffsetParent());if(!i){i={module:e,position:t}}else{if(t.y<i.position.y){i={module:e,position:t}}else if(t.y==i.position.y){if(t.x<i.position.x){i={module:e,position:t}}}}});return i},showProperty:function(){if(!this.property){this.property=new MWF.xApplication.process.FormDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)});this.property.load()}else{this.property.show()}},hideProperty:function(){if(this.property)this.property.hide()},unSelected:function(){this.currentSelectedModule=null;this.hideProperty()},_dragIn:function(e){if(!this.Component)e.inContainer=this;e.parentContainer=this;this.node.setStyles({border:"1px solid #ffa200"});var t=e._getCopyNode();t.inject(this.node)},_dragOut:function(e){e.inContainer=null;e.parentContainer=null;this.node.setStyles(this.css.pageNode);this.node.setStyles(this.json.styles);var t=e._getCopyNode();t.setStyle("display","none")},_dragDrop:function(e){this.node.setStyles(this.css.pageNode);this.node.setStyles(this.json.styles)},_clearNoId:function(e){var t=e.getFirst();while(t){var i=t.getNext();if(t.get("MWFType")){if(!t.get("id")){t.destroy()}else{if(t)this._clearNoId(t)}}else{if(t)this._clearNoId(t)}t=i}},_getPageData:function(){var e=this.node.clone(true,true);e.clearStyles(true);this._clearNoId(e);var t=e.outerHTML;e.destroy();this.data.json.mode=this.options.mode;this.data.html=t;return this.data},preview:function(){MWF.xDesktop.requireApp("process.FormDesigner","Preview",function(){if(this.options.mode=="Mobile"){this.previewBox=new MWF.xApplication.process.FormDesigner.Preview(this,{size:{x:"340",y:580,layout:"mobile"}})}else{this.previewBox=new MWF.xApplication.process.FormDesigner.Preview(this)}this.previewBox.load()}.bind(this))},save:function(e){this.designer.savePage()},explode:function(){this._getPageData();MWF.require("MWF.widget.Base64",null,false);var e=MWF.widget.Base64.encode(JSON.encode(this.data));MWF.require("MWF.widget.Panel",function(){var e=new Element("div");var t=this.designer.pageNode.getSize();var i=this.designer.pageNode.getPosition(this.designer.pageNode.getOffsetParent());var s=new Element("textarea",{styles:{border:"1px solid #999",width:"770px","margin-left":"14px","margin-top":"14px",height:"580px"},text:JSON.encode(this.data)}).inject(e);this.explodePanel=new MWF.widget.Panel(e,{style:"page",isResize:false,isMax:false,title:"",width:800,height:660,top:i.y,left:i.x+3,isExpand:false,target:this.designer.node});this.explodePanel.load()}.bind(this))},setPropertiesOrStyles:function(e){if(e=="styles"){this.setCustomStyles()}if(e=="properties"){this.node.setProperties(this.json.properties)}},setCustomStyles:function(){var e=this.node.getStyle("border");this.node.clearStyles();this.node.setStyles(this.css.pageNode);var t=this.container.getSize().y-2;this.node.setStyle("min-height",""+t+"px");if(this.initialStyles)this.node.setStyles(this.initialStyles);this.node.setStyle("border",e);Object.each(this.json.styles,function(e,t){var i=/^border\w*/gi;if(!t.test(i)){this.node.setStyle(t,e)}}.bind(this))},_setEditStyle:function(e,t,i){if(e=="name"){var s=this.json.name||this.json.id;this.treeNode.setText("<"+this.json.type+"> "+s)}if(e=="id"){if(!this.json.name)this.treeNode.setText("<"+this.json.type+"> "+this.json.id);this.treeNode.setTitle(this.json.id);this.node.set("id",this.json.id)}if(e=="pageStyleType"){debugger;this.templateStyles=this.stylesList&&this.json.pageStyleType?this.stylesList[this.json.pageStyleType]:null;if(i){var o=this.stylesList[i];if(o){if(o["page"])this.clearTemplateStyles(o["page"])}}if(this.templateStyles){if(this.templateStyles["page"])this.setTemplateStyles(this.templateStyles["page"])}this.setAllStyles();this.moduleList.each(function(e){if(o){e.clearTemplateStyles(o[e.moduleName])}e.setStyleTemplate();e.setAllStyles()}.bind(this))}this._setEditStyle_custom(e,t,i)},setAllStyles:function(){this.setPropertiesOrStyles("styles");this.setPropertiesOrStyles("properties");this.reloadMaplist()},reloadMaplist:function(){if(this.property)Object.each(this.property.maplists,function(e,t){e.reload(this.json[t])}.bind(this))},_setEditStyle_custom:function(){},saveAsTemplete:function(){},checkModuleId:function(e,t,i){var s=false;var o=false;if(this.json.moduleList[e]){o=true;if(this.options.fields.indexOf(t)!=-1||this.options.fields.indexOf(this.json.moduleList[e].type)!=-1){s=true}return{fieldConflict:s,elementConflict:o}}return{fieldConflict:s,elementConflict:o}}});