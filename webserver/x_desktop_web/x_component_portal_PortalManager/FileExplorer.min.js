MWF.xDesktop.requireApp("process.ProcessManager","FileExplorer",null,false);MWF.xApplication.portal.PortalManager.FileExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.FileExplorer,Implements:[Options,Events],options:{create:MWF.APPPM.LP.file.create,search:MWF.APPPM.LP.file.search,searchText:MWF.APPPM.LP.file.searchText,noElement:MWF.APPPM.LP.file.noDictionaryNoticeText},_createElement:function(e){new MWF.xApplication.portal.PortalManager.FileDesigner(this)},_getItemObject:function(e){return new MWF.xApplication.portal.PortalManager.FileExplorer.File(this,e)}});MWF.xApplication.portal.PortalManager.FileExplorer.File=new Class({Extends:MWF.xApplication.process.ProcessManager.FileExplorer.File,_open:function(e){var t=this;MWF.Actions.get("x_portal_assemble_designer").getFile(this.data.id,function(e){this.data=e.data;new MWF.xApplication.portal.PortalManager.FileDesigner(this.explorer,this.data)}.bind(this))},_getIcon:function(){return"file.png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/fileIcon/lnk.png",title:this.data.name,par:'portal.FileDesigner#{"id": "'+this.data.id+'", "applicationId": "'+this.explorer.app.options.application.id+'"}'}},deleteFile:function(e){this.explorer.app.restActions.deleteFile(this.data.id,function(){this.node.destroy();if(e)e()}.bind(this))}});MWF.xApplication.portal.PortalManager.FileDesigner=new Class({Extends:MWF.xApplication.process.ProcessManager.FileDesigner,getNewData:function(){return{id:"",name:"",alias:"",description:"",portal:(this.explorer.app.options.application||this.explorer.app.application).id,fileName:""}},createContentFileUrl:function(){if(this.data.fileName){var e=new Element("div",{styles:this.css.fileDesignerContentLineNode}).inject(this.contentAreaNode);var t=new Element("div",{styles:this.css.fileDesignerContentLineTitleNode,text:"URL"}).inject(e);this.fileUrlNode=new Element("div",{styles:this.css.fileDesignerContentLineContentNode}).inject(e);e.setStyle("height","80px");var i=MWF.Actions.get("x_portal_assemble_surface").action.actions.readFile.uri;i=i.replace(/{flag}/,this.data.id);i=i.replace(/{applicationFlag}/,this.data.portal);i="/x_portal_assemble_surface"+i;this.fileUrlNode.setStyle("line-height","18px");var a=MWF.Actions.getHost("x_portal_assemble_surface")+i;this.fileUrlNode.set("text",i);var s=new Element("div",{styles:{height:"30px"},html:"<a target='_blank' href='"+a+"'>open</a>"}).inject(this.fileUrlNode,"bottom")}},modifyContentFileUrl:function(){debugger;if(!this.fileUrlNode){this.createContentFileUrl()}else{var e=MWF.Actions.get("x_portal_assemble_surface").action.actions.readFile.uri;e=e.replace(/{flag}/,this.data.id);e=e.replace(/{applicationFlag}/,this.data.portal);e="/x_portal_assemble_surface"+e;this.fileUrlNode.setStyle("line-height","18px");var t=MWF.Actions.getHost("x_portal_assemble_surface")+e;this.fileUrlNode.set("text",e);var i=new Element("div",{styles:{height:"30px"},html:"<a target='_blank' href='"+t+"'>open</a>"}).inject(this.fileUrlNode,"bottom")}},upload:function(){debugger;if(!this.data.id){var e=this.getData();this.data=Object.merge(this.data,e);MWF.Actions.get("x_portal_assemble_designer").saveFile(this.data,function(){this.explorer.reload();this.uploadFile(function(){this.app.notice(this.lp.file.uploadSuccess,"success")}.bind(this))}.bind(this))}else{this.uploadFile(function(){this.app.notice(this.lp.file.uploadSuccess,"success")}.bind(this))}},uploadFile:function(e){MWF.require("MWF.widget.Upload",function(){new MWF.widget.Upload(this.app.content,{action:MWF.Actions.get("x_portal_assemble_designer").action,method:"uploadFile",parameter:{id:this.data.id},onCompleted:function(){this.loadFileIcon();this.modifyContentFileUrl();if(e)e()}.bind(this),onEvery:function(e,t,i,a){this.data.fileName=a.name;this.data.description=a.name+" "+this.getSizeText(a.size);this.descriptionInput.set("value",this.data.description);MWF.Actions.get("x_portal_assemble_designer").saveFile(this.data)}.bind(this)}).load()}.bind(this))},save:function(){var e=this.getData();this.data=Object.merge(this.data,e);MWF.Actions.get("x_portal_assemble_designer").saveFile(this.data,function(){this.explorer.reload();this.app.notice(this.lp.file.saveSuccess,"success");this.destroy()}.bind(this))}});