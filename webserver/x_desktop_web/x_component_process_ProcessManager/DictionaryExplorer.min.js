MWF.xDesktop.requireApp("process.ProcessManager","Explorer",null,false);MWF.xApplication.process.ProcessManager.DictionaryExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer,Implements:[Options,Events],options:{create:MWF.APPPM.LP.dictionary.create,search:MWF.APPPM.LP.dictionary.search,searchText:MWF.APPPM.LP.dictionary.searchText,noElement:MWF.APPPM.LP.dictionary.noDictionaryNoticeText},initialize:function(t,e,i){this.setOptions(i);this.setTooltip();this.path="/x_component_process_ProcessManager/$DictionaryExplorer/";this.cssPath="/x_component_process_ProcessManager/$DictionaryExplorer/"+this.options.style+"/css.wcss";this._loadCss();this.actions=e;this.node=$(t);this.initData()},setContentSize:function(){var t=this.toolbarNode.getSize();var e=this.node.getSize();var i=this.elementContentNode.getStyle("padding-top").toFloat();var n=this.elementContentNode.getStyle("padding-bottom").toFloat();var o=e.y-t.y-i-n;this.elementContentNode.setStyle("height",""+o+"px");if(this.options.noCreate)this.createElementNode.destroy()},showDeleteAction:function(){if(!this.deleteItemsAction){this.deleteItemsAction=new Element("div",{styles:this.css.deleteItemsAction,text:this.app.lp.deleteItems}).inject(this.node);this.deleteItemsAction.fade("in");this.deleteItemsAction.position({relativeTo:this.elementContentListNode,position:"centerTop",edge:"centerTop",offset:{y:this.elementContentNode.getScroll().y}});this.deleteItemsAction.addEvent("click",function(){var t=this;this.app.confirm("warn",this.deleteItemsAction,MWF.APPPM.LP.deleteElementTitle,MWF.APPPM.LP.deleteElement,300,120,function(){t.deleteItems();this.close()},function(){this.close()})}.bind(this))}},keyCopy:function(e){if(this.selectMarkItems.length){var i=[];var n=0;var o=function(t){if(n>=this.selectMarkItems.length){if(i.length){var e=JSON.encode(i);if(t){t.clipboardData.setData("text/plain",e)}else{window.clipboardData.setData("Text",e)}this.app.notice(this.app.lp.copyed,"success")}}}.bind(this);this.selectMarkItems.each(function(t){this.app.restActions.getDictionary(t.data.id,function(t){t.data.elementType="dictionary";i.push(t.data);n++;o(e)}.bind(this),null,false)}.bind(this))}},keyPaste:function(t){var e="";if(t){e=t.clipboardData.getData("text/plain")}else{e=window.clipboardData.getData("Text")}var i=JSON.decode(e);this.pasteItem(i,0)},pasteItem:function(t,e){if(e<t.length){var i=t[e];if(i.elementType==="dictionary"){this.saveItemAs(i,function(){e++;this.pasteItem(t,e)}.bind(this),function(){e++;this.pasteItem(t,e)}.bind(this),function(){this.reload()}.bind(this))}else{e++;this.pasteItem(t,e)}}else{this.reload()}},saveItemAs:function(p,l,d,h){this.app.restActions.listDictionary(this.app.options.application.id,function(t){var e=1;var i=t.data.filter(function(t){return t.id===p.id});if(i.length){var n=i[0];var o=this.app.lp;var s=this;var a=(new Date).parse(p.updateTime);var c=(new Date).parse(n.updateTime);var r="<div>"+o.copyConfirmInfor+"</div>";r+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+o.copySource+" "+n.name+"</div>";r+="<div style='font-size:12px; color: #666666; float: left'>"+n.updateTime+"</div>"+"<div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'></div>"+"<div style='color: red; float: right;'>"+(a>=c?"":o.copynew)+"</div></div>";r+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+o.copyTarget+" "+p.name+"</div>";r+="<div style='font-size:12px; color: #666666; float: left;'>"+p.updateTime+"</div>"+"<div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'></div>"+"<div style='color: red; float: right;'>"+(a<=c?"":o.copynew)+"</div></div>";this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:r},500,290,[{text:o.copyConfirm_overwrite,action:function(){s.saveItemAsUpdate(n,p,l,d);this.close()}},{text:o.copyConfirm_new,action:function(){s.saveItemAsNew(t,p,l,d);this.close()}},{text:o.copyConfirm_skip,action:function(){this.close();if(l)l()}},{text:o.copyConfirm_cancel,action:function(){this.close();if(h)h()}}])}else{this.saveItemAsNew(t,p,l,d)}}.bind(this),function(){if(d)d()}.bind(this))},saveItemAsUpdate:function(t,e,i,n){e.id=t.id;e.application=t.application;e.applicationName=t.applicationName;e.name=t.name;e.alias=t.alias;this.app.restActions.saveDictionary(e,function(){if(i)i()}.bind(this),function(){if(n)n()}.bind(this))},saveItemAsNew:function(t,e,i,n){var o=this.app.options.application;var s=o.id;var a=o.name;var c=e.name;var r=1;while(t.data.some(function(t){return t.name==e.name||t.alias==e.name})){e.name=c+"_copy"+r;e.alias=c+"_copy"+r;r++}e.id="";e.application=s;e.applicationName=a;this.app.restActions.saveDictionary(e,function(){if(i)i()}.bind(this),function(){if(n)n()}.bind(this))},_createElement:function(t){var e=this;var i={onQueryLoad:function(){this.actions=e.app.restActions;this.application=e.app.options.application;this.explorer=e}};this.app.desktop.openApplication(t,"process.DictionaryDesigner",i)},_loadItemDataList:function(t){this.actions.listDictionary(this.app.options.application.id,t)},_getItemObject:function(t){return new MWF.xApplication.process.ProcessManager.DictionaryExplorer.Dictionary(this,t)},setTooltip:function(){this.options.tooltip={create:MWF.APPPM.LP.dictionary.create,search:MWF.APPPM.LP.dictionary.search,searchText:MWF.APPPM.LP.dictionary.searchText,noElement:MWF.APPPM.LP.dictionary.noDictionaryNoticeText}},loadElementList:function(){this._loadItemDataList(function(t){if(t.data.length){t.data.each(function(t){var e=this._getItemObject(t);e.load()}.bind(this))}else{var e=new Element("div",{styles:this.css.noElementNode,text:this.options.noCreate?MWF.APPPM.LP.dictionary.noDictionaryNoCreateNoticeText:this.options.tooltip.noElement}).inject(this.elementContentListNode);if(!this.options.noCreate){e.addEvent("click",function(t){this._createElement(t)}.bind(this))}}}.bind(this))},deleteItems:function(){this.hideDeleteAction();while(this.deleteMarkItems.length){var t=this.deleteMarkItems.shift();if(this.deleteMarkItems.length){t.deleteDictionary()}else{t.deleteDictionary(function(){}.bind(this))}}}});MWF.xApplication.process.ProcessManager.DictionaryExplorer.Dictionary=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer.Item,load:function(){this.node=new Element("div",{styles:this.explorer.css.itemNode,events:{mouseover:function(){if(this.deleteActionNode)this.deleteActionNode.fade("in");if(this.saveasActionNode)this.saveasActionNode.fade("in")}.bind(this),mouseout:function(){if(this.deleteActionNode)this.deleteActionNode.fade("out");if(this.saveasActionNode)this.saveasActionNode.fade("out")}.bind(this)}}).inject(this.container);if(this.data.name.icon)this.icon=this.data.name.icon;var t=this.explorer.path+""+this.explorer.options.style+"/processIcon/"+this.icon;var e=new Element("div",{styles:this.explorer.css.itemIconNode}).inject(this.node);e.setStyle("background","url("+t+") center center no-repeat");e.addEvent("click",function(t){this.toggleSelected();t.stopPropagation()}.bind(this));e.makeLnk({par:this._getLnkPar()});if(!this.explorer.options.noDelete){this._createActions()}var i=new Element("div",{styles:this.explorer.css.itemInforNode}).inject(this.node);var n=new Element("div",{styles:this.explorer.css.itemInforBaseNode}).inject(i);new Element("div",{styles:this.explorer.css.itemTextTitleNode,text:this.data.name,title:this.data.name,events:{click:function(t){this._open(t);t.stopPropagation()}.bind(this)}}).inject(n);new Element("div",{styles:this.explorer.css.itemTextAliasNode,text:this.data.alias,title:this.data.alias}).inject(n);new Element("div",{styles:this.explorer.css.itemTextDateNode,text:this.data.updateTime||""}).inject(n);new Element("div",{styles:this.explorer.css.itemTextDescriptionNode,text:this.data.description||"",title:this.data.description||""}).inject(i);this._customNodes();this._isNew()},_createActions:function(){this.deleteActionNode=new Element("div",{styles:this.explorer.css.deleteActionNode}).inject(this.node);this.deleteActionNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this));this.saveasActionNode=new Element("div",{styles:this.css.saveasActionNode,title:this.explorer.app.lp.copy}).inject(this.node);this.saveasActionNode.addEvent("click",function(t){this.saveas(t)}.bind(this))},_customNodes:function(){},_open:function(t){debugger;var e=this;var i={onQueryLoad:function(){this.actions=e.explorer.actions;this.category=e;this.options.id=e.data.id;this.application=e.explorer.app.options.application;this.options.noModifyName=e.explorer.options.noModifyName;this.options.readMode=e.explorer.options.readMode;this.explorer=e.explorer}};this.explorer.app.desktop.openApplication(t,"process.DictionaryDesigner",i)},_getIcon:function(){return"dictionary.png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/dictionaryIcon/lnk.png",title:this.data.name,par:'process.DictionaryDesigner#{"id": "'+this.data.id+'", "applicationId": "'+this.explorer.app.options.application.id+'"}'}},deleteDictionary:function(t){this.explorer.app.restActions.deleteDictionary(this.data.id,function(){this.node.destroy();if(t)t()}.bind(this))},saveItemAs:function(t){var o=t.id;var s=t.name;this.explorer.app.restActions.getDictionary(this.data.id,function(t){var i=t.data;var n=i.name;this.explorer.app.restActions.listDictionary(o,function(t){var e=1;while(t.data.some(function(t){return t.name==i.name||t.alias==i.name})){i.name=n+"_copy"+e;i.alias=n+"_copy"+e;e++}i.id="";i.application=o;i.applicationName=s;this.explorer.app.restActions.saveDictionary(i,function(){if(o==this.explorer.app.options.application.id)this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}});