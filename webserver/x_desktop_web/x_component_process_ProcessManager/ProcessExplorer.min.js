MWF.xDesktop.requireApp("process.ProcessManager","Explorer",null,false);MWF.xApplication.process.ProcessManager.ProcessExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer,Implements:[Options,Events],keyCopy:function(i){if(this.selectMarkItems.length){var t=[];var s=0;var n=function(e){if(s>=this.selectMarkItems.length){if(t.length){var i=JSON.encode(t);if(e){e.clipboardData.setData("text/plain",i)}else{window.clipboardData.setData("Text",i)}this.app.notice(this.app.lp.copyed,"success")}}}.bind(this);this.selectMarkItems.each(function(e){this.app.restActions.getProcess(e.data.id,function(e){e.data.elementType="process";t.push(e.data);s++;n(i)}.bind(this),null,false)}.bind(this))}},keyPaste:function(e){var i="";if(e){i=e.clipboardData.getData("text/plain")}else{i=window.clipboardData.getData("Text")}var t=JSON.decode(i);this.pasteItem(t,0)},pasteItem:function(e,i){if(i<e.length){var t=e[i];if(t.elementType==="process"){this.saveItemAs(t,function(){i++;this.pasteItem(e,i)}.bind(this),function(){i++;this.pasteItem(e,i)}.bind(this),function(){this.reload()}.bind(this))}else{i++;this.pasteItem(e,i)}}else{this.reload()}},saveItemAs:function(p,l,d,f){this.app.restActions.listProcess(this.app.options.application.id,function(e){var i=1;var t=e.data.filter(function(e){return e.id===p.id});if(t.length){var s=t[0];var n=this.app.lp;var o=this;var a=(new Date).parse(p.lastUpdateTime);var c=(new Date).parse(s.lastUpdateTime);var r="<div>"+n.copyConfirmInfor+"</div>";r+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+n.copySource+" "+s.name+"</div>";r+="<div style='font-size:12px; color: #666666; float: left'>"+s.lastUpdateTime+"</div>"+"<div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(s.lastUpdatePerson)+"</div>"+"<div style='color: red; float: right;'>"+(a>=c?"":n.copynew)+"</div></div>";r+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+n.copyTarget+" "+p.name+"</div>";r+="<div style='font-size:12px; color: #666666; float: left;'>"+p.lastUpdateTime+"</div>"+"<div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(p.lastUpdatePerson)+"</div>"+"<div style='color: red; float: right;'>"+(a<=c?"":n.copynew)+"</div></div>";this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:r},500,290,[{text:n.copyConfirm_overwrite,action:function(){o.saveItemAsUpdate(s,p,l,d);this.close()}},{text:n.copyConfirm_new,action:function(){o.saveItemAsNew(e,p,l,d);this.close()}},{text:n.copyConfirm_skip,action:function(){this.close();if(l)l()}},{text:n.copyConfirm_cancel,action:function(){this.close();if(f)f()}}])}else{this.saveItemAsNew(e,p,l,d)}}.bind(this),function(){if(d)d()}.bind(this))},saveItemAsUpdate:function(e,i,t,s){i.id=e.id;i.name=e.name;i.alias=e.alias;i.application=e.application;i.applicationName=e.applicationName;i.isNewProcess=false;if(i.begin)i.begin.process=i.id;if(i.endList)i.endList.each(function(e){e.process=i.id});if(i.manualList)i.manualList.each(function(e){e.process=i.id});if(i.conditionList)i.conditionList.each(function(e){e.process=i.id});if(i.choiceList)i.choiceList.each(function(e){e.process=i.id});if(i.parallelList)i.parallelList.each(function(e){e.process=i.id});if(i.splitList)i.splitList.each(function(e){e.process=i.id});if(i.mergeList)i.mergeList.each(function(e){e.process=i.id});if(i.embedList)i.embedList.each(function(e){e.process=i.id});if(i.invokeList)i.invokeList.each(function(e){e.process=i.id});if(i.cancelList)i.cancelList.each(function(e){e.process=i.id});if(i.delayList)i.delayList.each(function(e){e.process=i.id});if(i.messageList)i.messageList.each(function(e){e.process=i.id});if(i.serviceList)i.serviceList.each(function(e){e.process=i.id});if(i.routeList)i.routeList.each(function(e){e.process=i.id});this.app.restActions.saveProcess(i,function(){if(t)t()}.bind(this),function(){if(s)s()}.bind(this))},saveItemAsNew:function(e,i,t,o){var s=this.app.options.application;var n=s.id;var a=s.name;i.alias="";var c=i.name;var r=1;while(e.data.some(function(e){return e.name==i.name})){i.name=c+"_copy"+r;r++}i.application=n;i.applicationName=a;var p=[];p.push(i.id);if(i.begin)p.push(i.begin.id);if(i.endList)i.endList.each(function(e){p.push(e.id)});if(i.manualList)i.manualList.each(function(e){p.push(e.id)});if(i.conditionList)i.conditionList.each(function(e){p.push(e.id)});if(i.choiceList)i.choiceList.each(function(e){p.push(e.id)});if(i.parallelList)i.parallelList.each(function(e){p.push(e.id)});if(i.splitList)i.splitList.each(function(e){p.push(e.id)});if(i.mergeList)i.mergeList.each(function(e){p.push(e.id)});if(i.embedList)i.embedList.each(function(e){p.push(e.id)});if(i.invokeList)i.invokeList.each(function(e){p.push(e.id)});if(i.cancelList)i.cancelList.each(function(e){p.push(e.id)});if(i.delayList)i.delayList.each(function(e){p.push(e.id)});if(i.messageList)i.messageList.each(function(e){p.push(e.id)});if(i.serviceList)i.serviceList.each(function(e){p.push(e.id)});if(i.routeList)i.routeList.each(function(e){p.push(e.id)});this.app.restActions.getId(p.length,function(e){var s=e.data;var n=JSON.encode(i);p.each(function(e,i){var t=new RegExp(e,"ig");n=n.replace(t,s[i].id)}.bind(this));i=JSON.decode(n);i.isNewProcess=true;this.app.restActions.saveProcess(i,function(){if(t)t()}.bind(this),function(){if(o)o()}.bind(this))}.bind(this))},_createElement:function(e){var o=function(e,i){var t={template:i,onQueryLoad:function(){this.actions=p.app.restActions;this.application=p.app.options.application}};layout.desktop.openApplication(e,"process.ProcessDesigner",t)};var a=new Element("div",{styles:this.css.createTemplateMaskNode}).inject(this.app.content);var c=new Element("div",{styles:this.css.createTemplateAreaNode}).inject(this.app.content);c.fade("in");var i=new Element("div",{styles:this.css.createTemplateScrollNode}).inject(c);var r=new Element("div",{styles:this.css.createTemplateContentNode}).inject(i);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(i,{indent:false})}.bind(this));var p=this;var t="/x_component_process_ProcessDesigner/$Process/template/templates.json";MWF.getJSON(t,function(e){e.each(function(e){var i=new Element("div",{styles:this.css.templateNode}).inject(r);var t=new Element("div",{styles:this.css.templateIconNode}).inject(i);var s=new Element("div",{styles:this.css.templateTitleNode,text:e.title}).inject(i);i.store("template",e.name);var n=new Element("img",{styles:this.css.templateIconImgNode}).inject(t);n.set("src","/x_component_process_ProcessDesigner/$Process/template/"+e.icon);i.addEvents({mouseover:function(){this.setStyles(p.css.templateNode_over)},mouseout:function(){this.setStyles(p.css.templateNode)},mousedown:function(){this.setStyles(p.css.templateNode_down)},mouseup:function(){this.setStyles(p.css.templateNode_over)},click:function(e){o(e,this.retrieve("template"));c.destroy();a.destroy()}})}.bind(this))}.bind(this));a.addEvent("click",function(){c.destroy();a.destroy()});var s=this.app.content.getSize();var n=(s.y-262)/2;var l=(s.x-828)/2;if(n<0)n=0;if(l<0)l=0;c.setStyles({top:""+n+"px",left:""+l+"px"})},_loadItemDataList:function(e){this.app.restActions.listProcess(this.app.options.application.id,e)},_getItemObject:function(e){return new MWF.xApplication.process.ProcessManager.ProcessExplorer.Process(this,e)},deleteItems:function(){this.hideDeleteAction();while(this.deleteMarkItems.length){var e=this.deleteMarkItems.shift();if(this.deleteMarkItems.length){e.deleteProcess()}else{e.deleteProcess(function(){}.bind(this))}}}});MWF.xApplication.process.ProcessManager.ProcessExplorer.Process=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer.Item,_open:function(e){var i=this;var t={onQueryLoad:function(){this.actions=i.explorer.actions;this.category=i;this.options.id=i.data.id;this.application=i.explorer.app.options.application}};this.explorer.app.desktop.openApplication(e,"process.ProcessDesigner",t)},_getIcon:function(){var e=(Math.random()*49).toInt();return"process_icon_"+e+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/processIcon/lnk.png",title:this.data.name,par:'process.ProcessDesigner#{"id": "'+this.data.id+'"}'}},deleteProcess:function(e){this.explorer.actions.deleteProcess(this.data.id,function(){this.node.destroy();if(e)e()}.bind(this))},saveItemAs:function(e){var a=e.id;var n=e.name;this.explorer.app.restActions.getProcess(this.data.id,function(e){var o=e.data;o.alias="";var s=o.name;this.explorer.app.restActions.listProcess(a,function(e){var i=1;while(e.data.some(function(e){return e.name==o.name})){o.name=s+"_copy"+i;i++}o.application=a;o.applicationName=n;var t=[];t.push(o.id);if(o.begin)t.push(o.begin.id);if(o.endList)o.endList.each(function(e){t.push(e.id)});if(o.manualList)o.manualList.each(function(e){t.push(e.id)});if(o.conditionList)o.conditionList.each(function(e){t.push(e.id)});if(o.choiceList)o.choiceList.each(function(e){t.push(e.id)});if(o.parallelList)o.parallelList.each(function(e){t.push(e.id)});if(o.splitList)o.splitList.each(function(e){t.push(e.id)});if(o.mergeList)o.mergeList.each(function(e){t.push(e.id)});if(o.embedList)o.embedList.each(function(e){t.push(e.id)});if(o.invokeList)o.invokeList.each(function(e){t.push(e.id)});if(o.cancelList)o.cancelList.each(function(e){t.push(e.id)});if(o.delayList)o.delayList.each(function(e){t.push(e.id)});if(o.messageList)o.messageList.each(function(e){t.push(e.id)});if(o.serviceList)o.serviceList.each(function(e){t.push(e.id)});if(o.routeList)o.routeList.each(function(e){t.push(e.id)});this.explorer.app.restActions.getId(t.length,function(e){var s=e.data;var n=JSON.encode(o);t.each(function(e,i){var t=new RegExp(e,"ig");n=n.replace(t,s[i].id)}.bind(this));o=JSON.decode(n);o.isNewProcess=true;this.explorer.app.restActions.saveProcess(o,function(){if(a==this.explorer.app.options.application.id)this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}.bind(this))}});