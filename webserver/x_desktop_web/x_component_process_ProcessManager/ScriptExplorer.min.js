MWF.xDesktop.requireApp("process.ProcessManager","DictionaryExplorer",null,false);MWF.xApplication.process.ProcessManager.ScriptExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.DictionaryExplorer,Implements:[Options,Events],options:{create:MWF.APPPM.LP.dictionary.create,search:MWF.APPPM.LP.dictionary.search,searchText:MWF.APPPM.LP.dictionary.searchText,noElement:MWF.APPPM.LP.dictionary.noDictionaryNoticeText},keyCopy:function(i){if(this.selectMarkItems.length){var e=[];var a=0;var n=function(t){if(a>=this.selectMarkItems.length){if(e.length){var i=JSON.encode(e);if(t){t.clipboardData.setData("text/plain",i)}else{window.clipboardData.setData("Text",i)}this.app.notice(this.app.lp.copyed,"success")}}}.bind(this);this.selectMarkItems.each(function(t){this.app.restActions.getScript(t.data.id,function(t){t.data.elementType="script";e.push(t.data);a++;n(i)}.bind(this),null,false)}.bind(this))}},keyPaste:function(t){var i="";if(t){i=t.clipboardData.getData("text/plain")}else{i=window.clipboardData.getData("Text")}var e=JSON.decode(i);this.pasteItem(e,0)},pasteItem:function(t,i){if(i<t.length){var e=t[i];if(e.elementType==="script"){this.saveItemAs(e,function(){i++;this.pasteItem(t,i)}.bind(this),function(){i++;this.pasteItem(t,i)}.bind(this),function(){this.reload()}.bind(this))}else{i++;this.pasteItem(t,i)}}else{this.reload()}},saveItemAs:function(c,l,d,h){this.app.restActions.listScript(this.app.options.application.id,function(t){var i=1;var e=t.data.filter(function(t){return t.id===c.id});if(e.length){var a=e[0];var n=this.app.lp;var s=this;var o=(new Date).parse(c.lastUpdateTime);var p=(new Date).parse(a.lastUpdateTime);var r="<div>"+n.copyConfirmInfor+"</div>";r+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+n.copySource+" "+a.name+"</div>";r+="<div style='font-size:12px; color: #666666; float: left'>"+a.lastUpdateTime+"</div>"+"<div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(a.lastUpdatePerson)+"</div>"+"<div style='color: red; float: right;'>"+(o>=p?"":n.copynew)+"</div></div>";r+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+n.copyTarget+" "+c.name+"</div>";r+="<div style='font-size:12px; color: #666666; float: left;'>"+c.lastUpdateTime+"</div>"+"<div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(c.lastUpdatePerson)+"</div>"+"<div style='color: red; float: right;'>"+(o<=p?"":n.copynew)+"</div></div>";this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:r},500,290,[{text:n.copyConfirm_overwrite,action:function(){s.saveItemAsUpdate(a,c,l,d);this.close()}},{text:n.copyConfirm_new,action:function(){s.saveItemAsNew(t,c,l,d);this.close()}},{text:n.copyConfirm_skip,action:function(){this.close();if(l)l()}},{text:n.copyConfirm_cancel,action:function(){this.close();if(h)h()}}])}else{this.saveItemAsNew(t,c,l,d)}}.bind(this),function(){if(d)d()}.bind(this))},saveItemAsUpdate:function(t,i,e,a){i.id=t.id;i.name=t.name;i.alias=t.alias;i.isNewScript=false;i.application=t.application;i.applicationName=t.applicationName;this.app.restActions.saveScript(i,function(){if(e)e()}.bind(this),function(){if(a)a()}.bind(this))},saveItemAsNew:function(t,i,e,a){var n=this.app.options.application;var s=n.id;var o=n.name;var p=i.name;var r=1;while(t.data.some(function(t){return t.name==i.name||t.alias==i.name})){i.name=p+"_copy"+r;i.alias=p+"_copy"+r;r++}i.id="";i.isNewScript=true;i.application=s;i.applicationName=o;this.app.restActions.saveScript(i,function(){if(e)e()}.bind(this),function(){if(a)a()}.bind(this))},_createElement:function(t){var i=this;var e={onQueryLoad:function(){this.actions=i.app.restActions;this.application=i.app.options.application||i.app.application;this.explorer=i}};this.app.desktop.openApplication(t,"process.ScriptDesigner",e)},_loadItemDataList:function(t){var i="";if(this.app.application)i=this.app.application.id;if(this.app.options.application)i=this.app.options.application.id;this.actions.listScript(i,t)},_getItemObject:function(t){return new MWF.xApplication.process.ProcessManager.ScriptExplorer.Script(this,t)},setTooltip:function(){this.options.tooltip={create:MWF.APPPM.LP.script.create,search:MWF.APPPM.LP.script.search,searchText:MWF.APPPM.LP.script.searchText,noElement:MWF.APPPM.LP.script.noScriptNoticeText}},deleteItems:function(){this.hideDeleteAction();while(this.deleteMarkItems.length){var t=this.deleteMarkItems.shift();if(this.deleteMarkItems.length){t.deleteScript()}else{t.deleteScript(function(){}.bind(this))}}}});MWF.xApplication.process.ProcessManager.ScriptExplorer.Script=new Class({Extends:MWF.xApplication.process.ProcessManager.DictionaryExplorer.Dictionary,_customNodes:function(){if(!this.data.validated){new Element("div",{styles:this.explorer.css.itemErrorNode}).inject(this.node);this.node.setStyle("background-color","#f9e8e8")}},_open:function(t){var i=this;var e={onQueryLoad:function(){this.actions=i.explorer.actions;this.category=i;this.options.id=i.data.id;this.application=i.explorer.app.options.application;this.explorer=i.explorer}};this.explorer.app.desktop.openApplication(t,"process.ScriptDesigner",e)},_getIcon:function(){return"script.png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/scriptIcon/lnk.png",title:this.data.name,par:'process.ScriptDesigner#{"id": "'+this.data.id+'", "applicationId": "'+this.explorer.app.options.application.id+'"}'}},deleteScript:function(t){this.explorer.app.restActions.deleteScript(this.data.id,function(){this.node.destroy();if(t)t()}.bind(this))},saveItemAs:function(t){var n=t.id;var s=t.name;this.explorer.app.restActions.getScript(this.data.id,function(t){var e=t.data;var a=e.name;this.explorer.app.restActions.listScript(n,function(t){var i=1;while(t.data.some(function(t){return t.name==e.name||t.alias==e.name})){e.name=a+"_copy"+i;e.alias=a+"_copy"+i;i++}e.id="";e.isNewScript=true;e.application=n;e.applicationName=s;this.explorer.app.restActions.saveScript(e,function(){if(n==this.explorer.app.options.application.id)this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}});