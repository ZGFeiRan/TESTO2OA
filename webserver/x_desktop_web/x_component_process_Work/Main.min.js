MWF.xApplication.process.Work.options.multitask=true;MWF.xApplication.process.Work.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"process.Work",icon:"icon.png",width:"1200",height:"800",title:MWF.xApplication.process.Work.LP.title,workId:"",workCompletedId:"",taskId:"",isControl:false,taskObject:null,readonly:false},onQueryLoad:function(){this.lp=MWF.xApplication.process.Work.LP;if(this.status){this.options.workId=this.status.workId;this.options.workCompletedId=this.status.workCompletedId;this.options.readonly=this.status.readonly=="true"?true:false}},loadApplication:function(t){this.node=new Element("div",{styles:this.css.content}).inject(this.content);MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop"});this.formNode=new Element("div",{styles:{"min-height":"100%","font-size":"14px"}}).inject(this.node);this.action=MWF.Actions.get("x_processplatform_assemble_surface");if(!this.options.isRefresh){this.maxSize(function(){this.mask.loadNode(this.content);this.loadWork()}.bind(this))}else{this.mask.loadNode(this.content);this.loadWork()}if(t)t()}.bind(this));this.addEvent("queryClose",function(){this.refreshTaskCenter()}.bind(this));this.addKeyboardEvents()},refreshTaskCenter:function(){if(this.desktop.apps["TaskCenter"]){this.desktop.apps["TaskCenter"].content.unmask();this.desktop.apps["TaskCenter"].refreshAll()}},addKeyboardEvents:function(){this.addEvent("keySave",function(t){this.keySave(t)}.bind(this))},keySave:function(t){if(this.appForm){if(!this.options.readonly){this.appForm.saveWork();t.preventDefault()}}},reload:function(t){if(this.form){this.formNode.empty();MWF.release(this.form);this.form=null}if(t){this.parseData(t);this.openWork()}else{this.loadWork()}},loadWork:function(){var t="";var s="";if(this.options.taskId){t="getJobByTask";s=this.options.taskId}else if(this.options.workCompletedId){t="getJobByWorkCompleted";s=this.options.workCompletedId}else if(this.options.workId){t="getJobByWork";s=this.options.workId}if(t&&s){this.action[t](function(t){if(this.mask)this.mask.hide();this.parseData(t.data);this.openWork()}.bind(this),function(){this.close()}.bind(this),s)}},errorWork:function(){if(this.mask)this.mask.hide();this.node.set("text","openError")},getCurrentTaskData:function(t){if((t.currentTaskIndex||t.currentTaskIndex===0)&&t.currentTaskIndex!=-1){this.options.taskId=this.taskList[t.currentTaskIndex].id;return this.taskList[t.currentTaskIndex]}return null},parseData:function(t){var s="";if(this.options.taskId){s=t.work.title;this.options.workId=t.work.id}else if(this.options.workCompletedId){s=t.workCompleted.title;this.options.workCompleted=t.workCompleted.id}else if(this.options.workId){s=t.work.title;this.options.workId=t.work.id}this.setTitle(this.options.title+"-"+s);this.activity=t.activity;this.data=t.data;this.taskList=t.taskList;this.currentTask=this.getCurrentTaskData(t);this.taskList=t.taskList;this.readList=t.readList;this.work=t.work;this.workCompleted=t.workCompleted;this.workLogList=t.workLogList;this.attachmentList=t.attachmentList;this.inheritedAttachmentList=t.inheritedAttachmentList;this.control=t.control;this.form=t.form?JSON.decode(MWF.decodeJsonString(t.form.data)):null},openWork:function(){if(this.form){MWF.xDesktop.requireApp("process.Xform","Form",function(){this.appForm=new MWF.APPForm(this.formNode,this.form,{});this.appForm.businessData={data:this.data,taskList:this.taskList,readList:this.readList,work:this.work,workCompleted:this.workCompleted,control:this.control,activity:this.activity,task:this.currentTask,workLogList:this.workLogList,attachmentList:this.attachmentList,status:{readonly:this.readonly}};this.appForm.workAction=this.action;this.appForm.app=this;this.appForm.load()}.bind(this))}},recordStatus:function(){return{workId:this.options.workId,workCompletedId:this.options.workCompletedId,readonly:this.readonly}},onPostClose:function(){if(this.appForm){this.appForm.modules.each(function(t){MWF.release(t)});MWF.release(this.appForm)}}});