MWF.xDesktop.requireApp("process.Xform","$Module",null,false);MWF.xApplication.process.Xform.Log=MWF.APPLog=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty();this.node.setStyle("-webkit-user-select","text");if(this.form.businessData){if(this.form.businessData.workLogList){this.workLog=this.form.businessData.workLogList;this.loadWorkLog()}}},loadWorkLog:function(){if(this.json.mode==="table"){this.loadWorkLogTable()}else if(this.json.mode==="text"){this.loadWorkLogText()}else{this.loadWorkLogDefault()}},loadWorkLogTable:function(){this.workLog.each(function(t,e){if(this.checkShow(t))this.loadWorkLogLine_table(t,e)}.bind(this))},loadWorkLogLine_table:function(e,t){if(e.taskCompletedList.length||this.json.isTask&&e.taskList.length){var i=new Element("div",{styles:this.form.css.logActivityNode}).inject(this.node);var s=new Element("div",{styles:this.form.css.logActivityTitleNode}).inject(i);var o=new Element("div",{styles:this.form.css.logActivityChildNode}).inject(i);var n=new Element("div",{styles:this.form.css.logActivityIconNode}).inject(s);var r=new Element("div",{styles:this.form.css.logActivityFromNode}).inject(s);var l=new Element("div",{styles:this.form.css.logActivityArrowNode}).inject(s);var c=new Element("div",{styles:this.form.css.logActivityArrivedNode}).inject(s);var a=new Element("div",{styles:this.form.css.logActivityTimeNode}).inject(s);if(e.connected){n.setStyle("background-image","url("+"/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/ok14.png)")}else{n.setStyle("background-image","url("+"/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)")}r.set("html","<b>"+e.fromActivityName+"</b>");if(e.arrivedActivityName){l.setStyle("background-image","url("+"/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/right.png)");c.set("html","<b>"+e.arrivedActivityName+"</b>");a.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime+"<br/><b>"+MWF.xApplication.process.Xform.LP.end+": </b>"+e.arrivedTime)}else{a.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime)}if(t%2===0){i.setStyles(this.form.css.logActivityNode_even);s.setStyles(this.form.css.logActivityTitleNode_even)}var f=new Element("table",{styles:this.form.css.logTableTask,border:"0",cellSpacing:"0",cellpadding:"3px",width:"100%"}).inject(o);var m=f.insertRow(0).setStyles(this.form.css.logTableTaskTitleLine);var h=m.insertCell(0).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.person);h=m.insertCell(1).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.department);h=m.insertCell(2).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.startTime);h=m.insertCell(3).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.completedTime);h=m.insertCell(4).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.route);h=m.insertCell(5).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.opinion);e.taskCompletedList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_table(t,f,e,false)}.bind(this));if(this.json.isTask){e.taskList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_table(t,f,e,true)}.bind(this))}}},loadTaskLine_table:function(t,e,i,s){var o="logTableTaskLine";if(s)o="logTableTaskLine_task";var n=e.insertRow(e.rows.length);var r=n.insertCell(0).setStyles(this.form.css[o]);r.set("text",t.person.substring(0,t.person.indexOf("@"))||"");r=n.insertCell(1).setStyles(this.form.css[o]);r.set("text",t.unit.substring(0,t.unit.indexOf("@"))||"");r=n.insertCell(2).setStyles(this.form.css[o]);r.set("text",t.startTime||"");r=n.insertCell(3).setStyles(this.form.css[o]);r.set("text",t.completedTime||"");r=n.insertCell(4).setStyles(this.form.css[o]);r.set("text",t.routeName||"");r=n.insertCell(5).setStyles(this.form.css[o]);r.set("text",t.opinion||"")},loadWorkLogText:function(){this.lineClass="logTaskNode";this.workLog.each(function(t,e){if(this.checkShow(t))this.loadWorkLogLine_text(t,e)}.bind(this))},loadWorkLogLine_text:function(e,t){e.taskCompletedList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_text(t,this.node,e,false)}.bind(this));if(this.json.isTask){e.taskList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_text(t,this.node,e,true)}.bind(this))}},loadTaskLine_text:function(t,e,i,s){this.loadTaskLine_default(t,e,i,s,"0px",false)},checkShow:function(t){var e=true;if(this.json.filterScript&&this.json.filterScript.code){this.form.Macro.environment.log=t;this.form.Macro.environment.list=null;e=this.form.Macro.exec(this.json.filterScript.code,this)}else{if(this.json.filterActivity.length){filterActivitys=this.json.filterActivity;e=filterActivitys.indexOf(t.fromActivityName)!==-1}if(this.json.filterActivityAlias){if(this.json.filterActivityAlias.length){filterActivityAlias=this.json.filterActivityAlias;e=t.fromActivityAlias&&filterActivityAlias.indexOf(t.fromActivityAlias)!==-1}}if(this.json.filterPerson.length){e=false;filterPersons=this.json.filterPerson;var i=[];t.taskCompletedList.each(function(t){if(filterPersons.indexOf(t.person)!==-1||filterPersons.indexOf(t.identity)!==-1){i.push(t)}}.bind(this));if(i.length){e=true}}if(this.json.filterRoute.length){filterRoutes=this.json.filterRoute;e=filterRoutes.indexOf(t.routeName)!==-1}}return e},checkListShow:function(t,e){var i=true;if(this.json.filterScript&&this.json.filterScript.code){this.form.Macro.environment.log=t;this.form.Macro.environment.list=e;i=this.form.Macro.exec(this.json.filterScript.code,this)}else{if(this.json.filterPerson.length){i=filterPersons.indexOf(e.person)!==-1||filterPersons.indexOf(e.identity)!==-1}}return i},loadWorkLogDefault:function(){this.workLog.each(function(t,e){if(this.checkShow(t))this.loadWorkLogLine_default(t,e)}.bind(this))},loadWorkLogLine_default:function(e,t){if(e.taskCompletedList.length||this.json.isTask&&e.taskList.length){var i=new Element("div",{styles:this.form.css.logActivityNode}).inject(this.node);var s=new Element("div",{styles:this.form.css.logActivityTitleNode}).inject(i);var o=new Element("div",{styles:this.form.css.logActivityChildNode}).inject(i);var n=new Element("div",{styles:this.form.css.logActivityIconNode}).inject(s);var r=new Element("div",{styles:this.form.css.logActivityFromNode}).inject(s);var l=new Element("div",{styles:this.form.css.logActivityArrowNode}).inject(s);var c=new Element("div",{styles:this.form.css.logActivityArrivedNode}).inject(s);var a=new Element("div",{styles:this.form.css.logActivityTimeNode}).inject(s);if(e.connected){n.setStyle("background-image","url(/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/ok14.png)")}else{n.setStyle("background-image","url(/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)")}r.set("html","<b>"+e.fromActivityName+"</b>");if(e.arrivedActivityName){l.setStyle("background-image","url(/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/right.png)");c.set("html","<b>"+e.arrivedActivityName+"</b>");a.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime+"<br/><b>"+MWF.xApplication.process.Xform.LP.end+": </b>"+e.arrivedTime)}else{a.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime)}if(t%2===0){i.setStyles(this.form.css.logActivityNode_even);s.setStyles(this.form.css.logActivityTitleNode_even)}e.taskCompletedList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_default(t,o,e,false)}.bind(this));if(this.json.isTask){e.taskList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_default(t,o,e,true)}.bind(this))}}},loadTaskLine_default:function(t,e,i,s,o,n,r){var l="logTaskNode";if(r)l="logTaskTextNode";var c=new Element("div",{styles:this.form.css[l]}).inject(e);var a=new Element("div",{styles:this.form.css.logTaskIconNode}).inject(c);var f=new Element("div",{styles:this.form.css.logTaskTextNode}).inject(c);if(n){c.setStyles(this.form.css[this.lineClass]);if(this.lineClass==="logTaskNode"){this.lineClass="logTaskNode_even"}else{this.lineClass="logTaskNode"}}if(o)a.setStyle("margin-left",o);var m=a.getStyle("margin-left").toInt();m=m+28;f.setStyle("margin-left",""+m+"px");var h;var d="";if(!s){d=t.unitList?t.unitList[t.unitList.length-1]:"";h=this.json.textStyle;h=h.replace(/\{person\}/g,t.person.substring(0,t.person.indexOf("@")));h=h.replace(/\{department\}/g,t.unit.substring(0,t.unit.indexOf("@")));h=h.replace(/\{route\}/g,t.routeName);h=h.replace(/\{time\}/g,t.completedTime);h=h.replace(/\{date\}/g,(new Date).parse(t.completedTime).format("Y-M-d"));h=h.replace(/\{opinion\}/g,t.opinion);h=h.replace(/\{company\}/g,d.substring(0,d.indexOf("@")));h=h.replace(/\{startTime\}/g,t.startTime);h=h.replace(/\{startDate\}/g,(new Date).parse(t.startTime).format("Y-M-d"));h=h.replace(/\{activity\}/g,i.fromActivityName);h=h.replace(/\{arrivedActivity\}/g,t.arrivedActivityName);f.set("html",h)}else{h=t.person.substring(0,t.person.indexOf("@"))+"("+t.unit.substring(0,t.unit.indexOf("@"))+")"+MWF.xApplication.process.Xform.LP.processing+", "+MWF.xApplication.process.Xform.LP.comeTime+": "+t.startTime;f.set("html",h);a.setStyle("background-image","url("+"/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)")}}});