MWF.xApplication.process.Xform.widget=MWF.xApplication.process.Xform.widget||{};MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.widget.MWFRaphael",null,false);MWF.xApplication.process.Xform.widget.Monitor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default"},initialize:function(t,e,s,i){this.setOptions(i);this.path="/x_component_process_Xform/widget/$Monitor/";this.cssPath="/x_component_process_Xform/widget/$Monitor/"+this.options.style+"/css.wcss";this._loadCss();this.container=$(t);this.worklog=e;this.processid=s;this.load()},load:function(){this.logProcessChartNode=new Element("div",{styles:this.css.logProcessChartNode}).inject(this.container);this.logPathChartNode=new Element("div",{styles:this.css.logPathChartNode}).inject(this.container);this.checkMonitorOpen()},checkMonitorOpen:function(){var t=this.container;var e=t.retrieve("module");var s=false;var i=false;while(true){if(t.getStyle("display")==="none"){s=true}if(e&&e.json.type==="Tab$Content"){i=true}if(s&&i)break;t=t.getParent();if(!t)break;if(!i)e=t.retrieve("module")}if(s){if(i){for(var o=0;o<e.tab.tab.pages.length;o++){if(e.tab.tab.pages[o].contentNode===e.node)break}e.tab.tab.pages[o].setOptions({onPostShow:function(){this.openProcess()}.bind(this)})}else{this.openProcessChartAction=new Element("div",{styles:this.css.openProcessChartAction,text:"Show Process"}).inject(this.logProcessChartNode);this.openProcessChartAction.addEvent("click",function(t){this.openProcess(t)}.bind(this))}}else{this.openProcess()}},openProcess:function(){if(!this.process){this.logProcessChartNode.empty();this.loadToolbar();this.paperNode=new Element("div",{styles:this.css.paperNode}).inject(this.logProcessChartNode);this.getProcess(function(t){this.processData=t.data;this.loadPaper()}.bind(this))}},loadToolbar:function(){MWF.require("MWF.widget.Toolbar",function(){this.toolbarNode=new Element("div").inject(this.logProcessChartNode);this.createToolbarNode("play.png","logPlay","");this.toolbar=new MWF.widget.Toolbar(this.toolbarNode,{style:this.options.style},this);this.toolbar.load()}.bind(this))},createToolbarNode:function(t,e,s){new Element("div",{MWFnodetype:"MWFToolBarButton",MWFButtonImage:this.path+""+this.options.style+"/tools/"+t,title:"",MWFButtonAction:e,MWFButtonText:"",MWFButtonDisable:s}).inject(this.toolbarNode)},logPlay:function(){if(this.process){this.isPlaying=true;this.toolbar.childrenButton[0].setDisable(true);this.processReturnStyle();this.playBegin();this.playToNextActivity()}},playBegin:function(){var t="/x_component_process_Xform/widget/$Monitor/"+this.options.style+"/fly.png";this.playIcon=this.paper.image(t,this.process.begin.center.x-16,this.process.begin.center.y-16,32,32);this.playLogNode=null;this.playsStatus={index:0};this.isPlaying=true},playGetNextActivity:function(){var t=this.worklog[this.playsStatus.index];var e=t.fromActivityType;var s=e.toLowerCase()=="begin"?this.process.begin:this.process[e+"s"][t.fromActivity];return{log:t,activity:s}},playToNextActivity:function(t){var e=this.playGetNextActivity();if(this.playsStatus.index==0){this.playToActivityStop(e.activity,e.log)}else{this.playMoveToActivity(e.activity,e.log,t)}},playMoveToActivity:function(t,e,s){if(s){var i=[s.beginPoint];i=i.concat(s.positionPoints,[s.endPoint],[{x:t.center.x,y:t.center.y}]);this.playMoveByRoutePoint(i,function(){this.playToActivityStop(t,e,s)}.bind(this))}else{this.playToActivityStop(t,e,s)}},playMoveByRoutePoint:function(t,e){var s={x:this.playIcon.attr("x").toFloat(),y:this.playIcon.attr("y").toFloat()};var i=t.shift();var o=MWFRaphael.getPointDistance(s,i);var n=o/.2;this.playIcon.animate({x:i.x-16,y:i.y-16},n,"linear",function(){if(t.length){this.playMoveByRoutePoint(t,e)}else{if(e)e()}}.bind(this))},playToActivityStop:function(t,e,s){this.playIcon.attr({x:t.center.x-16,y:t.center.y-16});if(e.connected){t.shap.attr(this.css.passedActivityShap)}else{t.shap.attr(this.css.currentActivityShap)}var i=this.process.routes[e.route];if(s){s.line.attr(this.css.passedRouteShap);s.point.attr(this.css.passedRouteFillShap);s.arrow.attr(this.css.passedRouteFillShap)}this.showPlayLog(t,e);this.playsStatus.index++;window.setTimeout(function(){if(this.worklog.length<=this.playsStatus.index){this.playStop()}else{this.playLogNode.destroy();this.playLogNode=null;this.playToNextActivity(i)}}.bind(this),2e3)},showPlayLog:function(t,e){var s=this.paperNode.getPosition(this.paperNode.getOffsetParent());var i=this.paperNode.getSize();this.playLogNode=this.createWorkLogNode([e]);this.playLogNode.setStyle("display","block");var o=this.getlogNodePosition(t,this.playLogNode,s,i);this.playLogNode.setPosition({x:o.x,y:o.y})},playStop:function(){this.playIcon.remove();if(this.playLogNode)this.playLogNode.destroy();this.playLogNode=null;this.playsStatus={index:0};this.isPlaying=false;this.toolbar.childrenButton[0].setDisable(false);this.loadWorkLog()},processReturnStyle:function(){this.worklog.each(function(t){var e=t.fromActivityType;var s=e.toLowerCase()=="begin"?this.process.begin:this.process[e+"s"][t.fromActivity];s.shap.attr(s.style.shap);s.passedCount=0;s.worklogs=[];var i=this.process.routes[t.route];if(i){i.line.attr(this.process.css.route.line.normal);i.point.attr(this.process.css.route.decision.normal);i.arrow.attr(this.process.css.route.arrow.normal)}if(s.countSet)s.countSet.remove()}.bind(this))},loadPaper:function(){MWFRaphael.load(function(){this.paperInNode=new Element("div",{styles:this.css.paperInNode}).inject(this.paperNode);this.paper=Raphael(this.paperInNode,"98%","99%");this.paper.container=this.paperNode;MWF.xDesktop.requireApp("process.ProcessDesigner","Process",function(){this.process=new MWF.APPPD.Process(this.paper,this.processData,this,{style:"flat",isView:true,onPostLoad:function(){this.loadWorkLog()}.bind(this)});this.process.load()}.bind(this))}.bind(this))},getProcess:function(e){this.action=MWF.Actions.get("x_processplatform_assemble_surface");this.action.getProcess(function(t){if(e)e(t)},null,this.processid)},loadWorkLog:function(){this.countNodes=[];var n={};this.worklogToken={};this.worklog.each(function(t){this.worklogToken[t.fromActivityToken]=t;var e=t.fromActivityType;var s=e.toLowerCase()=="begin"?this.process.begin:this.process[e+"s"][t.fromActivity];if(t.connected){s.shap.attr(this.css.passedActivityShap)}else{s.shap.attr(this.css.currentActivityShap)}var i=this.process.routes[t.route];if(i){i.line.attr(this.css.passedRouteShap);i.point.attr(this.css.passedRouteFillShap);i.arrow.attr(this.css.passedRouteFillShap)}var o=t.taskCompletedList.length;if(o)s.passedCount=s.passedCount?s.passedCount+o:o;if(!s.worklogs)s.worklogs=[];s.worklogs.push(t);if(!n[t.fromActivity])n[t.fromActivity]=s}.bind(this));var e=this.paperNode.getPosition(this.paperNode.getOffsetParent());var s=this.paperNode.getSize();Object.each(n,function(t){this.writePassCount(t);this.writeWorkLog(t,e,s)}.bind(this))},writePassCount:function(t){if(t.passedCount){var e=t.point.x+t.width;var s=t.point.y;var i=this.paper.circle(e,s,9);i.attr(this.css.activityPassedCount);text=this.paper.text(e,s,t.passedCount);text.attr(this.css.activityPassedCountText);t.countSet=this.paper.set();t.countSet.push(i,text)}},writeWorkLog:function(t,e,s){var i=this;t.set.click(function(t){if(!i.isPlaying){if(this.process.selectedActivitys.length){if(!this.noselected){this.selected();i.showWorklog(this,e,s)}this.noselected=false}if(this.countSet)this.countSet.toFront()}t.stopPropagation()}.bind(t));t.set.mousedown(function(t){if(!i.isPlaying){if(!this.process.selectedActivitys.length){this.selected();i.showWorklog(this,e,s)}if(this.countSet)this.countSet.toFront()}t.stopPropagation()}.bind(t));this.paper.canvas.addEvent("click",function(t){if(!i.isPlaying){if(this.unSelectedEvent){if(this.currentSelected||this.selectedActivitys.length){this.unSelected(t);i.hideCurrentWorklog()}}else{this.unSelectedEvent=true}}}.bind(this.process))},getlogNodePosition:function(t,e,s,i){var o=e.getSize();var n=0;var r=t.point.x+t.width+15+s.x;tmpX=r+o.x;if(tmpX>s.x+i.x){r=t.point.x-o.x-15+s.x;if(r<s.x){n=t.point.y-o.y-15+s.y;r=t.center.x-o.x/2+s.x}else{n=t.center.y-o.y/2+s.y;if(n<s.y){n=s.y}}}else{n=t.center.y-o.y/2+s.y;if(n<s.y){n=s.y}}var a=this.paperNode.getScroll();var l=0;var c=0;var h=this.paperNode.getParent();while(h){var p=h.getScroll();l+=p.y;c+=p.x;h=h.getParent()}n=n-a.y-l;r=r-a.x-c;return{x:r,y:n}},showWorklog:function(t,e,s){this.hideCurrentWorklog();if(!t.worklogNode)t.worklogNode=this.createWorkLogNode(t.worklogs);this.currentWorklogNode=t.worklogNode;this.currentWorklogNode.setStyle("display","block");var i=this.getlogNodePosition(t,t.worklogNode,e,s);t.worklogNode.setPosition({x:i.x,y:i.y})},hideCurrentWorklog:function(){if(this.currentWorklogNode){this.currentWorklogNode.setStyle("display","none");this.currentWorklogNode=null}},createWorkLogNode:function(t){var n=new Element("div",{styles:this.css.workLogNode});t.each(function(t,e){var i=new Element("div",{styles:this.css.workLogWorkNode}).inject(n);if(e%2==0){i.setStyle("background-color","#FFF")}else{i.setStyle("background-color","#EEE")}if(t.taskCompletedList.length+t.taskList.length<1){if(t.connected){var s=new Element("div",{styles:this.css.workLogTaskNode}).inject(i);var o="<div style='font-weight: bold'>"+MWF.xApplication.process.Xform.LP.systemProcess+" </div>";o+="<div style='text-align: right'>"+t.arrivedTime+"</div>";s.set("html",o)}else{var s=new Element("div",{styles:this.css.workLogTaskNode}).inject(i);var o="<div style='font-weight: bold; color: red'>"+MWF.xApplication.process.Xform.LP.systemProcess+" </div>";s.set("html",o)}}else{t.taskCompletedList.each(function(t){var e=new Element("div",{styles:this.css.workLogTaskNode}).inject(i);var s="<div style='font-weight: bold'>"+t.person.substring(0,t.person.indexOf("@"))+": </div>";s+="<div style='margin-left: 10px'>["+(t.routeName||"")+"] "+t.opinion+"</div>";s+="<div style='text-align: right'>"+t.completedTime+"</div>";e.set("html",s)}.bind(this));t.taskList.each(function(t){var e=new Element("div",{styles:this.css.workLogTaskNode}).inject(i);var s="<div style='font-weight: bold; color: red'>"+t.person.substring(0,t.person.indexOf("@"))+" "+MWF.xApplication.process.Xform.LP.processing+" </div>";e.set("html",s)}.bind(this))}}.bind(this));n.inject(this.paperNode);return n}});MWF.xApplication.process.Xform.widget.Monitor.Animation=new Class({Implements:[Events],initialize:function(t,e){}});