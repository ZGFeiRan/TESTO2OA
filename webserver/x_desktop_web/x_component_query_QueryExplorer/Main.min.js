MWF.xDesktop.requireApp("process.ApplicationExplorer","",null,false);MWF.xApplication.query.QueryExplorer.Main=new Class({Extends:MWF.xApplication.process.ApplicationExplorer.Main,Implements:[Options,Events],options:{style:"default",name:"query.QueryExplorer",icon:"icon.png",width:"1000",height:"600",title:MWF.QueryLP.title,tooltip:{cancel:MWF.QueryLP.application.action_cancel,ok:MWF.QueryLP.application.action_ok,create:MWF.QueryLP.application.create,search:MWF.QueryLP.application.search,searchText:MWF.QueryLP.application.searchText,allCategory:MWF.QueryLP.application.allCategory,unCategory:MWF.QueryLP.application.unCategory,selectCategory:MWF.QueryLP.application.selectCategory,nameLabel:MWF.QueryLP.application.name,aliasLabel:MWF.QueryLP.application.alias,descriptionLabel:MWF.QueryLP.application.description,typeLabel:MWF.QueryLP.application.type,iconLabel:MWF.QueryLP.application.icon,createApplication_cancel_title:MWF.QueryLP.application.createApplication_cancel_title,createApplication_cancel:MWF.QueryLP.application.createApplication_cancel,inputApplicationName:MWF.QueryLP.application.inputApplicationName,createApplicationSuccess:MWF.QueryLP.application.createApplicationSuccess,unDescription:MWF.QueryLP.application.unDescription,noPage:MWF.QueryLP.application.noPage,noView:MWF.QueryLP.application.noView,noStat:MWF.QueryLP.application.noStat,noApplication:MWF.QueryLP.application.noApplication,noApplicationCreate:MWF.QueryLP.application.noApplicationCreate,loadding:MWF.QueryLP.application.loadding}},onQueryLoad:function(){this.lp=MWF.QueryLP;this.currentContentNode=null},loadApplication:function(t){if(!this.restActions)this.restActions=MWF.Actions.get("x_query_assemble_designer");this.category=null;this.applications=[];this.deleteElements=[];this.createNode();this.loadApplicationContent();if(t)t()},loadApplicationByCategory:function(t){var e="";if(t){e=t.retrieve("categoryName","")}this.restActions.listApplicationSummary(e,function(t){debugger;this.applicationContentNode.empty();if(t.data.length){t.data.each(function(t){var e=new MWF.xApplication.query.QueryExplorer.Query(this,t);e.load();this.applications.push(e)}.bind(this))}else{if(MWF.AC.isProcessPlatformCreator()){var e=new Element("div",{styles:this.css.noApplicationNode,text:this.options.tooltip.noApplicationCreate}).inject(this.applicationContentNode);e.addEvent("click",function(){this.createApplication()}.bind(this))}else{var e=new Element("div",{styles:this.css.noApplicationNode,text:this.options.tooltip.noApplication}).inject(this.applicationContentNode)}}}.bind(this))},importApplication:function(t){MWF.xDesktop.requireApp("query.QueryExplorer","Importer",function(){new MWF.xApplication.query.QueryExplorer.Importer(this,t).load()}.bind(this))},okCreateApplication:function(t){var e={name:$("createApplicationName").get("value"),alias:$("createApplicationAlias").get("value"),description:$("createApplicationDescription").get("value"),portalCategory:$("createApplicationType").get("value")};if(e.name){this.restActions.saveApplication(e,function(t){this.applicationCreateMarkNode.destroy();this.applicationCreateAreaNode.destroy();this.restActions.getApplication(t.data.id,function(t){t.data.processList=[];t.data.formList=[];var e=new MWF.xApplication.query.QueryExplorer.Query(this,t.data,{where:"top"});e.load();this.applications.push(e)}.bind(this));this.notice(this.options.tooltip.createApplicationSuccess,"success")}.bind(this))}else{$("createApplicationName").setStyle("border-color","red");$("createApplicationName").focus();this.notice(this.options.tooltip.inputApplicationName,"error")}},createCategoryNodes:function(){this.restActions.listApplicationCategory(function(t){var e=null;t.data.each(function(t){if(t.name){this.createCategoryItemNode(t.name,t.count)}else{e=t}}.bind(this))}.bind(this))},deleteSelectedElements:function(t){var a=this;var e=[];this.deleteElements.each(function(t){e.push(t.data.name)});var i=this.lp.application.deleteElementsConfirm+" ("+e.join("、")+") ";this.confirm("infor",t,this.lp.application.deleteElementsTitle,{html:i},530,210,function(){i=a.lp.application.deleteElementsConfirmAgain+"<br/><br/><font style='color:red; font-size:14px; font-weight: bold'>"+e.join("、")+"</font>";this.close();a.confirm("infor",t,a.lp.application.deleteElementsTitle,{html:i},500,200,function(){var i=[];var e=0;var t=a.deleteElements.length;var n="";var o=function(){if(e==t){if(n){a.app.notice(n,"error")}}};a.deleteElements.each(function(t){t["delete"]("",function(){i.push(t);e++;if(a.deleteElements.length==e){a.deleteElements=a.deleteElements.filter(function(t,e){return!i.contains(t)});a.checkDeleteApplication()}o()},function(t){n=n?n+"<br/><br/>"+t:t;e++;if(a.deleteElements.length==e){a.deleteElements=a.deleteElements.filter(function(t,e){return!i.contains(t)});a.checkDeleteApplication()}o()})});this.close()},function(){this.close()});this.close()},function(){this.close()})}});MWF.xApplication.query.QueryExplorer.Query=new Class({Extends:MWF.xApplication.process.ApplicationExplorer.Application,Implements:[Options,Events],options:{where:"bottom",bgColor:["#30afdc","#e9573e","#8dc153","#9d4a9c","#ab8465","#959801","#434343","#ffb400","#9e7698","#00a489"]},load:function(){this.node=new Element("div",{styles:this.css.applicationItemNode});this.loadTopNode();this.loadIconNode();this.loadDeleteAction();this.loadExportAction();this.loadTitleNode();this.loadNewNode();this.loadInforNode();this.loadViewNode();this.loadStatNode();this.node.inject(this.container,this.options.where)},loadIconNode:function(){this.iconNode=new Element("div",{styles:this.css.applicationItemIconNode}).inject(this.topNode);if(this.data.icon){this.iconNode.setStyle("background-image","url(data:image/png;base64,"+this.data.icon+")")}else{this.iconNode.setStyle("background-image","url("+"/x_component_query_QueryExplorer/$Main/default/icon/application.png)")}this.iconNode.makeLnk({par:this._getLnkPar()})},exportApplication:function(){MWF.xDesktop.requireApp("query.QueryExplorer","Exporter",function(){new MWF.xApplication.query.QueryExplorer.Exporter(this.app,this.data).load()}.bind(this))},_deleteElement:function(t,e,i,n){this.app.restActions.deleteApplication(t,i,n)},_getLnkPar:function(){var t="/x_component_query_QueryExplorer/$Main/default/lnk.png";if(this.data.icon)t="data:image/png;base64,"+this.data.icon;var e="query.QueryManager"+this.data.id;return{icon:t,title:this.data.name,par:'query.QueryManager#{"application": "'+this.data.id+'", "appId": "'+e+'"}'}},loadViewNode:function(){this.viewNode=new Element("div",{styles:this.css.applicationItemElNode}).inject(this.inforNode);this.viewTitleNode=new Element("div",{styles:this.css.applicationItemElTitleNode,text:this.app.lp.view}).inject(this.inforNode);this.viewListNode=new Element("div",{styles:this.css.applicationItemElListNode}).inject(this.inforNode);this.loadViewList()},loadViewList:function(){if(this.data.viewList&&this.data.viewList.length){for(var t=0;t<4..min(this.data.viewList.length);t++){var e=this.data.viewList[t];var i=new Element("div",{styles:this.css.listItemNode,text:e.name}).inject(this.viewListNode);i.store("viewId",e.id);var n=this;i.addEvents({click:function(t){n.openView(this,t)},mouseover:function(){this.setStyle("color","#3c5eed")},mouseout:function(){this.setStyle("color","#666")}})}}else{var o=new Element("div",{text:this.app.options.tooltip.noView,styles:{cursor:"pointer","line-height":"30px"}}).inject(this.viewListNode);o.addEvent("click",function(t){this.createNewView(t)}.bind(this))}},openView:function(t,e){var i=t.retrieve("viewId");if(i){var n=this;var o={onQueryLoad:function(){this.actions=n.app.actions;this.options.id=i;this.application=n.data}};this.app.desktop.openApplication(e,"query.ViewDesigner",o)}},loadStatNode:function(){this.statNode=new Element("div",{styles:this.css.applicationItemElNode}).inject(this.inforNode);this.statTitleNode=new Element("div",{styles:this.css.applicationItemElTitleNode,text:this.app.lp.stat}).inject(this.inforNode);this.statListNode=new Element("div",{styles:this.css.applicationItemElListNode}).inject(this.inforNode);this.loadStatList()},loadStatList:function(){if(this.data.statList&&this.data.statList.length){for(var t=0;t<4..min(this.data.statList.length);t++){var e=this.data.statList[t];var i=new Element("div",{styles:this.css.listItemNode,text:e.name}).inject(this.statListNode);i.store("statId",e.id);var n=this;i.addEvents({click:function(t){n.openStat(this,t)},mouseover:function(){this.setStyle("color","#3c5eed")},mouseout:function(){this.setStyle("color","#666")}})}}else{var o=new Element("div",{text:this.app.options.tooltip.noStat,styles:{cursor:"pointer","line-height":"30px"}}).inject(this.statListNode);o.addEvent("click",function(t){this.createNewStat(t)}.bind(this))}},openStat:function(t,e){var i=t.retrieve("statId");if(i){var n=this;var o={onQueryLoad:function(){this.actions=n.app.actions;this.options.id=i;this.application=n.data}};this.app.desktop.openApplication(e,"query.StatDesigner",o)}},createNewView:function(t){this.openApplication(t,0)},createNewStat:function(t){this.openApplication(t,1)},openApplication:function(t,e){var i="query.QueryManager"+this.data.id;if(this.app.desktop.apps[i]){this.app.desktop.apps[i].setCurrent()}else{this.app.desktop.openApplication(t,"query.QueryManager",{application:this.data,appId:i,onQueryLoad:function(){this.status={navi:e||null}}})}},openApplication:function(t,e){var i="portal.PortalManager"+this.data.id;if(this.app.desktop.apps[i]){this.app.desktop.apps[i].setCurrent()}else{this.app.desktop.openApplication(t,"query.QueryManager",{application:this.data,appId:i,onQueryLoad:function(){this.status={navi:e||null}}})}},loadDateNode:function(){this.dateNode=new Element("div",{styles:this.css.applicationItemDateNode,text:this.data.updateTime}).inject(this.inforNode)}});