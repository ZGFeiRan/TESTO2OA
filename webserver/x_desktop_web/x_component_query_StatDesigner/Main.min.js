MWF.xDesktop.requireApp("query.ViewDesigner","",null,false);MWF.APPDSTD=MWF.xApplication.query.StatDesigner;MWF.APPDSTD.options={multitask:true,executable:false};MWF.xDesktop.requireApp("query.StatDesigner","Stat",null,false);MWF.xApplication.query.StatDesigner.Main=new Class({Extends:MWF.xApplication.query.ViewDesigner.Main,Implements:[Options,Events],options:{style:"default",name:"query.StatDesigner",icon:"icon.png",title:MWF.APPDSTD.LP.title,appTitle:MWF.APPDSTD.LP.title,id:"",tooltip:{unCategory:MWF.APPDSTD.LP.unCategory},actions:null,category:null,processData:null},onQueryLoad:function(){this.shortcut=true;if(this.status){this.options.application=this.status.applicationId;this.application=this.status.application;this.options.id=this.status.id}if(!this.options.id){this.options.desktopReload=false;this.options.title=this.options.title+"-"+MWF.APPDSTD.LP.newStat}if(!this.actions)this.actions=MWF.Actions.get("x_query_assemble_designer");this.lp=MWF.xApplication.query.StatDesigner.LP;this.addEvent("queryClose",function(t){if(this.explorer){this.explorer.reload()}}.bind(this));this.addEvent("postLoadWindowMax",function(t){this.loadWindowOk=true;if(this.loadApplicationOk&&this.loadWindowOk)this.view.setViewWidth()}.bind(this));this.addEvent("postLoadApplication",function(t){this.loadApplicationOk=true;if(this.loadApplicationOk&&this.loadWindowOk)this.view.setViewWidth()}.bind(this))},loadViewList:function(){this.actions.listStat(this.application.id,function(t){t.data.each(function(t){this.createListViewItem(t)}.bind(this))}.bind(this),null,false)},createListViewItem:function(t,i){var e=this;var s=new Element("div",{styles:this.css.listViewItem}).inject(this.viewListAreaNode,i?"top":"bottom");var n=new Element("div",{styles:this.css.listViewItemIcon}).inject(s);var a=new Element("div",{styles:this.css.listViewItemText,text:t.name?t.name+" ("+t.alias+")":this.lp.newStat}).inject(s);s.store("view",t);s.addEvents({dblclick:function(t){e.loadViewByData(this,t)},mouseover:function(){if(e.currentListViewItem!=this)this.setStyles(e.css.listViewItem_over)},mouseout:function(){if(e.currentListViewItem!=this)this.setStyles(e.css.listViewItem)}})},loadViewByData:function(t,i){var e=t.retrieve("view");if(openNew){var s=this;var n={onQueryLoad:function(){this.actions=s.actions;this.category=s;this.options.id=e.id;this.application=s.application;this.explorer=s.explorer}};this.desktop.openApplication(i,"query.StatDesigner",n)}},loadView:function(){this.getViewData(this.options.id,function(t){this.setTitle(this.options.appTitle+"-"+t.name);this.taskitem.setText(this.options.appTitle+"-"+t.name);this.options.appTitle=this.options.appTitle+"-"+t.name;this.view=new MWF.xApplication.query.StatDesigner.Stat(this,t);this.view.load()}.bind(this))},loadNewViewData:function(e){var t="/x_component_query_StatDesigner/$Stat/stat.json";MWF.getJSON(t,{onSuccess:function(i){this.actions.getUUID(function(t){i.id=t;i.isNewView=true;i.application=this.application.id;this.createListViewItem(i,true);if(e)e(i)}.bind(this))}.bind(this),onerror:function(t){this.notice(t,"error")}.bind(this),onRequestFailure:function(t){this.notice(t.responseText,"error")}.bind(this)})},loadViewData:function(t,e){this.actions.getStat(t,function(t){if(t){var i=t.data;i.data=JSON.decode(i.data);if(!this.application){this.actions.getApplication(i.application,function(t){this.application={name:t.data.name,id:t.data.id};if(e)e(i)}.bind(this))}else{if(e)e(i)}}}.bind(this))},saveView:function(){this.view.save(function(){var t=this.view.data.name;this.setTitle(MWF.APPDSTD.LP.title+"-"+t);this.options.desktopReload=true;this.options.id=this.view.data.id}.bind(this))},saveViewAs:function(){this.view.saveAs()},dictionaryExplode:function(){this.view.explode()},dictionaryImplode:function(){this.view.implode()}});MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xApplication.query.StatDesigner.Stat.NewNameForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"design",width:700,height:"300",hasTop:true,hasIcon:false,draggable:true,title:MWF.xApplication.query.StatDesigner.LP.copyStat},_createTableContent:function(){var t="<table width='80%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin: 20px auto 0px auto; '>"+"<tr><td styles='formTableTitle' lable='selectQuery' width='25%'></td>"+"    <td styles='formTableValue' item='selectQuery' colspan='3' width='75%'></td></tr>"+"<tr><td styles='formTableTitle' lable='view'></td>"+"    <td styles='formTableValue' item='view' colspan='3'></td></tr>"+"<tr><td styles='formTableTitle' lable='name'></td>"+"    <td styles='formTableValue' item='name' colspan='3'></td></tr>"+"</table>";this.formTableArea.set("html",t);MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data||{},{isEdited:true,style:"cms",hasColon:true,itemTemplate:{selectQuery:{text:MWF.xApplication.query.StatDesigner.LP.application,type:"org",orgType:"Query",defaultValue:this.data.queryName,orgWidgetOptions:{canRemove:false},event:{change:function(){this.form.getItem("view").resetItemOptions(this.getViewIdList(),this.getViewNameList())}.bind(this)}},view:{text:MWF.xApplication.query.StatDesigner.LP.view,type:"select",selectValue:function(){return this.getViewIdList()}.bind(this),selectText:function(){return this.getViewNameList()}.bind(this)},name:{text:MWF.xApplication.query.StatDesigner.LP.name,notEmpty:true}}},this.app);this.form.load()}.bind(this),null,true)},getViewIdList:function(){return this.getViews().idList},getViewNameList:function(){return this.getViews().nameList},getViews:function(){var t;var i=this.form.getItem("selectQuery").orgObject;if(i&&i.length>0){var e=i[0].data;t=e.id}else{t=this.data.query}var s=[];var n=[];MWF.Actions.get("x_query_assemble_designer").listView(t,function(t){t.data.each(function(t){s.push(t.id);n.push(t.name)})}.bind(this),null,false);return{idList:s,nameList:n}},ok:function(){var t=this.form.getResult(true,null,true,false,true);if(t){var i=this.form.getItem("selectQuery").orgObject;if(i&&i.length>0){var e=i[0].data;t.query=e.id;t.queryName=e.name}else{}this.fireEvent("save",[t,function(){this.close()}.bind(this)])}}});