MWF.xApplication.query.ViewDesigner=MWF.xApplication.query.ViewDesigner||{};MWF.APPDVD=MWF.xApplication.query.ViewDesigner;MWF.APPDVD.options={multitask:true,executable:false};MWF.xDesktop.requireApp("query.ViewDesigner","View",null,false);MWF.xApplication.query.ViewDesigner.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"query.ViewDesigner",icon:"icon.png",title:MWF.APPDVD.LP.title,appTitle:MWF.APPDVD.LP.title,id:"",tooltip:{unCategory:MWF.APPDVD.LP.unCategory},actions:null,category:null,processData:null},onQueryLoad:function(){this.shortcut=true;if(this.status){this.options.application=this.status.applicationId;this.application=this.status.application;this.options.id=this.status.id}if(!this.options.id){this.options.desktopReload=false;this.options.title=this.options.title+"-"+MWF.APPDVD.LP.newView}if(!this.actions)this.actions=MWF.Actions.get("x_query_assemble_designer");this.lp=MWF.xApplication.query.ViewDesigner.LP;this.addEvent("queryClose",function(t){if(this.explorer){this.explorer.reload()}}.bind(this));this.addEvent("postLoadWindowMax",function(t){this.loadWindowOk=true;if(this.loadApplicationOk&&this.loadWindowOk){this.view.setViewWidth()}}.bind(this));this.addEvent("postLoadApplication",function(t){this.loadApplicationOk=true;if(this.loadApplicationOk&&this.loadWindowOk){this.view.setViewWidth()}}.bind(this))},loadApplication:function(t){this.createNode();if(!this.options.isRefresh){this.maxSize(function(){this.openView(function(){if(t)t()})}.bind(this))}else{this.openView(function(){if(t)t()})}if(!this.options.readMode)this.addKeyboardEvents()},addKeyboardEvents:function(){this.addEvent("copy",function(){this.copyModule()}.bind(this));this.addEvent("paste",function(){this.pasteModule()}.bind(this));this.addEvent("cut",function(){this.cutModule()}.bind(this));this.addEvent("keySave",function(t){this.keySave(t)}.bind(this));this.addEvent("keyDelete",function(t){this.keyDelete(t)}.bind(this))},keySave:function(t){if(this.shortcut){this.view.save();t.preventDefault()}},keyDelete:function(){if(this.shortcut){if(this.view.currentSelectedModule){var t=this.view.currentSelectedModule;t["delete"]()}}},copyModule:function(){if(this.shortcut){if(this.view.currentSelectedModule){var t=this.view.currentSelectedModule;MWF.clipboard.data={type:"view",data:t.json}}}},cutModule:function(){if(this.shortcut){if(this.view.currentSelectedModule){this.copyModule();var t=this.view.currentSelectedModule;t.destroy()}}},pasteModule:function(){if(this.shortcut){if(MWF.clipboard.data){if(MWF.clipboard.data.type=="view"){if(this.view.currentSelectedModule){var t=this.view.currentSelectedModule;var e=MWF.clipboard.data.data;t.addColumn(null,e)}}}}},createNode:function(){this.content.setStyle("overflow","hidden");this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},getApplication:function(e){if(!this.application){this.actions.getApplication(this.options.application,function(t){this.application={name:t.data.name,id:t.data.id};if(e)e()}.bind(this))}else{if(e)e()}},openView:function(t){this.getApplication(function(){this.initOptions();this.loadNodes();this.loadViewListNodes();this.loadContentNode();this.loadProperty();this.resizeNode();this.addEvent("resize",this.resizeNode.bind(this));this.loadView(function(){if(t)t()});this.setScrollBar(this.propertyDomArea,null,{V:{x:0,y:0},H:{x:0,y:0}})}.bind(this))},initOptions:function(){},loadNodes:function(){this.viewListNode=new Element("div",{styles:this.css.viewListNode}).inject(this.node);this.propertyNode=new Element("div",{styles:this.css.propertyNode}).inject(this.node);this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node)},loadViewListNodes:function(){this.viewListTitleNode=new Element("div",{styles:this.css.viewListTitleNode,text:MWF.APPDVD.LP.view}).inject(this.viewListNode);this.viewListResizeNode=new Element("div",{styles:this.css.viewListResizeNode}).inject(this.viewListNode);this.viewListAreaSccrollNode=new Element("div",{styles:this.css.viewListAreaSccrollNode}).inject(this.viewListNode);this.viewListAreaNode=new Element("div",{styles:this.css.viewListAreaNode}).inject(this.viewListAreaSccrollNode);this.loadViewListResize();this.loadViewList()},loadViewListResize:function(){this.viewListResize=new Drag(this.viewListResizeNode,{snap:1,onStart:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var o=Browser.name=="firefox"?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.viewListAreaSccrollNode.getSize();t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var o=this.content.getSize();var s=t.retrieve("position");var n=t.retrieve("initialWidth").toFloat();var a=i.toFloat()-s.x.toFloat();var r=n+a;if(r>o.x/2)r=o.x/2;if(r<40)r=40;this.contentNode.setStyle("margin-left",r+1);this.viewListNode.setStyle("width",r);this.view.setViewWidth()}.bind(this)});this.viewListResizeNode.addEvents({touchstart:function(t){el=t.target;var e=Browser.name=="firefox"?t.page.clientX:t.page.x;var i=Browser.name=="firefox"?t.page.clientY:t.page.y;el.store("position",{x:e,y:i});var o=this.viewListAreaSccrollNode.getSize();el.store("initialWidth",o.x)}.bind(this),touchmove:function(t){el=t.target;var e=Browser.name=="firefox"?t.page.clientX:t.page.x;var i=this.content.getSize();var o=el.retrieve("position");var s=el.retrieve("initialWidth").toFloat();var n=e.toFloat()-o.x.toFloat();var a=s+n;if(a>i.x/2)a=i.x/2;if(a<40)a=40;this.contentNode.setStyle("margin-left",a+1);this.viewListNode.setStyle("width",a);this.view.setViewWidth()}.bind(this)})},loadViewList:function(){this.actions.listView(this.application.id,function(t){t.data.each(function(t){this.createListViewItem(t)}.bind(this))}.bind(this),null,false)},createListViewItem:function(t,e){var i=this;var o=new Element("div",{styles:this.css.listViewItem}).inject(this.viewListAreaNode,e?"top":"bottom");var s=new Element("div",{styles:this.css.listViewItemIcon}).inject(o);var n=new Element("div",{styles:this.css.listViewItemText,text:t.name?t.name+" ("+t.alias+")":this.lp.newView}).inject(o);o.store("view",t);o.addEvents({dblclick:function(t){i.loadViewByData(this,t)},mouseover:function(){if(i.currentListViewItem!=this)this.setStyles(i.css.listViewItem_over)},mouseout:function(){if(i.currentListViewItem!=this)this.setStyles(i.css.listViewItem)}})},loadViewByData:function(t,e){var i=t.retrieve("view");var o=true;if(o){var s=this;var n={onQueryLoad:function(){this.actions=s.actions;this.category=s;this.options.id=i.id;this.application=s.application;this.explorer=s.explorer}};this.desktop.openApplication(e,"query.ViewDesigner",n)}},loadContentNode:function(){this.contentToolbarNode=new Element("div#contentToolbarNode",{styles:this.css.contentToolbarNode}).inject(this.contentNode);if(!this.options.readMode)this.loadContentToolbar();this.editContentNode=new Element("div",{styles:this.css.editContentNode}).inject(this.contentNode);this.loadEditContent(function(){if(this.designNode)this.designNode.setStyles(this.css.designNode)}.bind(this))},loadContentToolbar:function(i){this.getFormToolbarHTML(function(t){var e=t.getElements("span");e.each(function(t,e){var i=t.get("MWFButtonImage");if(i){t.set("MWFButtonImage",this.path+""+this.options.style+"/toolbar/"+i)}}.bind(this));$(t).inject(this.contentToolbarNode);MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(t,{style:"ProcessCategory"},this);this.toolbar.load();if(i)i()}.bind(this))}.bind(this))},getFormToolbarHTML:function(n){var t=this.path+this.options.style+"/toolbars.html";var e=new Request.HTML({url:t,method:"get",onSuccess:function(t,e,i,o){var s=t[0];if(n)n(s)}.bind(this),onFailure:function(t){this.notice("request processToolbars error: "+t.responseText,"error")}.bind(this)});e.send()},maxOrReturnEditor:function(){if(!this.isMax){this.designNode.inject(this.node);this.designNode.setStyles({position:"absolute",width:"100%",height:"100%",top:"0px",margin:"0px",left:"0px"});this.view.setAreaNodeSize();this.isMax=true}else{this.isMax=false;this.designNode.inject(this.editContentNode);this.designNode.setStyles(this.css.designNode);this.designNode.setStyles({position:"static"});this.resizeNode();this.view.setAreaNodeSize()}},loadEditContent:function(t){this.designNode=new Element("div",{styles:this.css.designNode}).inject(this.editContentNode)},loadProperty:function(){this.propertyTitleNode=new Element("div",{styles:this.css.propertyTitleNode,text:MWF.APPDVD.LP.property}).inject(this.propertyNode);this.propertyResizeBar=new Element("div",{styles:this.css.propertyResizeBar}).inject(this.propertyNode);this.loadPropertyResize();this.propertyContentNode=new Element("div",{styles:this.css.propertyContentNode}).inject(this.propertyNode);this.propertyDomArea=new Element("div",{styles:this.css.propertyDomArea}).inject(this.propertyContentNode);this.propertyDomPercent=.3;this.propertyContentResizeNode=new Element("div",{styles:this.css.propertyContentResizeNode}).inject(this.propertyContentNode);this.propertyContentArea=new Element("div",{styles:this.css.propertyContentArea}).inject(this.propertyContentNode);this.loadPropertyContentResize();this.propertyNode.addEvent("keydown",function(t){t.stopPropagation()})},loadPropertyResize:function(){this.propertyResize=new Drag(this.propertyResizeBar,{snap:1,onStart:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var o=Browser.name=="firefox"?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.propertyNode.getSize();t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var o=this.content.getSize();var s=t.retrieve("position");var n=t.retrieve("initialWidth").toFloat();var a=s.x.toFloat()-i.toFloat();var r=n+a;if(r>o.x/2)r=o.x/2;if(r<40)r=40;this.contentNode.setStyle("margin-right",r+1);this.propertyNode.setStyle("width",r);this.view.setViewWidth()}.bind(this)})},loadPropertyContentResize:function(){this.propertyContentResize=new Drag(this.propertyContentResizeNode,{snap:1,onStart:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var o=Browser.name=="firefox"?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.propertyDomArea.getSize();t.store("initialHeight",s.y)}.bind(this),onDrag:function(t,e){var i=this.propertyContentNode.getSize();var o=Browser.name=="firefox"?e.event.clientY:e.event.y;var s=t.retrieve("position");var n=o.toFloat()-s.y.toFloat();var a=t.retrieve("initialHeight").toFloat();var r=a+n;if(r<40)r=40;if(r>i.y-40)r=i.y-40;this.propertyDomPercent=r/i.y;this.setPropertyContentResize()}.bind(this)})},setPropertyContentResize:function(){var t=this.propertyContentNode.getSize();var e=this.propertyContentResizeNode.getSize();var i=t.y-e.y;var o=this.propertyDomPercent*i;var s=i-o;this.propertyDomArea.setStyle("height",""+o+"px");this.propertyContentArea.setStyle("height",""+s+"px");if(this.view){if(this.view.currentSelectedModule){if(this.view.currentSelectedModule.property){var n=this.view.currentSelectedModule.property.propertyTab;if(n){var a=n.tabNodeContainer.getSize();n.pages.each(function(t){var e=t.contentNodeArea.getStyle("margin-top").toFloat();var i=t.contentNodeArea.getStyle("margin-bottom").toFloat();var o=s-e-i-a.y.toFloat()-15;t.contentNodeArea.setStyle("height",o)}.bind(this))}}}}},resizeNode:function(){var t=this.node.getSize();this.contentNode.setStyle("height",""+t.y+"px");this.propertyNode.setStyle("height",""+t.y+"px");var e=this.contentToolbarNode.getStyle("margin-top").toFloat();var i=this.contentToolbarNode.getStyle("margin-bottom").toFloat();var o=this.contentToolbarNode.getComputedSize();var s=t.y-o.totalHeight-e-i;this.editContentNode.setStyle("height",""+s+"px");if(this.designNode){var n=this.designNode.getStyle("margin-top").toFloat();var a=this.designNode.getStyle("margin-bottom").toFloat();s=t.y-o.totalHeight-e-i-n-a;this.designNode.setStyle("height",""+s+"px")}titleSize=this.propertyTitleNode.getSize();titleMarginTop=this.propertyTitleNode.getStyle("margin-top").toFloat();titleMarginBottom=this.propertyTitleNode.getStyle("margin-bottom").toFloat();titlePaddingTop=this.propertyTitleNode.getStyle("padding-top").toFloat();titlePaddingBottom=this.propertyTitleNode.getStyle("padding-bottom").toFloat();s=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom;s=t.y-s;this.propertyContentNode.setStyle("height",""+s+"px");this.propertyResizeBar.setStyle("height",""+s+"px");this.setPropertyContentResize();titleSize=this.viewListTitleNode.getSize();titleMarginTop=this.viewListTitleNode.getStyle("margin-top").toFloat();titleMarginBottom=this.viewListTitleNode.getStyle("margin-bottom").toFloat();titlePaddingTop=this.viewListTitleNode.getStyle("padding-top").toFloat();titlePaddingBottom=this.viewListTitleNode.getStyle("padding-bottom").toFloat();nodeMarginTop=this.viewListAreaSccrollNode.getStyle("margin-top").toFloat();nodeMarginBottom=this.viewListAreaSccrollNode.getStyle("margin-bottom").toFloat();s=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom+nodeMarginTop+nodeMarginBottom;s=t.y-s;this.viewListAreaSccrollNode.setStyle("height",""+s+"px");this.viewListResizeNode.setStyle("height",""+s+"px")},loadView:function(e){this.getViewData(this.options.id,function(t){this.setTitle(this.options.appTitle+"-"+t.name);this.taskitem.setText(this.options.appTitle+"-"+t.name);this.options.appTitle=this.options.appTitle+"-"+t.name;this.view=new MWF.xApplication.query.ViewDesigner.View(this,t);this.view.load();if(e)e()}.bind(this))},getViewData:function(t,e){if(!this.options.id){this.loadNewViewData(e)}else{this.loadViewData(t,e)}},loadNewViewData:function(i){var t="/x_component_query_ViewDesigner/$View/view.json";MWF.getJSON(t,{onSuccess:function(e){this.actions.getUUID(function(t){e.id=t;e.isNewView=true;e.application=this.application.id;this.createListViewItem(e,true);if(i)i(e)}.bind(this))}.bind(this),onerror:function(t){this.notice(t,"error")}.bind(this),onRequestFailure:function(t){this.notice(t.responseText,"error")}.bind(this)})},loadViewData:function(t,o){this.actions.getView(t,function(t){if(t){var e=t.data;var i=JSON.decode(e.data);e.data=i;if(!this.application){this.actions.getApplication(e.application,function(t){this.application={name:t.data.name,id:t.data.id};if(o)o(e)}.bind(this))}else{if(o)o(e)}}}.bind(this))},saveView:function(){this.view.save(function(){var t=this.view.data.name;this.setTitle(MWF.APPDVD.LP.title+"-"+t);this.options.desktopReload=true;this.options.id=this.view.data.id}.bind(this))},saveViewAs:function(){this.view.saveAs()},dictionaryExplode:function(){this.view.explode()},dictionaryImplode:function(){this.view.implode()},recordStatus:function(){var t=[];t.push(this.view.data.id);var e=this.view.data.id;return{id:this.options.id,application:this.application,openViews:t,currentId:e}}});MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xApplication.query.ViewDesigner.View.NewNameForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"design",width:700,height:"260",hasTop:true,hasIcon:false,draggable:true,title:MWF.xApplication.query.ViewDesigner.LP.newView},_createTableContent:function(){var t="<table width='80%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin: 20px auto 0px auto; '>"+"<tr><td styles='formTableTitle' lable='selectQuery' width='25%'></td>"+"    <td styles='formTableValue' item='selectQuery' colspan='3' width='75%'></td></tr>"+"<tr><td styles='formTableTitle' lable='name'></td>"+"    <td styles='formTableValue' item='name' colspan='3'></td></tr>"+"</table>";this.formTableArea.set("html",t);MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data||{},{isEdited:true,style:"cms",hasColon:true,itemTemplate:{selectQuery:{text:MWF.xApplication.query.ViewDesigner.LP.application,type:"org",orgType:"Query",defaultValue:this.data.queryName,orgWidgetOptions:{canRemove:false}},name:{text:MWF.xApplication.query.ViewDesigner.LP.name,notEmpty:true}}},this.app);this.form.load()}.bind(this),null,true)},ok:function(){var t=this.form.getResult(true,null,true,false,true);if(t){var e=this.form.getItem("selectQuery").orgObject;if(e&&e.length>0){var i=e[0].data;t.query=i.id;t.queryName=i.name}else{}this.fireEvent("save",[t,function(){this.close()}.bind(this)])}}});