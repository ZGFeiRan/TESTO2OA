MWF.widget=MWF.widget||{};MWF.widget.AttachmentController=MWF.widget.ATTER=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",listStyle:"icon",size:"max",resize:true,attachmentCount:0,isUpload:true,isDelete:true,isReplace:true,isDownload:true,isSizeChange:true,readonly:false,images:["bmp","gif","png","jpeg","jpg","jpe","ico"],audios:["mp3","wav","wma","wmv"],videos:["avi","mkv","mov","ogg","mp4","mpa","mpe","mpeg","mpg","rmvb"]},initialize:function(t,e,i){this.setOptions(i);this.pages=[];this.path=MWF.defaultPath+"/widget/$AttachmentController/";this.cssPath=MWF.defaultPath+"/widget/$AttachmentController/"+this.options.style+"/css.wcss";this._loadCss();MWF.getJSON("/x_component_File/$Main/icon.json",function(t){this.icons=t}.bind(this),false,false);this.module=e;this.actions=[];this.attachments=[];this.selectedAttachments=[];this.container=$(t)},load:function(){if(this.options.size==="min"){this.loadMin()}else{this.loadMax()}},loadMax:function(){if(!this.node)this.node=new Element("div",{styles:this.css.container});if(!this.topNode){this.createTopNode();this.createContentNode();if(this.options.resize){this.createBottomNode();this.createResizeNode()}this.node.inject(this.container);this.checkActions();this.setEvent()}else{this.contentScrollNode.setStyle("display","block");if(this.bottomNode)this.bottomNode.setStyle("display","block");if(this.titleNode)this.titleNode.setStyle("display","block");this.topNode.setStyle("display","block");this.content.empty()}var t=[];while(this.attachments.length){var e=this.attachments.shift();t.push(new MWF.widget.AttachmentController.Attachment(e.data,this))}this.attachments=t},loadMin:function(){if(!this.node)this.node=new Element("div",{styles:this.css.container_min});if(!this.minActionAreaNode){this.minActionAreaNode=new Element("div",{styles:this.css.minActionAreaNode}).inject(this.node);this.minContent=new Element("div",{styles:this.css.minContentNode}).inject(this.node);this.loadMinActions();this.node.inject(this.container);this.checkActions();this.setEvent()}else{this.minActionAreaNode.setStyle("display","block");this.minContent.setStyle("display","block");this.minContent.empty()}var t=[];while(this.attachments.length){var e=this.attachments.shift();t.push(new MWF.widget.AttachmentController.AttachmentMin(e.data,this))}this.attachments=t},loadMinActions:function(){this.min_uploadAction=this.createAction(this.minActionAreaNode,"upload",MWF.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this));this.min_deleteAction=this.createAction(this.minActionAreaNode,"delete",MWF.LP.widget["delete"],function(t,e){this.deleteAttachment(t,e)}.bind(this));this.min_replaceAction=this.createAction(this.minActionAreaNode,"replace",MWF.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this));this.min_downloadAction=this.createAction(this.minActionAreaNode,"download",MWF.LP.widget.download,function(t,e){this.downloadAttachment(t,e)}.bind(this));this.createSeparate(this.minActionAreaNode);this.sizeAction=this.createAction(this.minActionAreaNode,"max",MWF.LP.widget.min,function(){this.changeControllerSize()}.bind(this))},setEvent:function(){if(this.contentScrollNode)this.contentScrollNode.addEvents({mousedown:this.unSelectedAttachments.bind(this)});if(this.minContent)this.minContent.addEvents({mousedown:this.unSelectedAttachments.bind(this)})},createContentNode:function(){this.contentScrollNode=new Element("div.contentScrollNode",{styles:this.css.contentScrollNode}).inject(this.node);this.content=new Element("div.content",{styles:this.css.contentNode}).inject(this.contentScrollNode);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.contentScrollNode,{style:"attachment",where:"before",distance:30,friction:4,axis:{x:false,y:true}})}.bind(this))},createBottomNode:function(){this.bottomNode=new Element("div",{styles:this.css.bottomNode}).inject(this.node)},createResizeNode:function(){this.resizeNode=new Element("div",{styles:this.css.resizeNode}).inject(this.bottomNode);this.resizeDrag=new Drag(this.resizeNode,{snap:"2",onStart:function(t,e){t.store("startY",e.event.y);t.store("nodeHeight",this.node.getSize().y);if(!this.nodeHeight){this.nodeHeight=this.node.getStyle("min-height").toFloat()}}.bind(this),onDrag:function(t,e){var i=t.retrieve("startY");var s=t.retrieve("nodeHeight");var n=e.event.y-i+s;if(n<this.nodeHeight)n=this.nodeHeight;var o=n-50;this.node.setStyle("height",""+n+"px");this.contentScrollNode.setStyle("height",""+o+"px")}.bind(this)})},createTopNode:function(){if(this.options.title){if(!this.titleNode)this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.options.title}).inject(this.node)}this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node);this.createEditGroupActions();this.createReadGroupActions();this.createListGroupActions();this.createViewGroupActions()},createEditGroupActions:function(){this.editActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode);this.editActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.editActionBoxNode);this.uploadAction=this.createAction(this.editActionsGroupNode,"upload",MWF.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this));this.deleteAction=this.createAction(this.editActionsGroupNode,"delete",MWF.LP.widget["delete"],function(t,e){this.deleteAttachment(t,e)}.bind(this));this.replaceAction=this.createAction(this.editActionsGroupNode,"replace",MWF.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this));this.editActionSeparateNode=this.createSeparate(this.editActionsGroupNode)},createReadGroupActions:function(){this.downloadAction=this.createAction(this.editActionsGroupNode,"download",MWF.LP.widget.download,function(){this.downloadAttachment()}.bind(this))},createListGroupActions:function(){this.listActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode);this.listActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.listActionBoxNode);this.listAction=this.createAction(this.listActionsGroupNode,"list",MWF.LP.widget.list,function(){this.changeListStyle("list")}.bind(this));this.iconAction=this.createAction(this.listActionsGroupNode,"icon",MWF.LP.widget.icon,function(){this.changeListStyle("icon")}.bind(this));this.previewAction=this.createAction(this.listActionsGroupNode,"preview",MWF.LP.widget.preview,function(){this.changeListStyle("preview")}.bind(this))},createViewGroupActions:function(){this.viewActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode);this.viewActionBoxNode.setStyles({float:"right","margin-right":"7px"});this.viewActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.viewActionBoxNode);this.sizeAction=this.createAction(this.viewActionsGroupNode,"min",MWF.LP.widget.min,function(){this.changeControllerSize()}.bind(this))},createSeparate:function(t){var e=new Element("div",{styles:this.css.separateNode}).inject(t);return e},createAction:function(t,e,i,s){var n=new Element("div",{styles:this.css.actionNode,title:i}).inject(t);var o=new Element("div",{styles:this.css.actionIconNode}).inject(n);o.setStyle("background-image","url("+MWF.defaultPath+"/widget/$AttachmentController/"+this.options.style+"/icon/"+e+".png)");var c=this;n.addEvents({mouseover:function(){if(!this.retrieve("disabled"))if(!this.retrieve("selected"))this.setStyle("background","url("+MWF.defaultPath+"/widget/$AttachmentController/"+c.options.style+"/overbg.png)")},mouseout:function(){if(!this.retrieve("disabled"))if(!this.retrieve("selected"))this.setStyle("background","transparent")},click:function(t){if(!this.retrieve("disabled"))c.doAction(t,this,s)}});this.actions.push(n);return n},checkActions:function(){this.checkUploadAction();this.checkDeleteAction();this.checkReplaceAction();this.checkDownloadAction();this.checkSizeAction();this.checkListStyleAction()},checkUploadAction:function(){if(this.options.readonly){this.setActionDisabled(this.uploadAction);this.setActionDisabled(this.min_uploadAction);return false}if(!this.options.isUpload){this.setActionDisabled(this.uploadAction);this.setActionDisabled(this.min_uploadAction)}else{if(this.options.attachmentCount!=0){if(this.attachments.length>=this.options.attachmentCount){this.setActionDisabled(this.uploadAction);this.setActionDisabled(this.min_uploadAction)}else{this.setActionEnabled(this.uploadAction);this.setActionEnabled(this.min_uploadAction)}}else{this.setActionEnabled(this.uploadAction);this.setActionEnabled(this.min_uploadAction)}}},checkDeleteAction:function(){if(this.options.readonly){this.setActionDisabled(this.deleteAction);this.setActionDisabled(this.min_deleteAction);return false}if(!this.options.isDelete){this.setActionDisabled(this.deleteAction);this.setActionDisabled(this.min_deleteAction)}else{if(this.selectedAttachments.length){this.setActionEnabled(this.deleteAction);this.setActionEnabled(this.min_deleteAction)}else{this.setActionDisabled(this.deleteAction);this.setActionDisabled(this.min_deleteAction)}}},checkReplaceAction:function(){if(this.options.readonly){this.setActionDisabled(this.replaceAction);this.setActionDisabled(this.min_replaceAction);return false}if(!this.options.isReplace){this.setActionDisabled(this.replaceAction);this.setActionDisabled(this.min_replaceAction)}else{if(this.selectedAttachments.length&&this.selectedAttachments.length==1){this.setActionEnabled(this.replaceAction);this.setActionEnabled(this.min_replaceAction)}else{this.setActionDisabled(this.replaceAction);this.setActionDisabled(this.min_replaceAction)}}},checkDownloadAction:function(){if(!this.options.isDownload){this.setActionDisabled(this.downloadAction);this.setActionDisabled(this.downloadAllAction)}else{if(this.selectedAttachments.length){this.setActionEnabled(this.downloadAction)}else{this.setActionDisabled(this.downloadAction)}this.setActionEnabled(this.downloadAllAction)}},checkSizeAction:function(){if(this.options.isSizeChange){this.setActionEnabled(this.sizeAction)}else{this.setActionDisabled(this.sizeAction)}},checkListStyleAction:function(){switch(this.options.listStyle){case"list":this.setActionSelcted(this.listAction);this.setActionUnSelcted(this.iconAction);this.setActionUnSelcted(this.previewAction);break;case"icon":this.setActionUnSelcted(this.listAction);this.setActionSelcted(this.iconAction);this.setActionUnSelcted(this.previewAction);break;case"preview":this.setActionUnSelcted(this.listAction);this.setActionUnSelcted(this.iconAction);this.setActionSelcted(this.previewAction);break}},setActionSelcted:function(t){if(t){if(!t.retrieve("selected")){t.setStyle("background","url("+MWF.defaultPath+"/widget/$AttachmentController/"+this.options.style+"/selectedbg.png)");t.store("selected",true)}}},setActionUnSelcted:function(t){if(t){if(t.retrieve("selected")){t.setStyle("background","");t.store("selected",false)}}},setActionEnabled:function(t){if(t){if(t.retrieve("disabled")){var e=t.getFirst();var i=e.getStyle("background-image");var s=i.substr(i.lastIndexOf(".")+1,i.length);i=i.substr(0,i.lastIndexOf("_gray"))+"."+s;e.setStyle("background-image",i);t.store("disabled",false)}}},setActionDisabled:function(t){if(t){if(!t.retrieve("disabled")){var e=t.getFirst();var i=e.getStyle("background-image");var s=i.substr(i.lastIndexOf(".")+1,i.length);i=i.substr(0,i.lastIndexOf("."))+"_gray."+s;e.setStyle("background-image",i);t.store("disabled",true)}}},setReadonly:function(){this.actions.each(function(t){this.setActionDisabled(t)}.bind(this))},doAction:function(t,e,i){if(i){i.apply(this,[t,e])}},uploadAttachment:function(t,e){if(this.module)this.module.uploadAttachment(t,e)},doUploadAttachment:function(t,e,i,s,n,o,c,h,d){if(FormData.expiredIE){this.doInputUploadAttachment(t,e,i,s,n,o,c,h,d)}else{this.doFormDataUploadAttachment(t,e,i,s,n,o,c,h,d)}},addUploadMessage:function(t){var e="";e='<div style="overflow: hidden"><div style="height: 2px; border:0px solid #999; margin: 3px 0px">'+'<div style="height: 2px; background-color: #acdab9; width: 0px;"></div></div>'+'<div style="height: 20px; line-height: 20px">'+MWF.LP.desktop.action.uploadTitle+"</div></div>"+"<iframe name='o2_upload_iframe' style='display:none'></iframe>";var i={subject:MWF.LP.desktop.action.uploadTitle,content:t+"<br/>"+e};if(layout.desktop.message){var s=layout.desktop.message.addMessage(i);s.close=function(t,e){if(!s.completed){}else{s.closeItem(t,e)}}}window.setTimeout(function(){if(layout.desktop.message)if(!layout.desktop.message.isShow)layout.desktop.message.show()}.bind(this),300);return s},setMessageTitle:function(t,e){if(t)t.subjectNode.set("text",e)},setMessageText:function(t,e){if(t){var i=t.contentNode.getFirst("div").getFirst("div");var s=i.getFirst("div");var n=t.contentNode.getFirst("div").getLast("div");n.set("text",e);t.dateNode.set("text",(new Date).format("db"))}},doInputUploadAttachment:function(m,t,p,f,u,A,v,e,i){var g=t;if(typeOf(t)=="string"){g=MWF.Actions.get(t).action}g.getActions(function(){var i=g.actions[p];i=g.address+i.uri;Object.each(f,function(t,e){i=i.replace("{"+e+"}",t)});debugger;var e=this.module.content;if(!e){if(this.module.form){e=this.module.form.app.content}}if(!e)e=this.node;if(e){e.mask({style:{opacity:.7,"background-color":"#999"}})}this.inputUploadAreaNode=new Element("div",{styles:this.css.inputUploadAreaNode}).inject(this.container);this.inputUploadAreaNode.position({relativeTo:this.module.content,position:"center"});var s=null;document.O2UploadCallbackFun=function(t){var e=JSON.decode(t);s.completed=true;if(e.type==="success"){if(A)A(e.data);this.setMessageTitle(s,MWF.LP.desktop.action.uploadComplete);this.setMessageText(s,MWF.LP.desktop.action.uploadComplete);if(u)u()}else{this.setMessageTitle(s,MWF.LP.desktop.action.sendError);this.setMessageText(s,MWF.LP.desktop.action.sendError+": "+e.message);MWF.xDesktop.notice("error",{x:"right",y:"top"},e.message)}}.bind(this);var n=new Element("form",{method:"POST",action:i+"/callback/window.frameElement.ownerDocument.O2UploadCallbackFun",enctype:"multipart/form-data",target:"o2_upload_iframe"}).inject(this.inputUploadAreaNode);var t=new Element("div",{styles:this.css.inputUploadAreaTitleNode,text:MWF.LP.widget.uploadTitle}).inject(n);var o=new Element("div",{styles:this.css.inputUploadAreaInforNode,text:MWF.LP.widget.uploadInfor}).inject(n);var c=new Element("div",{styles:this.css.inputUploadAreaInputAreaNode}).inject(n);var h=new Element("input",{name:"file",type:"file",styles:this.css.inputUploadAreaInputNode}).inject(c);var d=new Element("input",{type:"hidden",name:"fileName"}).inject(c);Object.each(m,function(t,e){new Element("input",{type:"hidden",name:e,value:t}).inject(c)});var l=new Element("div",{styles:this.css.inputUploadActionNode}).inject(n);var a=new Element("button",{styles:this.css.inputUploadCancelButton,text:MWF.LP.widget.cancel}).inject(l);var r=new Element("input",{type:"button",styles:this.css.inputUploadOkButton,value:MWF.LP.widget.ok}).inject(l);h.addEvent("change",function(){var t=h.get("value");if(t){var e=t.replace(/\\/g,"/");var i=e.lastIndexOf("/");var s=i===-1?e:e.substr(i+1,e.length-i);d.set("value",s)}}.bind(this));a.addEvent("click",function(){if(e)e.unmask();this.inputUploadAreaNode.destroy()}.bind(this));r.addEvent("click",function(){n.mask({style:{opacity:.7,"background-color":"#999"}});var t=true;if(v)t=v([d.get("value")]);if(t){s=this.addUploadMessage(d.get("value"));n.submit();if(e)e.unmask();if(this.inputUploadAreaNode)this.inputUploadAreaNode.destroy()}}.bind(this))}.bind(this))},doFormDataUploadAttachment:function(l,a,r,m,p,f,u,t,e){if(!this.uploadFileAreaNode){this.uploadFileAreaNode=new Element("div");var i='<input name="file" multiple type="file" accept="*/*"/>';this.uploadFileAreaNode.set("html",i);this.fileUploadNode=this.uploadFileAreaNode.getFirst();this.fileUploadNode.addEvent("change",function(){var t=this.fileUploadNode.files;if(t.length){var e=t.length;var i=0;var s=a;if(typeOf(a)=="string"){s=MWF.Actions.get(a).action}var n=function(){if(i==e){if(p)p()}};var o=true;if(u)o=u(t);if(o){for(var c=0;c<t.length;c++){var h=t.item(c);var d=new FormData;Object.each(l,function(t,e){d.append(e,t)});d.append("file",h);s.invoke({name:r,async:true,data:d,file:h,parameter:m,success:function(t){i++;if(f)f(t,i,e);n()}})}}this.uploadFileAreaNode.destroy();this.uploadFileAreaNode=null}}.bind(this))}this.fileUploadNode.set("accept",e||"*/*");this.fileUploadNode.set("multiple",t!==false);this.fileUploadNode.click()},openInOfficeControl:function(t,e){},deleteAttachment:function(t,e){if(this.selectedAttachments.length){if(this.module)this.module.deleteAttachments(t,e,this.selectedAttachments)}},replaceAttachment:function(t,e){if(this.selectedAttachments.length&&this.selectedAttachments.length==1){if(this.module)this.module.replaceAttachment(t,e,this.selectedAttachments[0])}},doReplaceAttachment:function(t,e,i,s,n,o,c){if(FormData.expiredIE){this.doInputUploadAttachment(t,e,i,s,n,o,c)}else{this.doFormDataUploadAttachment(t,e,i,s,n,o,c)}},downloadAttachment:function(t,e){if(this.selectedAttachments.length){if(this.module)this.module.downloadAttachment(t,e,this.selectedAttachments)}},openAttachment:function(t,e,i){if(i){if(this.module)this.module.openAttachment(t,e,i)}},downloadAllAttachment:function(t,e){if(this.module)this.module.downloadAttachment(t,e,this.attachments)},changeListStyle:function(e){this.options.listStyle=e;this.attachments.each(function(t){t.changeListStyle(e)}.bind(this));this.checkListStyleAction()},changeControllerSize:function(t,e){if(this.options.size=="max"){this.changeControllerSizeToMin()}else{this.changeControllerSizeToMax()}},changeControllerSizeToMin:function(){if(this.options.size!="min"){if(this.contentScrollNode)this.contentScrollNode.setStyle("display","none");if(this.bottomNode)this.bottomNode.setStyle("display","none");if(this.topNode)this.topNode.setStyle("display","none");if(this.titleNode)this.titleNode.setStyle("display","none");if(!this.nodeMorph)this.nodeMorph=new Fx.Morph(this.node,{duration:100});this.nodeMorph.start(this.css.container_min).chain(function(){this.options.size="min";this.loadMin()}.bind(this))}},changeControllerSizeToMax:function(){if(this.options.size!="max"){if(this.minActionAreaNode)this.minActionAreaNode.setStyle("display","none");if(this.minContent)this.minContent.setStyle("display","none");if(!this.nodeMorph)this.nodeMorph=new Fx.Morph(this.node,{duration:100});this.nodeMorph.start(this.css.container).chain(function(){this.options.size="max";this.loadMax()}.bind(this))}},getAttachmentNames:function(){var e=[];this.attachments.each(function(t){e.push(t.data.name)});return e},addAttachment:function(t){if(this.options.size=="min"){this.attachments.push(new MWF.widget.AttachmentController.AttachmentMin(t,this))}else{this.attachments.push(new MWF.widget.AttachmentController.Attachment(t,this))}},removeAttachment:function(t){this.attachments.erase(t);this.selectedAttachments.erase(t);t.node.destroy();delete t},unSelectedAttachments:function(){while(this.selectedAttachments.length){var t=this.selectedAttachments.shift();t.unSelected()}this.checkActions()},clear:function(){this.selectedAttachments=[];this.attachments.each(function(t){t.node.destroy();MWF.release(t)});this.attachments=[];this.content.empty()}});MWF.widget.AttachmentController.Attachment=new Class({Implements:[Events],initialize:function(t,e){this.data=t;this.controller=e;this.css=this.controller.css;this.listStyle=this.controller.options.listStyle;this.content=this.controller.content;this.isSelected=false;this.load()},load:function(){this.node=new Element("div").inject(this.content);switch(this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break}this.createInforNode(function(){if(!Browser.Platform.ios){this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})}}.bind(this));this.setEvent()},createInforNode:function(t){var e="";var i=this.data.length/1204;if(i>1024){var s=i/1024;s=Math.round(s*100)/100;e=s+"M"}else{i=Math.round(i*100)/100;e=i+"K"}this.inforNode=new Element("div",{styles:this.css.attachmentInforNode});var n="<div style='overflow:hidden; font-weight: bold'>"+this.data.name+"</div>";n+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+MWF.LP.widget.uploader+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.person+"</div></div>";n+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+MWF.LP.widget.uploadTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.createTime+"</div></div>";n+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+MWF.LP.widget.modifyTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.lastUpdateTime+"</div></div>";n+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+MWF.LP.widget.uploadActivity+": </div><div style='width:120px; float:left; margin-left:10px'>"+(this.data.activityName||MWF.LP.widget.unknow)+"</div></div>";n+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+MWF.LP.widget.size+": </div><div style='width:120px; float:left; margin-left:10px'>"+e+"</div></div>";this.inforNode.set("html",n);if(t)t()},getIcon:function(){if(!this.data.extension)this.data.extension="unkonw";var t=this.controller.icons[this.data.extension.toLowerCase()]||this.controller.icons.unknow;return"/x_component_File/$Main/default/file/"+t},loadList:function(){this.node.setStyles(this.css.attachmentNode_list);if(this.isSelected)this.node.setStyles(this.css.attachmentNode_list_selected);this.iconNode=new Element("div",{styles:this.css.attachmentIconNode_list}).inject(this.node);this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode);this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode);this.iconImgNode.set({src:this.getIcon(),border:0});this.textNode=new Element("div",{styles:this.css.attachmentTextNode_list}).inject(this.node);this.textTitleNode=new Element("div",{styles:this.css.attachmentTextTitleNode_list}).inject(this.textNode);this.textTitleNode.set("text",this.data.name);var t="";var e=this.data.length/1204;if(e>1024){var i=e/1024;i=Math.round(i*100)/100;t=i+"M"}else{e=Math.round(e*100)/100;t=e+"K"}this.textSizeNode=new Element("div",{styles:this.css.attachmentTextSizeNode_list}).inject(this.textNode);this.textSizeNode.set("text",t);this.textUploaderNode=new Element("div",{styles:this.css.attachmentTextUploaderNode_list}).inject(this.textNode);this.textUploaderNode.set("text",this.data.person);this.textTimeNode=new Element("div",{styles:this.css.attachmentTextTimeNode_list}).inject(this.textNode);this.textTimeNode.set("text",this.data.lastUpdateTime);this.textActivityNode=new Element("div",{styles:this.css.attachmentTextActivityNode_list}).inject(this.textNode);this.textActivityNode.set("text",this.data.activityName||MWF.LP.widget.unknow);this.custom_List()},custom_List:function(){},loadIcon:function(){this.node.setStyles(this.css.attachmentNode_icon);if(this.isSelected)this.node.setStyles(this.css.attachmentNode_icon_selected);this.iconNode=new Element("div",{styles:this.css.attachmentIconNode}).inject(this.node);this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode}).inject(this.iconNode);this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode}).inject(this.iconImgAreaNode);this.iconImgNode.set({src:this.getIcon(),border:0});this.textNode=new Element("div",{styles:this.css.attachmentTextNode}).inject(this.node);this.textNode.set("text",this.data.name);this.custom_Icon()},custom_Icon:function(){},loadPreview:function(){this.node.setStyles(this.css.attachmentNode_preview);if(this.isSelected)this.node.setStyles(this.css.attachmentNode_preview_selected);this.iconNode=new Element("div",{styles:this.css.attachmentPreviewIconNode}).inject(this.node);this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentPreviewIconImgAreaNode}).inject(this.iconNode);this.iconImgNode=new Element("img",{styles:this.css.attachmentPreviewIconImgNode}).inject(this.iconImgAreaNode);var e=this.getIcon();if(this.controller.options.images.indexOf(this.data.extension.toLowerCase())!==-1){this.controller.module.getAttachmentUrl(this,function(t){e=t;this.getPreviewImgSize(e,function(t){this.iconImgNode.set({src:e,border:0});this.iconImgAreaNode.setStyles({width:""+t.x+"px",height:""+t.y+"px"});this.iconImgNode.setStyles({width:""+t.x+"px",height:""+t.y+"px","margin-top":""+t.top+"px"});window.setTimeout(function(){this.getPreviewImgSize(e,function(t){if(this.iconImgAreaNode)this.iconImgAreaNode.setStyles({width:""+t.x+"px",height:""+t.y+"px"});if(this.iconImgNode)this.iconImgNode.setStyles({width:""+t.x+"px",height:""+t.y+"px","margin-top":""+t.top+"px"})}.bind(this))}.bind(this),100)}.bind(this))}.bind(this));this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node);this.textNode.set("text",this.data.name)}else if(this.controller.options.audios.indexOf(this.data.extension.toLowerCase())!==-1){this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node);this.textNode.set("text",this.data.name);this.controller.module.getAttachmentUrl(this,function(t){this.iconImgNode.set({src:e,border:0});this.iconAudioNode=new Element("div",{styles:this.css.attachmentPreviewAudioNode,html:'<audio preload="metadata" controls="controls" style="width: 100%; height: 100%"><source src="'+t+'" type="audio/mpeg"></source></audio>'}).inject(this.textNode,"after");this.iconAudioNode.addEvent("dblclick",function(t){t.stopPropagation()})}.bind(this))}else if(this.controller.options.videos.indexOf(this.data.extension.toLowerCase())!==-1){this.controller.module.getAttachmentUrl(this,function(t){this.iconNode.empty();this.iconVideoNode=new Element("div",{styles:this.css.attachmentPreviewVideoNode,html:'<video preload="metadata" controls="controls" style="width: 100%; height: 100%"><source src="'+t+'"></source></video>'}).inject(this.iconNode);this.iconVideoNode.addEvent("dblclick",function(t){t.stopPropagation()});this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node);this.textNode.set("text",this.data.name)}.bind(this))}else{this.iconImgNode.set({src:e,border:0});this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node);this.textNode.set("text",this.data.name)}this.custom_Preview()},custom_Preview:function(){},getPreviewImgSize:function(t,e){var i=this.iconNode.getSize();var s=new Element("img",{src:t}).inject($(document.body));s.set("src",t);var n=s.getSize();s.destroy();var o,c;var h=i.x/n.x;var c=n.y*h;if(c<=i.y){o=i.x}else{h=i.y/n.y;o=n.x*h;c=i.y}var n={x:o,y:c,top:(i.y-c)/2};if(e)e(n)},setEvent:function(){this.node.addEvents({mouseover:function(){if(!this.isSelected)this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"])}.bind(this),mouseout:function(){if(!this.isSelected)this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),mousedown:function(t){this.selected(t)}.bind(this),dblclick:function(t){this.openAttachment(t)}.bind(this)})},selected:function(t){if(!t.event.ctrlKey)this.controller.unSelectedAttachments();this.controller.selectedAttachments.push(this);this.isSelected=true;this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]);if(t)t.stopPropagation();this.controller.checkActions()},unSelected:function(){this.isSelected=false;this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]);this.controller.selectedAttachments.erase(this)},changeListStyle:function(t){if(this.listStyle!=t){this.node.empty();switch(t){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break}this.listStyle=t}},reload:function(){var t=new Element("div").inject(this.node,"after");this.inforNode.destroy();this.inforNode=null;if(this.tooltip)this.tooltip.destroy();this.tooltip=null;this.node.destroy();delete this.node;this.node=t;switch(this.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break}this.createInforNode();if(!Browser.Platform.ios){this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})}this.setEvent()},openAttachment:function(t){if(this.controller.module)this.controller.module.openAttachment(t,null,[this])}});MWF.widget.AttachmentController.AttachmentMin=new Class({Extends:MWF.widget.AttachmentController.Attachment,initialize:function(t,e){this.data=t;this.controller=e;this.css=this.controller.css;this.content=this.controller.minContent;this.isSelected=false;this.load()},load:function(){this.node=new Element("div").inject(this.content);this.loadList();this.createInforNode();if(!Browser.Platform.ios){this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})}this.setEvent()},loadList:function(){this.node.setStyles(this.css.minAttachmentNode_list);if(this.isSelected)this.node.setStyles(this.css.minAttachmentNode_list_selected);this.iconNode=new Element("div",{styles:this.css.minAttachmentIconNode_list}).inject(this.node);this.iconImgAreaNode=new Element("div",{styles:this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode);this.iconImgNode=new Element("img",{styles:this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode);this.iconImgNode.set({src:this.getIcon(),border:0});this.textNode=new Element("div",{styles:this.css.minAttachmentTextNode_list}).inject(this.node);this.textNode.set("text",this.data.name)},setEvent:function(){this.node.addEvents({mouseover:function(){if(!this.isSelected)this.node.setStyles(this.css["minAttachmentNode_list_over"])}.bind(this),mouseout:function(){if(!this.isSelected)this.node.setStyles(this.css["minAttachmentNode_list"])}.bind(this),mousedown:function(t){this.selected(t)}.bind(this),dblclick:function(t){this.openAttachment(t)}.bind(this)})},selected:function(t){if(!t.event.ctrlKey)this.controller.unSelectedAttachments();this.controller.selectedAttachments.push(this);this.isSelected=true;this.node.setStyles(this.css["minAttachmentNode_list_selected"]);if(t)t.stopPropagation();this.controller.checkActions()},reload:function(){var t=new Element("div").inject(this.node,"after");this.inforNode.destroy();this.inforNode=null;if(this.tooltip)this.tooltip.destroy();this.tooltip=null;this.node.destroy();delete this.node;this.node=t;this.loadList();this.createInforNode();if(!Browser.Platform.ios){this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})}this.setEvent()},unSelected:function(){this.isSelected=false;this.node.setStyles(this.css["minAttachmentNode_list"]);this.controller.selectedAttachments.erase(this)}});