MWF.widget=MWF.widget||{};MWF.widget.Calendar=MWF.Calendar=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",path:MWF.defaultPath+"/widget/$Calendar/",defaultView:"day",baseDate:new Date,isTime:false,isMulti:false,before:null,after:null,timeOnly:false,defaultDate:new Date,beforeCurrent:true,range:false,rangeNodes:[],rangeRule:"asc",target:null},initialize:function(t,e){Locale.use("zh-CHS");this.options.defaultTime=""+this.options.baseDate.getHours()+":"+this.options.baseDate.getMinutes()+":"+this.options.baseDate.getSeconds();this.setOptions(e);this.path=MWF.defaultPath+"/widget/$Calendar/";this.cssPath=MWF.defaultPath+"/widget/$Calendar/"+this.options.style+"/css.wcss";this._loadCss();if(!this.options.format){if(this.options.isTime){if(this.options.timeOnly){this.options.format="%H:%M"}else{this.options.format=Locale.get("Date").shortDate+" "+"%H:%M"}}else{this.options.format=Locale.get("Date").shortDate}}this.options.containerPath=this.options.path+this.options.style+"/container.html";this.options.dayPath=this.options.path+this.options.style+"/day.html";this.options.monthPath=this.options.path+this.options.style+"/month.html";this.options.yearPath=this.options.path+this.options.style+"/year.html";this.options.timePath=this.options.path+this.options.style+"/time.html";this.today=new Date;this.currentView=this.options.defaultView;this.node=$(t);this.visible=false;this.container=this.createContainer();this.container.inject(this.options.target||$(document.body));this.contentTable=this.createContentTable();this.contentTable.inject(this.contentDateNode);this.addEvents();this.container.set({styles:{display:"none",opacity:1}});this.fireEvent("init")},addEvents:function(){this.node.addEvent("focus",function(){this.show()}.bind(this));this.node.addEvent("click",function(){debugger;this.show()}.bind(this));this.prevNode.addEvent("click",function(){this.getPrev()}.bind(this));this.nextNode.addEvent("click",function(){this.getNext()}.bind(this));this.currentTextNode.addEvent("click",function(){this.changeView()}.bind(this));this.titleNode.addEvent("mousedown",function(){this.move()}.bind(this));this.titleNode.addEvent("mouseup",function(){this.unmove()}.bind(this));document.addEvent("mousedown",this.outsideClick.bind(this))},move:function(){this.containerDrag=new Drag.Move(this.container,{onDrag:function(t){if(this.iframe){var e=this.container.getPosition();this.iframe.setStyles({top:""+e.y+"px",left:""+e.x+"px"})}}.bind(this)})},unmove:function(){this.container.removeEvents("mousedown");this.titleNode.addEvent("mousedown",function(){this.move()}.bind(this))},changeView:function(){var t="day";switch(this.currentView){case"day":this.changeViewToMonth();break;case"month":this.changeViewToYear();break;case"year":this.changeViewToDay();break;case"time":this.changeViewToDay();break;default:}},changeViewToMonth:function(t){this.currentView="month";if(!this.contentMonthTable){this.contentMonthTable=this.createContentTable();this.contentMonthTable.inject(this.contentDateNode)}if(this.contentTable)this.contentTable.setStyle("display","none");if(this.contentYearTable)this.contentYearTable.setStyle("display","none");if(this.contentTimeTable)this.contentTimeTable.setStyle("display","none");if(this.contentMonthTable)this.contentMonthTable.setStyle("display","table");var t=t!=undefined?t:this.currentTextNode.retrieve("year");var e=this.currentTextNode.retrieve("month");this.showMonth(t,e)},changeViewToYear:function(t){this.currentView="year";if(!this.contentYearTable){this.contentYearTable=this.createContentTable();this.contentYearTable.inject(this.contentDateNode)}if(this.contentTable)this.contentTable.setStyle("display","none");if(this.contentMonthTable)this.contentMonthTable.setStyle("display","none");if(this.contentTimeTable)this.contentTimeTable.setStyle("display","none");if(this.contentYearTable)this.contentYearTable.setStyle("display","table");this.showYear(t)},changeViewToDay:function(t,e){this.currentView="day";if(!this.contentTable){this.contentTable=this.createContentTable();this.contentTable.inject(this.contentDateNode)}if(this.contentMonthTable)this.contentMonthTable.setStyle("display","none");if(this.contentYearTable)this.contentYearTable.setStyle("display","none");if(this.contentTimeTable)this.contentTimeTable.setStyle("display","none");if(this.contentTable)this.contentTable.setStyle("display","table");this.showDay(t,e)},getNext:function(){switch(this.currentView){case"time":this.getNextDate();break;case"day":this.getNextDay();break;case"month":this.getNextMonth();break;case"year":this.getNextYear();break;default:}},getPrev:function(){switch(this.currentView){case"time":this.getPrevDate();break;case"day":this.getPrevDay();break;case"month":this.getPrevMonth();break;case"year":this.getPrevYear();break;default:}},getNextDate:function(){var t=this.currentTextNode.retrieve("date");t.increment("day",1);this._setTimeTitle(null,t)},getPrevDate:function(){var t=this.currentTextNode.retrieve("date");t.increment("day",-1);this._setTimeTitle(null,t)},getNextDay:function(){var t=this.currentTextNode.retrieve("year");var e=this.currentTextNode.retrieve("month");e--;var s=new Date(t,e,1);s.increment("month",1);var i=s.getFullYear();var n=s.getMonth();this._setDayTitle(null,i,n);this._setDayDate(null,i,n)},getPrevDay:function(){var t=this.currentTextNode.retrieve("year");var e=this.currentTextNode.retrieve("month");e--;var s=new Date(t,e,1);s.increment("month",-1);var i=s.getFullYear();var n=s.getMonth();this._setDayTitle(null,i,n);this._setDayDate(null,i,n)},getNextMonth:function(){var t=this.currentTextNode.retrieve("year");var e=new Date(t,1,1);e.increment("year",1);var s=e.getFullYear();this.showMonth(s)},getPrevMonth:function(){var t=this.currentTextNode.retrieve("year");var e=new Date(t,1,1);e.increment("year",-1);var s=e.getFullYear();this.showMonth(s)},getNextYear:function(){var t=this.currentTextNode.retrieve("year");var e=new Date(t,1,1);e.increment("year",this.yearLength);var s=e.getFullYear();this.showYear(s)},getPrevYear:function(){var t=this.currentTextNode.retrieve("year");var e=new Date(t,1,1);e.increment("year",0-this.yearLength);var s=e.getFullYear();this.showYear(s)},outsideClick:function(t){if(this.visible){var e=this.container.getCoordinates();var s=this.node.getCoordinates();if((t.page.x<e.left||t.page.x>e.left+e.width||(t.page.y<e.top||t.page.y>e.top+e.height))&&(t.page.x<s.left||t.page.x>s.left+s.width||(t.page.y<s.top||t.page.y>s.top+s.height)))this.hide()}},hide:function(){if(this.visible){this.visible=false;this.container.setStyle("display","none");if(this.iframe)this.iframe.destroy();if(layout.desktop.offices){Object.each(layout.desktop.offices,function(t){t.show()})}this.fireEvent("hide")}},show:function(){if(!this.visible){var t=this.node.get("value");if(t&&Date.isValid(t)){this.options.baseDate=Date.parse(t.substr(0,10))}if(this.options.timeOnly){this.currentView="time"}else{this.currentView=this.options.defaultView}switch(this.currentView){case"day":this.changeViewToDay();break;case"month":this.showMonth();break;case"year":this.showYear();break;case"time":this.changeViewToTime(this.options.defaultDate);break;default:this.showDay()}this.container.setStyle("display","block");if(this.container.position){this.container.position({relativeTo:this.node,position:"bottomLeft",edge:"upperLeft"});var e=this.container.getPosition(this.options.target||null);var s=this.container.getSize();var i=this.options.target?this.options.target.getSize():$(document.body).getSize();if(e.y+s.y>i.y){this.container.position({relativeTo:this.node,position:"upperLeft",edge:"bottomLeft"})}}else{var n=this.node.getPosition(this.options.target||null);var a=this.node.getSize();var o=this.container.getSize();var h=$(document.body).getSize();var r=n.x;if(r+o.x>h.x){r=h.x-o.x}this.container.setStyle("top",n.y+a.y+2);this.container.setStyle("left",r)}if(layout.desktop.offices){Object.each(layout.desktop.offices,function(t){if(this.container.isOverlap(t.officeNode)){t.hide()}}.bind(this))}this.visible=true;this.fireEvent("show")}},showYear:function(t){var e=t!=undefined?t:this.options.baseDate.getFullYear();var s=new Date(e,1,1);s.increment("year",-2);var i=s.getFullYear();s.increment("year",this.yearLength-1);var n=s.getFullYear();this._setYearTitle(null,i,n,e);this._setYearDate(null,i,n,e)},_setYearTitle:function(t,e,s,i){var n=t||this.currentTextNode;n.set("text",e+"-"+s);n.store("year",i)},_setYearDate:function(t,i,e,s){var n=t||this.contentYearTable;var a=s!=undefined?s:this.options.baseDate.getFullYear();var o=n.getElement("tbody");var h=o.getElements("td");h.each(function(t,e){var s=i+e;t.set("text",s);t.store("year",s);if(s==this.options.baseDate.getFullYear()){t.addClass("current_"+this.options.style)}else{t.removeClass("current_"+this.options.style)}}.bind(this))},showMonth:function(t,e){var s=t!=undefined?t:this.options.baseDate.getFullYear();var i=e!=undefined?e:this.options.baseDate.getMonth();this._setMonthTitle(null,s,i);this._setMonthDate(null,s,i)},_setMonthTitle:function(t,e){var s=e!=undefined?e:this.options.baseDate.getFullYear();var i=t||this.currentTextNode;i.set("text",s);i.store("year",s)},_setMonthDate:function(t,e,s){var i=MWF.LP.widget.months;var n=t||this.contentMonthTable;var a=e!=undefined?e:this.options.baseDate.getFullYear();var o=s!=undefined?s:this.options.baseDate.getMonth();var h=n.getElement("tbody");var r=h.getElements("td");r.each(function(t,e){t.set("text",i[e].substr(0,2));t.store("year",a);t.store("month",e);if(a==this.options.baseDate.getFullYear()&&e==this.options.baseDate.getMonth()){t.addClass("current_"+this.options.style)}else{t.removeClass("current_"+this.options.style)}}.bind(this))},showDay:function(t,e){this._setDayTitle(null,t,e);this._setDayWeekTitleTh();this._setDayDate(null,t,e)},_setDayTitle:function(t,e,s){var i=e!=undefined?e:this.options.baseDate.getFullYear();var n=s!=undefined?s:this.options.baseDate.getMonth();n++;var a=i+"年"+n+"月";var o=t||this.currentTextNode;o.set("text",a);o.store("year",i);o.store("month",n)},_setDayDate:function(t,e,s){var i=t||this.contentTable;var n=this.options.baseDate;if(e!=undefined&&s!=undefined){n=new Date;n.setDate(1);n.setFullYear(e);n.setMonth(s)}var a=i.getElement("tbody");var o=a.getElements("td");var h=n.clone();h.setDate(1);var r=h.getDay();var l=h.clone();for(var c=r-1;c>=0;c--){l.increment("day",-1);o[c].set("text",l.getDate());o[c].addClass("gray_"+this.options.style);o[c].setStyles(this.css["gray_"+this.options.style]);o[c].store("dateValue",l.toString())}for(var c=r;c<o.length;c++){o[c].set("text",h.getDate());if(h.toString()==this.options.baseDate.toString()){o[c].addClass("current_"+this.options.style);o[c].setStyles(this.css["current_"+this.options.style]);o[c].removeClass("gray_"+this.options.style);o[c].setStyle("border","1px solid #FFF")}else if(h.getMonth()!=n.getMonth()){o[c].addClass("gray_"+this.options.style);o[c].setStyles(this.css["gray_"+this.options.style]);o[c].removeClass("current_"+this.options.style);o[c].setStyle("border","1px solid #FFF")}else{o[c].setStyles(this.css["normal_"+this.options.style]);o[c].removeClass("current_"+this.options.style);o[c].removeClass("gray_"+this.options.style);o[c].setStyle("border","1px solid #FFF")}var d=h.clone();if(d.clearTime().toString()==this.today.clearTime().toString()){o[c].setStyles(this.css["today_"+this.options.style]);o[c].setStyle("border","0px solid #AAA")}o[c].store("dateValue",h.toString());h.increment("day",1)}},changeViewToTime:function(t){this.currentView="time";if(!this.contentTimeTable){this.contentTimeTable=this.createContentTable();this.contentTimeTable.inject(this.contentDateNode)}if(this.contentTable)this.contentTable.setStyle("display","none");if(this.contentYearTable)this.contentYearTable.setStyle("display","none");if(this.contentMonthTable)this.contentMonthTable.setStyle("display","none");if(this.contentTimeTable)this.contentTimeTable.setStyle("display","block");var e=t||this.options.baseDate;this.showTime(e)},showTime:function(t){var e=this.options.defaultTime.split(":");var s=e[0]?e[0]:"0";var i=e[1]?e[1]:"0";var n=e[2]?e[2]:"0";this._setTimeTitle(null,t);this._setTimeDate(null,s,i,n)},_setTimeTitle:function(t,e){var s=e||this.options.baseDate;var i=t||this.currentTextNode;var n=s.getFullYear();var a=s.getMonth()+1;var o=s.getDate();var h=""+n+"年"+a+"月"+o+"日";if(this.options.timeOnly){i.hide();if(this.prevNode)this.prevNode.hide();if(this.nextNode)this.nextNode.hide()}i.set("text",h);i.store("date",e)},_setTimeDate:function(t,e,s,n){this.itmeHNode=this.contentTimeTable.getElement(".MWF_calendar_time_h_slider");this.itmeMNode=this.contentTimeTable.getElement(".MWF_calendar_time_m_slider");this.timeShowNode=this.contentTimeTable.getElement(".MWF_calendar_time_show");this.timeShowNode.addEvent("click",function(){this._selectTime()}.bind(this));this.showHNode=this.contentTimeTable.getElement(".MWF_calendar_time_show_h");this.showMNode=this.contentTimeTable.getElement(".MWF_calendar_time_show_m");this.showActionNode=this.contentTimeTable.getElement(".MWF_calendar_action_show");var a=this;if(COMMON.Browser.Platform.isMobile){this.itmeHNode.empty();this.itmeHNode.removeClass("calendarTimeSlider");this.itmeHNode.setStyles(this.css.calendarTimeSliderNoStyle);var o=new Element("select").inject(this.itmeHNode);for(i=0;i<=23;i++){var h=i<10?"0"+i:i;var r=new Element("option",{value:h,text:h}).inject(o);if(e==i)r.set("selected",true)}o.addEvent("change",function(){a.showHNode.set("text",this.options[this.selectedIndex].get("value"))});this.showHNode.set("text",o.options[o.selectedIndex].get("value"));this.itmeMNode.empty();this.itmeMNode.removeClass("calendarTimeSlider");this.itmeMNode.setStyles(this.css.calendarTimeSliderNoStyle);o=new Element("select").inject(this.itmeMNode);for(i=0;i<=59;i++){var h=i<10?"0"+i:i;var r=new Element("option",{value:h,text:h}).inject(o);if(s==i)r.set("selected",true)}o.addEvent("change",function(){a.showMNode.set("text",this.options[this.selectedIndex].get("value"))});this.showMNode.set("text",o.options[o.selectedIndex].get("value"))}else{var l=new Slider(this.itmeHNode,this.itmeHNode.getFirst(),{range:[0,23],initialStep:e.toInt(),onChange:function(t){var e=t.toInt().toString();if(e.length<2){e="0"+e}this.showHNode.set("text",e);this.itmeHNode.getFirst().set("text",e)}.bind(this)});var c=new Slider(this.itmeMNode,this.itmeMNode.getFirst(),{range:[0,59],initialStep:s.toInt(),onChange:function(t){var e=t.toInt().toString();if(e.length<2){e="0"+e}this.showMNode.set("text",e);this.itmeMNode.getFirst().set("text",e)}.bind(this)})}this.showHNode.set("text",e.toInt());this.showMNode.set("text",s.toInt());if(!this.okButton){this.okButton=new Element("button",{text:"确定"}).inject(this.showActionNode);this.okButton.addEvent("click",function(){this._selectTime();this.hide()}.bind(this));this.okButton.setStyles(this.css.calendarActionShowButton)}if(!this.clearButton){this.clearButton=new Element("button",{text:"清除"}).inject(this.showActionNode);this.clearButton.addEvent("click",function(){this.node.set("value","");this.fireEvent("clear");this.hide()}.bind(this));this.clearButton.setStyles(this.css.calendarActionShowButton)}},_selectTime:function(){var t=this.currentTextNode.retrieve("date");var e=this.showHNode.get("text");var s=this.showMNode.get("text");t.setHours(e);t.setMinutes(s);if(!this.options.beforeCurrent){var i=new Date;if(t.getTime()-i.getTime()<0){alert("选择的日期必须大于当前日期!");this.node.focus();return false}}var n=t.format(this.options.format);if(this.fireEvent("queryComplate",[n,t])){var a=this.node.get("value");this.node.set("value",n);this.hide();if(a!=n)this.fireEvent("change",[n,t,a]);this.fireEvent("complate",[n,t])}},_selectDate:function(t){var e=new Date(t);var s=e.format(this.options.format);if(this.options.isTime){this.changeViewToTime(e)}else{if(!this.options.beforeCurrent){var i=new Date;e.setHours(23,59,59);if(e.getTime()-i.getTime()<0){alert("选择的日期必须大于当前日期!");this.node.focus();return false}}if(this.fireEvent("queryComplate",[s,e])){var n=this.node.get("value");this.node.set("value",s);this.hide();if(n!=s)this.fireEvent("change",[s,e,n]);this.fireEvent("complate",[s,e,n])}}},_setDayWeekTitleTh:function(t){var e=t||this.contentTable;var s=e.getElement("thead");var i=s.getElements("th");if(this.css.calendarDaysContentTh)i.setStyles(this.css.calendarDaysContentTh);var n=MWF.LP.widget.days_abbr;i.each(function(t,e){t.set("text",n[e])});return i},createContainer:function(){var n=null;var t=new Request.HTML({url:this.options.containerPath,method:"GET",async:false,onSuccess:function(t,e,s,i){n=t[0]}});t.send();this.titleNode=n.getElement(".MWF_calendar_title");this.prevNode=n.getElement(".MWF_calendar_prev");this.currentNode=n.getElement(".MWF_calendar_current");this.currentTextNode=n.getElement(".MWF_calendar_currentText");this.nextNode=n.getElement(".MWF_calendar_next");this.contentNode=n.getElement(".MWF_calendar_content");this.contentDateNode=n.getElement(".MWF_calendar_content_date");this.contentTimeNode=n.getElement(".MWF_calendar_content_time");this.bottomNode=n.getElement(".MWF_calendar_bottom");n.setStyles(this.css.container);this.titleNode.setStyles(this.css.dateTitle);this.prevNode.setStyles(this.css.datePrev);this.currentNode.setStyles(this.css.dateCurrent);this.currentTextNode.setStyles(this.css.dateCurrentText);this.nextNode.setStyles(this.css.dateNext);this.contentNode.setStyles(this.css.calendarContent);this.bottomNode.setStyles(this.css.dateBottom);return n},createContentTable:function(){var n=null;var t=new Request.HTML({url:this.options[this.currentView+"Path"],method:"GET",async:false,onSuccess:function(t,e,s,i){n=t[0]}});t.send();var e=n.getElement("tbody");if(e){var s=e.getElements("td");var i=this;s.addEvent("click",function(){switch(i.currentView){case"day":i._selectDate(this.retrieve("dateValue"),this);break;case"month":i.changeViewToDay(this.retrieve("year"),this.retrieve("month"));break;case"year":i.changeViewToMonth(this.retrieve("year"));break;case"time":break;default:}});switch(this.currentView){case"day":if(!n.display)n.display="";if(!n.style.display)n.style.display="";n.setStyles(this.css.calendarDaysContent);s.setStyles(this.css.calendarDaysContentTd);break;case"month":n.setStyles(this.css.calendarMonthsContent);s.setStyles(this.css.calendarMonthsContentTd);break;case"year":this.yearLength=s.length;n.setStyles(this.css.calendarYearsContent);s.setStyles(this.css.calendarYearsContentTd);break;case"time":var a=n.getElements(".calendarTimeArea");if(a.length)a.setStyles(this.css.calendarTimeArea);a=n.getElements(".calendarTimeSlider");if(a.length)a.setStyles(this.css.calendarTimeSlider);a=n.getElements(".calendarTimeSliderKnob");if(a.length)a.setStyles(this.css.calendarTimeSliderKnob);a=n.getElements(".calendarTimeShow");if(a.length)a.setStyles(this.css.calendarTimeShow);a=n.getElements(".calendarTimeShowItem");if(a.length)a.setStyles(this.css.calendarTimeShowItem);var o=n.getElement(".MWF_calendar_action_show");if(o){o.setStyles(this.css.calendarActionShow);var h=o.getElements("button");h.setStyles(this.css.calendarActionShowButton)}break;default:}s.addEvent("mouseover",function(){this.setStyle("border","1px solid #999999")});s.addEvent("mouseout",function(){this.setStyle("border","1px solid #FFF")})}else{switch(this.currentView){case"day":n.setStyles(this.css.calendarDaysContent);s.setStyles(this.css.calendarDaysContentTd);break;case"month":n.setStyles(this.css.calendarMonthsContent);s.setStyles(this.css.calendarMonthsContentTd);break;case"year":this.yearLength=s.length;n.setStyles(this.css.calendarYearsContent);s.setStyles(this.css.calendarYearsContentTd);break;case"time":var a=n.getElements(".calendarTimeArea");if(a.length)a.setStyles(this.css.calendarTimeArea);a=n.getElements(".calendarTimeSlider");if(a.length)a.setStyles(this.css.calendarTimeSlider);a=n.getElements(".calendarTimeSliderKnob");if(a.length)a.setStyles(this.css.calendarTimeSliderKnob);a=n.getElements(".calendarTimeShow");if(a.length)a.setStyles(this.css.calendarTimeShow);a=n.getElements(".calendarTimeShowItem");if(a.length)a.setStyles(this.css.calendarTimeShowItem);var o=n.getElement(".MWF_calendar_action_show");if(o){o.setStyles(this.css.calendarActionShow);var h=o.getElements("button");h.setStyles(this.css.calendarActionShowButton)}break;default:}}return n}});