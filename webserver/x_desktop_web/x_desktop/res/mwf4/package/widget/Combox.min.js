MWF.widget=MWF.widget||{};MWF.require("MWF.widget.Common",null,false);MWF.widget.Combox=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",list:[],optionsMethod:null,splitStr:/,\s*|;\s*|，\s*|；\s*/g,splitShow:", ",focusList:false,count:0},initialize:function(t){this.setOptions(t);this.splitRegExp=new RegExp(this.options.splitStr);this.path=MWF.defaultPath+"/widget/$Combox/";this.cssPath=MWF.defaultPath+"/widget/$Combox/"+this.options.style+"/css.wcss";this._loadCss();this.values=[];this.load()},getSelectList:function(s,i){var e=[];if(this.options.list.length){var t=this.options.list.filter(function(t,i){var e=(t.keyword||"")+t.text;return e.indexOf(s)!==-1});e=t}if(this.options.optionsMethod){this.options.optionsMethod(s,function(t){if(t.length){if(e.length){e=e.concat(t)}else{e=t}}if(i)i(e)}.bind(this))}else{if(i)i(e)}},load:function(){if(this.fireEvent("queryLoad")){this.node=new Element("div",{styles:this.css.comboxNode});this.copyPrototype();this.setEvent();this.fireEvent("postLoad")}},clear:function(){if(this.input)MWF.release(this.input);this.input=null;this.node.empty();this.values=[]},getData:function(){var t=this.node.getFirst();var i=[];while(t){var e=t.retrieve("item");if(e){if(e.data||e.value){i.push(e.data||e.value)}}t=t.getNext()}return i},copyPrototype:function(){this.inject=this.node.inject.bind(this.node);this.setStyle=this.node.setStyle.bind(this.node);this.setStyles=this.node.setStyles.bind(this.node);this.set=this.node.set.bind(this.node)},setEvent:function(){this.node.addEvents({focus:function(t){if(!this.selectStatus){if(!this.editItem)this.intoEdit(t)}}.bind(this),mousedown:function(t){if(!this.selectStatus){if(!this.editItem)this.intoEdit(t);t.stopPropagation();t.preventDefault()}}.bind(this)})},stopEdit:function(){if(this.editItem){this.editItem.input.confirmValue()}else{if(this.input)this.input.confirmValue()}if(this.input)this.input.node.hide()},intoEdit:function(t){if(this.options.count){if(this.values.length>=this.options.count){if(this.input)this.input.node.hide();return false}}if(!this.input){this.input=new MWF.widget.Combox.Input(this,this,"");this.input.node.inject(this.node);this.input.node.setStyle("width","1px")}if(t){if(t.type==="item"){var i=t.node;if(t.input){i=t.input.optionListNode||t.input.node}this.input.node.inject(i,"after")}else{var e=this.input.node.get("value");if(e)this.commitInput();var i=this.node.getFirst();while(i){if(i.retrieve("item")){var s=i.getPosition();var o=i.getSize();if(s.x>t.page.x&&s.y-3<t.page.y&&s.y+o.y+3>t.page.y)break}i=i.getNext()}if(i){this.input.node.inject(i,"before")}else{this.input.node.inject(this.node)}}}this.input.node.show();this.input.setInputNodeStyles();this.input.node.focus();this.input.setInputPosition();if(this.options.focusList)this.input.searchItems()},commitInput:function(t){debugger;var i=this.input.node.get("value");this.input.node.set("value","");if(i){var e=i.split(this.splitRegExp);if(this.options.count)e=e.slice(0,this.options.count);this.createItem(e,0,t,function(){this.input.node.set("value","");this.input.searchItems();this.input.setInputWidth();window.setTimeout(function(){this.intoEdit()}.bind(this),10)}.bind(this))}},createItem:function(t,i,e,s){if(t[i]){var o=t[i];var n=e;var h=o;if(!n){if(typeOf(o)==="object"){n=o.value;h=o.text}}this.values.push(new MWF.widget.Combox.Value(this,h,n,{onLoad:function(){i++;if(t[i]){this.createItem(t,i,e,s)}else{if(s)s()}}.bind(this)}))}},addNewValues:function(t,i){this.createItem(t,0,null,i)},addNewValue:function(t,i){debugger;if(t){this.values.push(new MWF.widget.Combox.Value(this,t,i));if(this.input){this.input.node.set("value","");this.input.hideOptionList();this.input.searchItems();this.input.setInputWidth()}}},getFirst:function(){var t=this.node.getFirst();if(t){while(t&&!t.retrieve("item")){t=t.getNext()}if(t)return t.retrieve("item")}return null},getLast:function(){var t=this.node.getLast();if(t){while(t&&!t.retrieve("item")){t=t.getPrevious()}if(t)return t.retrieve("item")}return null},getNextItem:function(){var t=this.input.node.getNext();if(t)return t.retrieve("item");return null},getPreviousItem:function(){var t=this.input.node.getPrevious();while(t&&!t.retrieve("item")){t=t.getPrevious()}if(t)return t.retrieve("item");return null},deleteItem:function(t){this.values.erase(t);t.node.destroy();t.input.destroy();MWF.release(t)}});MWF.widget.Combox.Value=new Class({Implements:[Options,Events],initialize:function(t,i,e,s){this.setOptions(s);this.combox=t;this.css=this.combox.css;this.value=i;this.data=e||null;this.type="item";this.load()},getItemPosition:function(){var t=0;var i=this.getPreviousItem();while(i){t++;i=i.getPreviousItem()}return t},checkData:function(i){if(!this.data){this.combox.getSelectList(this.value,function(t){if(t.length==1){this.data=t[0].value;this.value=t[0].text}if(i)i()}.bind(this))}else{if(i)i()}},load:function(){this.checkData(function(){this.node=new Element("div",{styles:this.css.valueItemNode});if(this.combox.input){this.node.inject(this.combox.input.node,"before")}else{this.node.inject(this.combox.node)}if(this.getNextItem()){this.node.set("text",this.value+this.combox.options.splitShow)}else{this.node.set("text",this.value)}var t=this.getPreviousItem();if(t){t.node.set("text",t.value+this.combox.options.splitShow)}this.node.store("item",this);this.node.addEvents({click:function(t){this.edit();t.stopPropagation()}.bind(this),mouseover:function(t){this.node.setStyles(this.css.valueItemNode_over)}.bind(this),mouseout:function(t){this.node.setStyles(this.css.valueItemNode)}.bind(this),mousedown:function(t){t.stopPropagation()}.bind(this),focus:function(t){t.stopPropagation()}});if(!this.data)this.node.setStyle("color","#bd0000");this.combox.fireEvent("commitInput",[this]);this.combox.fireEvent("change",[this]);this.fireEvent("load")}.bind(this))},edit:function(t){debugger;if(!this.input){this.input=new MWF.widget.Combox.Input(this.combox,this,this.value);this.input.node.inject(this.node,"after");this.input.hide()}this.input.node.show();this.input.setInputNodeStyles();this.node.hide();this.input.setInputPosition(t);this.combox.editItem=this;this.combox.input.hide();this.input.searchItems()},commitInput:function(t){var i=this.input.node.get("value");if(i){var e=i.split(this.combox.splitRegExp);if(e.length>1){this.input.node.set("value","");this.combox.editItem=null;var s=this.combox;this.combox.deleteItem(this);s.input.node.set("value",i);s.commitInput()}else{if(this.value==i){this.data=t||this.data}else{this.value=i;this.data=t||null}if(!this.data){this.node.setStyle("color","#bd0000")}else{this.node.setStyle("color","")}if(this.value){if(this.getNextItem()){this.node.set("text",this.value+this.combox.options.splitShow)}else{this.node.set("text",this.value)}this.node.show();this.input.hide();this.combox.editItem=null;this.combox.fireEvent("commitInput",[this]);this.combox.fireEvent("change",[this])}else{this.combox.editItem=null;var s=this.combox;this.input.hideOptionList();this.combox.deleteItem(this);s.fireEvent("change",[this])}}}else{this.combox.editItem=null;var s=this.combox;this.input.hideOptionList();this.combox.deleteItem(this);s.fireEvent("change",[this])}window.setTimeout(function(){this.combox.intoEdit(this)}.bind(this),10)},getNextItem:function(){var t=this.input?this.input.node.getNext():this.node.getNext();while(t&&!t.retrieve("item")){t=t.getNext()}if(t)return t.retrieve("item");return null},getPreviousItem:function(){var t=this.node.getPrevious();while(t&&!t.retrieve("item")){t=t.getPrevious()}if(t)return t.retrieve("item");return null}});MWF.widget.Combox.Input=new Class({initialize:function(t,i,e){this.combox=t;this.bind=i;this.css=this.combox.css;this.node=new Element("input",{styles:this.css.inputNode,type:"text",value:e});this.setInputNodeStyles();this.setInputWidth();this.setEvent();this.hideOption=false},hide:function(){this.node.hide();this.hideOptionList()},setEvent:function(){this.node.addEvents({mousedown:function(t){t.stopPropagation()},input:function(t){this.setInputWidth();this.searchItems();var i=this.node.get("value");var e=i.substr(i.length-1,1);if(e=="，"||e=="；"){debugger;this.node.set("value",i.substr(0,i.length-1));if(this.optionListNode&&this.optionListNode.getChildren().length===1){this.confirmValue()}else{this.bind.commitInput()}}}.bind(this),keydown:function(t){if(t.code===186||t.code===188||t.code===13){if(t.code===13){this.confirmValue()}else{if(this.optionListNode&&this.optionListNode.getChildren().length===1){this.confirmValue()}else{this.bind.commitInput()}}t.preventDefault();t.stopPropagation()}if(t.code===37){if(this.node.selectionStart==0&&this.node.selectionEnd==0){var i=this.bind.getPreviousItem();if(i){this.bind.commitInput();i.edit()}t.preventDefault();t.stopPropagation()}}if(t.code===39){var e=this.node.get("value").length;if(this.node.selectionStart==e&&this.node.selectionEnd==e){var i=this.bind.getNextItem();if(i){this.bind.commitInput();i.edit("start")}t.preventDefault();t.stopPropagation()}}if(t.code===8){if(this.node.selectionStart==0&&this.node.selectionEnd==0){var i=this.bind.getPreviousItem();if(i){this.bind.commitInput();i.edit();i.input.setInputPosition()}t.preventDefault();t.stopPropagation()}}if(t.code===46){var e=this.node.get("value").length;if(this.node.selectionStart==e&&this.node.selectionEnd==e){var i=this.bind.getNextItem();if(i){this.bind.commitInput();i.edit();i.input.setInputPosition("start")}t.preventDefault();t.stopPropagation()}}if(t.code===38){this.selectPrevOption()}if(t.code===40){this.selectNextOption()}}.bind(this),blur:function(t){if(this.combox.editItem==this.bind||!this.combox.editItem){this.bind.commitInput()}t.stopPropagation()}.bind(this)})},setSelectedOption:function(t){var i=t.getStyles("background-color","background","color");t.store("originalStyle",i);t.setStyles(this.css.optionNode_selected);this.selectedOption=t},selectPrevOption:function(){if(this.optionListNode){if(this.selectedOption)this.selectedOption.setStyles(this.selectedOption.retrieve("originalStyle"));node=this.selectedOption?this.selectedOption.getPrevious()||this.optionListNode.getLast():this.optionListNode.getLast();if(node)this.setSelectedOption(node);this.optionListNode.scrollToNode(node,"top")}},selectNextOption:function(){if(this.optionListNode){if(this.selectedOption)this.selectedOption.setStyles(this.selectedOption.retrieve("originalStyle"));node=this.selectedOption?this.selectedOption.getNext()||this.optionListNode.getFirst():this.optionListNode.getFirst();if(node)this.setSelectedOption(node);this.optionListNode.scrollToNode(node,"bottom")}},selectOption:function(t){if(this.optionListNode){if(this.selectedOption)this.selectedOption.setStyles(this.selectedOption.retrieve("originalStyle"));if(t)this.setSelectedOption(t)}},confirmValue:function(){if(this.optionListNode){if(this.selectedOption){var t=this.selectedOption.retrieve("data");var i=this.selectedOption.get("text");this.node.set("value",i);this.setInputWidth();this.bind.commitInput(t);this.selectedOption=null}else{this.bind.commitInput()}}else{this.bind.commitInput()}},setInputWidth:function(){if(this.node){var t=this.node.get("value");if(!this.tmpDivNode)this.tmpDivNode=new Element("div").set("style",this.node.get("style")).setStyles({display:"none",float:"left",width:"auto"}).inject(document.body);this.tmpDivNode.empty();t=t.replace(/\s/g,"&nbsp");this.tmpDivNode.set("html",t);var i=this.tmpDivNode.getComputedSize();var e=i.width-i.computedLeft-i.computedRight+5;var s=this.combox.node.getComputedSize();if(e<1)e=1;if(e>s.width)e=s.width;this.node.setStyle("width",""+e+"px");this.node.focus()}},setInputPosition:function(t){this.node.focus();if(t==="start"){this.node.setSelectionRange(0,0)}else{var i=this.node.get("value").length;this.node.setSelectionRange(i,i)}},setInputNodeStyles:function(){if(this.node){var t=this.combox.node.getStyles("font-family","min-height","font-size","font-weight","font-variant","font-style","line-height","color","text-align");if(!this.inputHeight){var i=this.combox.node.getComputedSize();this.inputHeight=""+i.height+"px";t.height=""+i.height+"px"}this.node.setStyles(t)}},destroy:function(){this.node.destroy();MWF.release(this)},searchItems:function(){this.hideOption=true;var t=this.node.get("value");if(t||this.combox.options.focusList){this.combox.getSelectList(t,function(t){if(this.hideOption){if(t.length){this.showOptionList(t)}else{this.hideOptionList()}}}.bind(this))}else{this.hideOptionList()}},createOptionListNode:function(){this.optionListNode=new Element("div",{styles:this.css.optionListNode});this.optionListNode.inject(this.node,"after");this.optionListNode.addEvents({mousedown:function(t){this.noBlur=true;t.preventDefault();t.stopPropagation()}.bind(this),mouseup:function(t){this.node.focus();this.noBlur=false}.bind(this)})},showOptionList:function(t){if(!this.optionListNode)this.createOptionListNode();this.optionListNode.setStyle("dispaly","block");this.optionListNode.empty();var e=this;var s=this.combox.node.getStyles("font-family","font-size","font-weight","font-variant","font-style","line-height","color","text-align");t.each(function(t){var i=new Element("div",{styles:this.css.optionNode,text:t.text}).inject(this.optionListNode);i.store("data",t.value);i.setStyles(s);i.addEvents({mousedown:function(){e.confirmValue()},mouseover:function(){e.selectOption(this)}})}.bind(this));var i=this.optionListNode.getFirst();if(i){var s=i.getStyles("background-color","background","color");i.store("originalStyle",s);i.setStyles(this.css.optionNode_selected);this.selectedOption=i}this.optionListNode.position({relativeTo:this.node,position:"leftBottom",edge:"leftTop",offset:{y:3}});if(layout.desktop.offices){Object.each(layout.desktop.offices,function(t){if(this.optionListNode.isOverlap(t.officeNode)){t.hide()}}.bind(this))}},hideOptionList:function(){if(this.optionListNode){this.optionListNode.destroy();this.optionListNode=null}this.hideOption=false;if(layout.desktop.offices){Object.each(layout.desktop.offices,function(t){if(layout.desktop.currentApp&&layout.desktop.currentApp.appId===t.form.app.appId){var i=t.officeNode.retrieve("officeDisplay");if(i)t.officeNode.setStyle("display",i)}})}}});