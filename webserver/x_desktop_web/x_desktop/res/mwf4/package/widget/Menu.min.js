MWF.widget=MWF.widget||{};MWF.widget.Menu=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",event:"contextmenu",disable:false,top:-1,left:-1,container:null},initialize:function(t,e){this.setOptions(e);this.items=[];this.path=MWF.defaultPath+"/widget/$Menu/";this.cssPath=MWF.defaultPath+"/widget/$Menu/"+this.options.style+"/css.wcss";this._loadCss();this.target=$(t);if(this.target)this.target.onselectstart=function(){return false};if(this.target)this.target.oncontextmenu=function(){return false};this.pauseCount=0},pause:function(t){this.pauseCount=t},load:function(){if(this.fireEvent("queryLoad")){this.node=new Element("div");this.node.set("styles",this.css.container);this.nodeFrame=new Element("iframe");this.nodeFrame.setStyles({border:"0px","z-index":"998",margin:"0px",padding:"0px",opacity:0});if(this.options.event){if(this.target)this.target.addEvent(this.options.event,this.showIm.bind(this))}this.nodeFrame.inject(this.options.container||$(document.body));this.node.inject(this.options.container||$(document.body));this.hide=this.hideMenu.bind(this);this.fireEvent("postLoad")}},setItemWidth:function(){this.items.each(function(t){var e=this.node.getStyle("padding-left").toInt();var i=this.node.getStyle("padding-right").toInt();var s=this.node.getStyle("border-left-width").toInt();var n=this.node.getStyle("border-right-width").toInt();var o=t.item.getStyle("border-left-width").toInt();var h=t.item.getStyle("border-right-width").toInt();var u=t.item.getStyle("margin-left").toInt()}.bind(this))},setPosition:function(t){var e;var i;if(this.options.top==-1){e=t.page.y}else{e=this.options.top}if(this.options.left==-1){i=t.page.x}else{i=this.options.left}var s=this.node.getSize();var n=$(document.body).getSize();if(i+s.x>n.x){i=i-s.x-5;if(i<0)i=0}var o=$(document.body).getScroll().y.toFloat()||0;if(e+s.y>n.y+o){e=e-s.y-5;if(e<0)e=0}this.node.setStyle("top",e);this.node.setStyle("left",i);var h=this.node.getSize();this.nodeFrame.setStyles({top:e,left:i,width:""+h.x+"px",height:""+h.y+"px"})},showIm:function(t){if(!this.options.disable){this.hide=this.hideIm.bind(this);if(this.fireEvent("queryShow",[t])){this.tmpBodyOncontextmenu=document.body.oncontextmenu;document.body.oncontextmenu=function(){return false};if(this.pauseCount<=0){this.setItemWidth();this.node.setStyles({display:"block",opacity:this.options.opacity||1});this.nodeFrame.setStyles({display:"block",opacity:0});this.setPosition(t);$(document.body).removeEvent("mousedown",this.hide);$(document.body).addEvent("mousedown",this.hide);this.show=true}else{this.pauseCount--}this.fireEvent("postShow")}}},hideIm:function(t){if(this.fireEvent("queryHide")){$(document.body).removeEvent("mousedown",this.hide);this.node.set("styles",{display:"none",opacity:0});this.nodeFrame.set("styles",{display:"none",opacity:0});this.show=false;document.body.oncontextmenu=this.tmpBodyOncontextmenu;this.tmpBodyOncontextmenu=null;if(t){var e=this;while(e.topMenu){e=e.topMenu}e.hideIm()}else{this.items.each(function(t){if(t.type=="menu"){t.subMenu.hideIm()}})}this.fireEvent("postHide")}},showMenu:function(t){if(!this.show){if(this.pauseCount<=0){if(!this.options.disable){this.hide=this.hideMenu.bind(this);if(this.fireEvent("queryShow",[t])){this.tmpBodyOncontextmenu=document.body.oncontextmenu;document.body.oncontextmenu=function(){return false};this.node.setStyle("display","block");this.nodeFrame.setStyle("display","block");this.setItemWidth();this.setPosition(t);if(!this.morph){this.morph=new Fx.Morph(this.node,{duration:100})}this.morph.start({opacity:this.options.opacity||1}).chain(function(){$(document).removeEvent("click",this.hide);$(document).addEvent("click",this.hide);$(document).removeEvent("mousedown",this.hide);$(document).addEvent("mousedown",this.hide);this.show=true;this.fireEvent("postShow")}.bind(this))}}}else{this.pauseCount--}}},hideMenu:function(){$(document).removeEvent("click",this.hide);if(this.show){if(!this.morph){this.morph=new Fx.Morph(this.node,{duration:100})}if(this.fireEvent("queryHide")){this.morph.start({opacity:0}).chain(function(){this.node.set("styles",{display:"none"});this.nodeFrame.set("styles",{display:"none"});this.show=false;document.body.oncontextmenu=this.tmpBodyOncontextmenu;this.tmpBodyOncontextmenu=null;this.fireEvent("postHide")}.bind(this))}}},clearItems:function(){this.items.each(function(t){t.remove()});this.items=[]},addMenuItem:function(t,e,i,s,n){var o=new MWF.widget.MenuItem(this,{text:t,event:e,action:i,img:s,disable:n});o.load();this.items.push(o);return o},addMenuMenu:function(t,e,i,s){var n=new MWF.widget.MenuMenu(this,i,{text:t,img:e,disable:s});n.load();this.items.push(n);return n},addMenuLine:function(){var t=new MWF.widget.MenuLine(this);t.load();this.items.push(t)},_loadToolbarItemNode:function(){var t=this.node.getChildren();t.each(function(t,e){var i=t.get("MWFnodetype");if(i){if(typeOf(this[i])=="array"){this[i].push(t)}else{this[i]=[];this[i].push(t)}}}.bind(this))},_loadMenuItems:function(){this._loadToolBarSeparator(this.MWFToolBarMenuItem);this._loadToolBarButton(this.MWFToolBarMenuLine);this._loadToolBarMenu(this.MWFToolBarMenuItem)},_loadToolBarSeparator:function(t){if(t){t.each(function(t,e){t.set("styles",this.css.toolbarSeparator)}.bind(this))}},_loadToolBarButton:function(t){if(t){t.each(function(t,e){var i=new MWF.widget.ToolbarButton(t,this);i.load();if(i.buttonID){this.items[i.buttonID]=i}this.children.push(i);this.childrenButton.push(i)}.bind(this))}},_loadToolBarMenu:function(t){if(t){t.each(function(t,e){var i=new MWF.widget.ToolbarMenu(t,this);i.load();if(i.buttonID){this.items[i.buttonID]=i}this.children.push(i);this.childrenMenu.push(i)}.bind(this))}}});MWF.widget.MenuItem=new Class({Implements:[Options],options:{text:"",event:"",action:null,img:"",disable:false},initialize:function(t,e){this.setOptions(e);this.menu=t;this.type="item";this.createNode()},createNode:function(){this.item=new Element("div",{styles:this.menu.css.menuItem});var t=new Element("div",{styles:this.menu.css.menuItemImgDiv}).inject(this.item);if(this.options.img){if(this.options.img.substr(0,3)=="url"){var e=new Element("div",{styles:this.menu.css.menuItemImg}).inject(t);e.setStyles({"background-size":"cover","background-image":this.options.img})}else{var e=new Element("img",{styles:this.menu.css.menuItemImg,src:this.options.img}).inject(t)}}var i=new Element("div",{styles:this.menu.css.menuItemSeparator}).inject(this.item);this.text=new Element("div",{styles:this.menu.css.menuItemText,text:this.options.text}).inject(this.item);if(this.options.event)this.item.addEvent(this.options.event,this.doAction.bind(this));this.setDisable(this.options.disable)},setText:function(t){this.options.text=t;var e=this.item.getLast("div");if(e)e.set("text",t)},load:function(){this.item.inject(this.menu.node);this._addButtonEvent()},setDisable:function(t){if(this.options.disable!=t){this.options.disable=t;if(t){this.item.set("styles",this.menu.css.menuItemDisable);var e=this.item.getElement("img");if(e){var i=e.get("src");if(i.substr(0,5)!="data:"){var s=i.lastIndexOf(".");srcLeft=i.substr(0,s);srcRight=i.substr(s,i.length-s);i=srcLeft+"_gray"+srcRight;e.set("src",i)}}}else{this.item.set("styles",this.menu.css.menuItem);var e=this.item.getElement("img");if(e){var i=e.get("src");if(i.substr(0,5)!="data:"){i=i.replace("_gray","");e.set("src",i)}}}}},_addButtonEvent:function(){this.item.addEvent("mouseover",this._menuItemMouseOver.bind(this));this.item.addEvent("mouseout",this._menuItemMouseOut.bind(this));this.item.addEvent("mousedown",this._menuItemMouseDown.bind(this));this.item.addEvent("mouseup",this._menuItemMouseUp.bind(this))},_menuItemMouseOver:function(e){this.menu.items.each(function(t){if(t!=this)if(t.type!="line")if(!t.options.disable){t._menuItemMouseOut(e)}}.bind(this));if(!this.options.disable){this.item.set("styles",this.menu.css.menuOver);this.menu.current=this}},_menuItemMouseOut:function(t){if(!this.options.disable){this.item.set("styles",this.menu.css.menuOut)}},_menuItemMouseDown:function(t){if(!this.options.disable){this.item.set("styles",this.menu.css.menuDown)}t.stopPropagation()},_menuItemMouseUp:function(t){if(!this.options.disable){this.item.set("styles",this.menu.css.menuUp)}},doAction:function(t){if(!this.options.disable){if(this.options.action){this.options.action.apply(this,[t])}this.menu.hideIm(true)}},remove:function(){this.item.destroy()}});MWF.widget.MenuLine=new Class({initialize:function(t,e){this.type="line";this.menu=t;this.createNode()},createNode:function(){this.item=new Element("div",{styles:this.menu.css.menuLine})},load:function(){this.item.inject(this.menu.node)},remove:function(){this.item.destroy()},setDisable:function(){}});MWF.widget.MenuMenu=new Class({Implements:[Options],Extends:MWF.widget.MenuItem,initialize:function(t,e,i){this.subMenu=e;this.parent(t,i);this.subMenu.topMenu=this.menu;this.type="menu";this.createIcon();this.subMenu.setPosition=function(){this.setPosition()}.bind(this)},createIcon:function(){var t=new Element("div",{styles:this.menu.css.menuItemSubmenuIcon});t.inject(this.text,"before");this.text.setStyle("margin-right","16px")},_menuItemMouseOver:function(e){this.menu.items.each(function(t){if(t!=this)if(t.type!="line")if(!t.options.disable){t._menuItemMouseOut(e)}}.bind(this));if(!this.options.disable){this.item.set("styles",this.menu.css.menuOver);this.menu.current=this}this.subMenu.showIm()},_menuItemMouseOut:function(t){if(t.event.toElement!=this.subMenu.node&&!this.subMenu.node.contains(t.event.toElement)){if(!this.options.disable){this.item.set("styles",this.menu.css.menuOut)}this.subMenu.hideIm()}},setPosition:function(t){var e;var i;var s=this.item.getPosition();var n=this.item.getSize();this.subMenu.node.setStyle("display","block");var o=this.subMenu.node.getSize();var h=$(document.body).getSize();e=s.y;i=s.x.toFloat()+n.x.toFloat()-3;if(i.toFloat()+o.x.toFloat()>h.x){i=s.x.toFloat()-o.x.toFloat()+8}var u=$(document.body).getScroll().y.toFloat()||0;if(e+o.y>h.y+u){e=e-o.y+n.y+3;if(e<0)e=0}if(this.subMenu.options.offsetX)i=i+this.subMenu.options.offsetX;if(this.subMenu.options.offsetY)e=e+this.subMenu.options.offsetY;var d=this.menu.node.getStyle("z-index");this.subMenu.node.setStyle("z-index",d+1);this.subMenu.node.setStyle("top",e);this.subMenu.node.setStyle("left",i)}});