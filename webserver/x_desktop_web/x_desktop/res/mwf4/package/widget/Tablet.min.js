MWF.widget=MWF.widget||{};MWF.widget.Tablet=MWF.Tablet=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",path:MWF.defaultPath+"/widget/$Tablet/",action:null,method:"",parameter:{},data:null,reference:"",referenceType:"",description:"",resultMaxSize:0,size:340},initialize:function(t,e){this.node=t;this.reset();this.setOptions(e);this.path=this.options.path||MWF.defaultPath+"/widget/$Tablet/";this.cssPath=this.path+this.options.style+"/css.wcss";this._loadCss();this.fireEvent("init")},load:function(){this.container=new Element("div.container",{styles:this.css.container}).inject(this.node);this.container.setStyles({width:this.options.size+"px",height:this.options.size+"px"});this.container.addEvent("selectstart",function(t){t.preventDefault();t.stopPropagation()});this.imageNode=new Element("img",{width:this.options.size,height:this.options.size}).inject(this.container);this.imageNode.setStyles({display:"none"});this.imageNode.ondragstart=function(){return false};if(this.checkBroswer()){this._load()}},_load:function(){this.canvas=new Element("canvas",{width:this.options.size,height:this.options.size}).inject(this.container);this.ctx=this.canvas.getContext("2d");this.canvas.onmousedown=function(t){var t=t||event;var e=this.ctx;var i=this.canvas;var n=this.container;var s=this.container.getPosition();var a=$(document);e.beginPath();e.moveTo(t.clientX-s.x,t.clientY-s.y);var o=function(t){e.lineTo(t.client.x-s.x,t.client.y-s.y);e.stroke()};a.addEvent("mousemove",o);var h=function(t){a.removeEvent("mousemove",o);a.removeEvent("mouseup",h);e.closePath()};a.addEvent("mouseup",h)}.bind(this)},reset:function(){this.fileName="untitled.png";this.fileType="image/png";if(this.ctx){var t=this.canvas;this.ctx.clearRect(0,0,t.clientWidth,t.clientHeight)}},uploadImage:function(e,t){var i=this.getImage();if(i){if(this.options.action){this.action=typeOf(this.options.action)=="string"?MWF.Actions.get(action).action:this.options.action;this.action.invoke({name:this.options.method,async:true,data:this.getFormData(i),file:i,parameter:this.options.parameter,success:function(t){e(t)}.bind(this)})}else{var n=this.options.resultMaxSize;MWF.xDesktop.uploadImageByScale(this.options.reference,this.options.referenceType,n,this.getFormData(i),i,e,t)}}else{}},getFormData:function(t){if(!t)t=this.getImage();var i=new FormData;i.append("file",t,this.fileName);if(this.options.data){Object.each(this.options.data,function(t,e){i.append(e,t)})}return i},getImage:function(){var t=this.getBase64Code();t=window.atob(t);var e=new Uint8Array(t.length);for(var i=0;i<t.length;i++){e[i]=t.charCodeAt(i)}return new Blob([e],{type:this.fileType})},getBase64Code:function(){var t=this.ctx;var e=this.canvas;var i=this.container;var n=this.options.size;t.drawImage(this.imageNode,0,0,n,n,0,0,n,n);var s=e.toDataURL(this.fileType);s=s.split(",")[1];if(!s){return""}else{return s}},getBase64Image:function(){var t=this.getBase64Code();if(!t)return null;return"data:"+this.fileType+";base64,"+t},close:function(){this.container.destroy();delete this},checkBroswer:function(){if(window.Uint8Array&&window.HTMLCanvasElement&&window.atob&&window.Blob){this.available=true;return true}else{this.available=false;this.container.set("html","<p>您的浏览器不支持以下特性:</p><ul><li>canvas</li><li>Blob</li><li>Uint8Array</li><li>FormData</li><li>atob</li></ul>");return false}}});