MWF.widget=MWF.widget||{};MWF.widget.Upload=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{data:null,parameter:null,action:null,method:"",style:"default"},initialize:function(e,t){this.setOptions(t);this.path=MWF.defaultPath+"/widget/$Upload/";this.cssPath=MWF.defaultPath+"/widget/$Upload/"+this.options.style+"/css.wcss";this._loadCss();this.container=$(e);this.action=typeOf(this.options.action)=="string"?MWF.Actions.get(action).action:this.options.action},load:function(){if(FormData.expiredIE){this.doUpload_InputFile()}else{this.doUpload_FormData()}},doUpload_FormData:function(){this.formData_CreateUploadArea();this.fileUploadNode.click()},formData_CreateUploadArea:function(){if(!this.uploadFileAreaNode){this.uploadFileAreaNode=new Element("div");var e='<input name="file" multiple type="file" accept="*/*"/>';this.uploadFileAreaNode.set("html",e);this.fileUploadNode=this.uploadFileAreaNode.getFirst();this.fileUploadNode.addEvent("change",this.formData_Upload.bind(this))}},formData_Upload:function(){var e=this.fileUploadNode.files;if(e.length){var t=e.length;var i=0;this.isContinue=true;this.fireEvent("beforeUpload",[e]);var a=function(e){if(i==t)this.fireEvent("completed",[e])}.bind(this);if(this.isContinue){for(var s=0;s<e.length;s++){var o=e.item(s);var n=new FormData;Object.each(this.options.data,function(e,t){n.append(t,e)});n.append("file",o);this.action.invoke({name:this.options.method,async:true,data:n,file:o,parameter:this.options.parameter,success:function(e){i++;this.fireEvent("every",[e,i,t,o]);a(e)}.bind(this)})}}this.uploadFileAreaNode.destroy();this.uploadFileAreaNode=null}},inputFile_CreateMaskNode:function(){this.container.mask({style:{opacity:.7,"background-color":"#999"}})},addUploadMessage:function(e){var t="";t='<div style="overflow: hidden"><div style="height: 2px; border:0px solid #999; margin: 3px 0px">'+'<div style="height: 2px; background-color: #acdab9; width: 0px;"></div></div>'+'<div style="height: 20px; line-height: 20px">'+MWF.LP.desktop.action.uploadTitle+"</div></div>"+"<iframe name='o2_upload_iframe' style='display:none'></iframe>";var i={subject:MWF.LP.desktop.action.uploadTitle,content:e+"<br/>"+t};if(layout.desktop.message){var a=layout.desktop.message.addMessage(i);a.close=function(e,t){if(!a.completed){}else{a.closeItem(e,t)}}}window.setTimeout(function(){if(layout.desktop.message)if(!layout.desktop.message.isShow)layout.desktop.message.show()}.bind(this),300);return a},setMessageTitle:function(e,t){if(e)e.subjectNode.set("text",t)},setMessageText:function(e,t){if(e){var i=e.contentNode.getFirst("div").getFirst("div");var a=i.getFirst("div");var s=e.contentNode.getFirst("div").getLast("div");s.set("text",t);e.dateNode.set("text",(new Date).format("db"))}},inputFile_CreateInputNode:function(e){this.inputUploadAreaNode=new Element("div",{styles:this.css.inputUploadAreaNode}).inject(this.container);this.inputUploadAreaNode.position({relativeTo:this.container,position:"center"});debugger;var t=new Element("form",{method:"POST",action:e+"/callback/window.frameElement.ownerDocument.O2UploadCallbackFun",enctype:"multipart/form-data",target:"o2_upload_iframe"}).inject(this.inputUploadAreaNode);var i=new Element("div",{styles:this.css.inputUploadAreaTitleNode,text:MWF.LP.widget.uploadTitle}).inject(t);var a=new Element("div",{styles:this.css.inputUploadAreaInforNode,text:MWF.LP.widget.uploadInfor}).inject(t);var s=new Element("div",{styles:this.css.inputUploadAreaInputAreaNode}).inject(t);var o=new Element("input",{name:"file",type:"file",styles:this.css.inputUploadAreaInputNode}).inject(s);var n=new Element("input",{type:"hidden",name:"fileName"}).inject(s);Object.each(this.options.data,function(e,t){new Element("input",{type:"hidden",name:t,value:e}).inject(s)});var d=new Element("div",{styles:this.css.inputUploadActionNode}).inject(t);var l=new Element("button",{styles:this.css.inputUploadCancelButton,text:MWF.LP.widget.cancel}).inject(d);var p=new Element("input",{type:"button",styles:this.css.inputUploadOkButton,value:MWF.LP.widget.ok}).inject(d);o.addEvent("change",function(){var e=o.get("value");if(e){var t=e.replace(/\\/g,"/");var i=t.lastIndexOf("/");var a=i===-1?t:t.substr(i+1,t.length-i);n.set("value",a)}}.bind(this));l.addEvent("click",function(){this.container.unmask();this.inputUploadAreaNode.destroy()}.bind(this));p.addEvent("click",function(){t.mask({style:{opacity:.7,"background-color":"#999"}});this.isContinue=true;this.fireEvent("beforeUpload",[n.get("value")]);if(this.isContinue){this.messageItem=this.addUploadMessage(n.get("value"));t.submit();this.container.unmask();if(this.inputUploadAreaNode)this.inputUploadAreaNode.destroy()}}.bind(this))},inputFile_UploadCallback:function(e){var t=JSON.decode(e);this.messageItem.completed=true;if(t.type==="success"){this.setMessageTitle(this.messageItem,MWF.LP.desktop.action.uploadComplete);this.setMessageText(this.messageItem,MWF.LP.desktop.action.uploadComplete);this.fireEvent("every",[t]);this.fireEvent("completed",[t])}else{this.setMessageTitle(this.messageItem,MWF.LP.desktop.action.sendError);this.setMessageText(this.messageItem,MWF.LP.desktop.action.sendError+": "+t.message);MWF.xDesktop.notice("error",{x:"right",y:"top"},t.message)}},doUpload_InputFile:function(){this.action.getActions(function(){var i=this.action.actions[this.options.method];i=this.action.address+i.uri;Object.each(this.options.parameter,function(e,t){i=i.replace("{"+t+"}",e)});this.messageItem=null;document.O2UploadCallbackFun=this.inputFile_UploadCallback.bind(this);this.inputFile_CreateInputNode(i)}.bind(this))}});