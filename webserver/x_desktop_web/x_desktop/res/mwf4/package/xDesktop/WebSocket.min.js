MWF.xDesktop=MWF.xDesktop||{};MWF.xApplication=MWF.xApplication||{};MWF.require("MWF.xDesktop.Actions.RestActions",null,false);MWF.xDesktop.WebSocket=new Class({Implements:[Options,Events],options:{},initialize:function(e){var t=layout.desktop.serviceAddressList["x_collaboration_assemble_websocket"];this.ws="ws://"+t.host+(t.port==80?"":":"+t.port)+t.context+"/ws/collaboration";this.ws=this.ws+"?x-token="+encodeURIComponent(Cookie.read("x-token"));this.webSocket=new WebSocket(this.ws);this.webSocket.onopen=function(e){this.onOpen(e)}.bind(this);this.webSocket.onclose=function(e){this.onClose(e)}.bind(this);this.webSocket.onmessage=function(e){this.onMessage(e)}.bind(this);this.webSocket.onerror=function(e){this.onError(e)}.bind(this)},onOpen:function(e){},onClose:function(e){},onMessage:function(e){if(e.data){try{debugger;var t=JSON.decode(e.data);switch(t.category){case"dialog":switch(t.type){case"text":this.receiveChatMessage(t);break;default:}break;default:switch(t.type){case"task":this.receiveTaskMessage(t);break;case"read":this.receiveReadMessage(t);break;case"review":this.receiveReviewMessage(t);break;case"fileEditor":this.receiveFileEditorMessage(t);break;case"fileShare":this.receiveFileShareMessage(t);break;case"meetingInvite":this.receiveMeetingInviteMessage(t);break;case"meetingCancel":this.receiveMeetingCancelMessage(t);break;case"meetingAccept":this.receiveMeetingAcceptMessage(t);break;case"meetingReject":this.receiveMeetingRejectMessage(t);break;case"attendanceAppealInvite":this.receiveAttendanceAppealInviteMessage(t);break;case"attendanceAppealAccept":this.receiveAttendanceAppealAcceptMessage(t);break;case"attendanceAppealReject":this.receiveAttendanceAppealRejectMessage(t);break;default:}}}catch(e){}}},onError:function(e){},close:function(){this.webSocket.close()},send:function(t){if(!this.webSocket||this.webSocket.readyState!=1){this.initialize()}try{this.webSocket.send(JSON.encode(t))}catch(e){this.initialize();this.webSocket.send(JSON.encode(t))}},receiveChatMessage:function(e){if(layout.desktop.widgets["IMIMWidget"])layout.desktop.widgets["IMIMWidget"].receiveChatMessage(e)},receiveTaskMessage:function(e){var t=new MWF.xDesktop.Actions.RestActions("/res/mwf4/package/xDesktop/Actions/action.json","x_processplatform_assemble_surface","x_desktop");t.invoke({name:"getTask",parameter:{id:e.task},success:function(e){var t=e.data;var s=MWF.LP.desktop.messsage.receiveTask+"《"+t.title+"》, "+MWF.LP.desktop.messsage.activity+": <font style='color: #ea621f'>"+(t.activityName||"")+"</font>";s+="<br/><font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.appliction+": </font><font style='color: #ea621f'>"+t.applicationName+"</font>;  "+"<font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.process+": </font><font style='color: #ea621f'>"+t.processName+"</font>";var a={subject:MWF.LP.desktop.messsage.taskMessage,content:s};var o=layout.desktop.message.addMessage(a);var n=layout.desktop.message.addTooltip(a);n.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"process.TaskCenter",null,{status:{navi:"task"}})});o.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"process.TaskCenter",null,{status:{navi:"task"}})})}.bind(this),failure:function(){}})},receiveReadMessage:function(e){var t=new MWF.xDesktop.Actions.RestActions("/res/mwf4/package/xDesktop/Actions/action.json","x_processplatform_assemble_surface","x_desktop");t.invoke({name:"getRead",parameter:{id:e.read},success:function(e){var t=e.data;var s=MWF.LP.desktop.messsage.receiveRead+"《"+t.title+"》. ";s+="<br/><font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.appliction+": </font><font style='color: #ea621f'>"+t.applicationName+"</font>;  "+"<font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.process+": </font><font style='color: #ea621f'>"+t.processName+"</font>";var a={subject:MWF.LP.desktop.messsage.readMessage,content:s};var o=layout.desktop.message.addMessage(a);var n=layout.desktop.message.addTooltip(a);n.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"process.TaskCenter",null,{status:{navi:"read"}})});o.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"process.TaskCenter",null,{status:{navi:"read"}})})}.bind(this),failure:function(){}})},receiveReviewMessage:function(e){var t=MWF.LP.desktop.messsage.receiveReview+"《"+e.title+"》. ";t+="<br/><font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.appliction+": </font><font style='color: #ea621f'>"+e.applicationName+"</font>;  "+"<font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.process+": </font><font style='color: #ea621f'>"+e.processName+"</font>";var s={subject:MWF.LP.desktop.messsage.reviewMessage,content:t};var a=layout.desktop.message.addMessage(s);var o=layout.desktop.message.addTooltip(s);o.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"process.TaskCenter",null,{status:{navi:"review"}})});a.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"process.TaskCenter",null,{status:{navi:"review"}})})},receiveFileEditorMessage:function(t){var e="<font style='color: #ea621f; font-weight: bold'>"+t.person+"</font> "+MWF.LP.desktop.messsage.receiveFileEditor+"“"+t.name+"”. ";var s={subject:MWF.LP.desktop.messsage.fileEditorMessage,content:e};var a=layout.desktop.message.addMessage(s);var o=layout.desktop.message.addTooltip(s);o.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"File",null,{status:{tab:"editor",node:t.person}})});a.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"File",null,{status:{tab:"editor",node:t.person}})})},receiveFileShareMessage:function(t){var e="<font style='color: #ea621f; font-weight: bold'>"+t.person+"</font> "+MWF.LP.desktop.messsage.receiveFileShare+"“"+t.name+"”. ";var s={subject:MWF.LP.desktop.messsage.fileShareMessage,content:e};var a=layout.desktop.message.addMessage(s);var o=layout.desktop.message.addTooltip(s);o.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"File",null,{status:{tab:"share",node:t.person}})});a.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"File",null,{status:{tab:"share",node:t.person}})})},getMeeting:function(e,s){MWF.Actions.get("x_meeting_assemble_control").getMeeting(e,function(e){var t=e.data;MWF.Actions.get("x_meeting_assemble_control").getRoom(t.room,function(e){t.roomName=e.data.name;MWF.Actions.get("x_meeting_assemble_control").getBuilding(e.data.building,function(e){t.buildingName=e.data.name;if(s)s(t)}.bind(this))}.bind(this))}.bind(this))},receiveMeetingInviteMessage:function(e){this.getMeeting(e.meeting,function(e){var t=MWF.LP.desktop.messsage.meetingInvite;t=t.replace(/{person}/g,MWF.name.cn(e.applicant));var s=Date.parse(e.startTime).format("%Y-%m-%d- %H:%M");t=t.replace(/{date}/g,s);t=t.replace(/{subject}/g,e.subject);t=t.replace(/{addr}/g,e.roomName+"("+e.buildingName+")");var a={subject:MWF.LP.desktop.messsage.meetingInviteMessage,content:t};var o=layout.desktop.message.addMessage(a);var n=layout.desktop.message.addTooltip(a);n.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"Meeting",null)});o.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"Meeting",null)})}.bind(this))},receiveMeetingCancelMessage:function(e){this.getMeeting(e.meeting,function(e){var t=MWF.LP.desktop.messsage.meetingCancel;t=t.replace(/{person}/g,MWF.name.cn(e.applicant));var s=Date.parse(e.startTime).format("%Y-%m-%d- %H:%M");t=t.replace(/{date}/g,s);t=t.replace(/{subject}/g,e.subject);t=t.replace(/{addr}/g,e.roomName+"("+e.buildingName+")");var a={subject:MWF.LP.desktop.messsage.meetingCancelMessage,content:t};var o=layout.desktop.message.addMessage(a);var n=layout.desktop.message.addTooltip(a);n.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"Meeting",null)});o.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"Meeting",null)})}.bind(this))},receiveMeetingAcceptMessage:function(i){this.getMeeting(i.meeting,function(e){var t=MWF.LP.desktop.messsage.meetingAccept;t=t.replace(/{person}/g,MWF.name.cn(i.person));var s=Date.parse(e.startTime).format("%Y-%m-%d- %H:%M");t=t.replace(/{date}/g,s);t=t.replace(/{subject}/g,e.subject);t=t.replace(/{addr}/g,e.roomName+"("+e.buildingName+")");var a={subject:MWF.LP.desktop.messsage.meetingAcceptMessage,content:t};var o=layout.desktop.message.addMessage(a);var n=layout.desktop.message.addTooltip(a);n.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"Meeting",null)});o.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"Meeting",null)})}.bind(this))},receiveMeetingRejectMessage:function(i){this.getMeeting(i.meeting,function(e){var t=MWF.LP.desktop.messsage.meetingReject;t=t.replace(/{person}/g,MWF.name.cn(i.person));var s=Date.parse(e.startTime).format("%Y-%m-%d- %H:%M");t=t.replace(/{date}/g,s);t=t.replace(/{subject}/g,e.subject);t=t.replace(/{addr}/g,e.roomName+"("+e.buildingName+")");var a={subject:MWF.LP.desktop.messsage.meetingRejectMessage,content:t};var o=layout.desktop.message.addMessage(a);var n=layout.desktop.message.addTooltip(a);n.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"Meeting",null)});o.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"Meeting",null)})}.bind(this))},receiveAttendanceAppealInviteMessage:function(e){var t=MWF.LP.desktop.messsage.attendanceAppealInvite;t=t.replace(/{subject}/g,e.subject);var s={subject:MWF.LP.desktop.messsage.attendanceAppealInviteMessage,content:t};var a=layout.desktop.message.addMessage(s);var o=layout.desktop.message.addTooltip(s);o.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"Attendance",{curNaviId:"13"})});a.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"Attendance",{curNaviId:"13"})})},receiveAttendanceAppealAcceptMessage:function(e){var t=MWF.LP.desktop.messsage.attendanceAppealAccept;t=t.replace(/{subject}/g,e.subject);var s={subject:MWF.LP.desktop.messsage.attendanceAppealAcceptMessage,content:t};var a=layout.desktop.message.addMessage(s);var o=layout.desktop.message.addTooltip(s);o.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"Attendance",{curNaviId:"12"})});a.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"Attendance",{curNaviId:"12"})})},receiveAttendanceAppealRejectMessage:function(e){var t=MWF.LP.desktop.messsage.attendanceAppealReject;t=t.replace(/{subject}/g,e.subject);var s={subject:MWF.LP.desktop.messsage.attendanceAppealRejectMessage,content:t};var a=layout.desktop.message.addMessage(s);var o=layout.desktop.message.addTooltip(s);o.contentNode.addEvent("click",function(e){layout.desktop.message.hide();layout.desktop.openApplication(e,"Attendance",{curNaviId:"12"})});a.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1);layout.desktop.message.hide();layout.desktop.openApplication(e,"Attendance",{curNaviId:"12"})})}});